<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Procedure Suite - Clinical Dashboard</title>
    <link rel="stylesheet" href="./styles.css" />

    <!-- Monaco Editor (AMD loader) -->
    <script
      src="https://cdn.jsdelivr.net/npm/monaco-editor@0.45.0/min/vs/loader.js"
      crossorigin="anonymous"
    ></script>
    <script>
      window.__monacoReady = new Promise((resolve, reject) => {
        try {
          require.config({
            paths: {
              vs: "https://cdn.jsdelivr.net/npm/monaco-editor@0.45.0/min/vs",
            },
            onNodeCreated: function (node) {
              node.crossOrigin = "anonymous";
            },
          });
          require(["vs/editor/editor.main"], () => resolve(), reject);
        } catch (e) {
          reject(e);
        }
      });
      window.__monacoReady.catch((e) => {
        const el = document.getElementById("statusText");
        if (el) el.textContent = `Monaco failed to load: ${e?.message || e}`;
      });
    </script>
    <script type="module" src="./app.js"></script>
  </head>
  <body>
    <header class="topbar">
      <div class="title">
        <div class="h1">Procedure Suite - Clinical Dashboard</div>
        <div class="subtle">
          Client-side PHI detection. Scrub notes before submission.
        </div>
      </div>
      <div class="topbar-links">
        <a class="topbar-link" href="./workflow.html">Workflow</a>
      </div>
      <div class="status">
        <span id="statusText">Loading...</span>
        <span id="progressText" class="progress"></span>
      </div>
    </header>

    <main class="layout">
      <section class="editorPane">
        <!-- Section 1: De-identify Note -->
        <div class="section-header">
          <div class="section-title">
            <span class="section-number">1</span>
            De-identify Note
          </div>
        </div>

        <div class="controls">
          <button id="runBtn">Run Detection</button>
          <button id="cancelBtn" class="secondary" disabled>Cancel</button>
          <div class="spacer"></div>
          <button id="applyBtn" class="primary" disabled>Apply Redactions</button>
          <button id="revertBtn" class="secondary" disabled>Revert</button>
          <button id="submitBtn" class="success" disabled>Submit Scrubbed Note</button>

          <!-- Manual Redaction Controls -->
          <div class="manual-redaction-group">
            <label class="manual-label">Manual:</label>
            <select id="entityTypeSelect" class="param-select">
              <option value="PATIENT">Patient Name</option>
              <option value="ID">MRN / ID</option>
              <option value="DATE">Date</option>
              <option value="PHONE">Phone</option>
              <option value="GEO">Location</option>
              <option value="OTHER">Other</option>
            </select>
            <button id="addRedactionBtn" class="secondary" disabled>Add</button>
          </div>
        </div>

        <div class="warning">
          <strong>PHI Policy:</strong> This page runs detection locally in your browser.
          Apply redactions before submitting. The server receives only scrubbed text.
        </div>

        <div id="editor" class="editor">
          <textarea
            id="fallbackTextarea"
            class="fallback-textarea"
            placeholder="Paste a procedure note here…"
            spellcheck="false"
          ></textarea>
        </div>

        <!-- Section 2: Clinical Review -->
        <div class="result">
          <div class="resultHeader">
            <div class="section-title">
              <span class="section-number">2</span>
              Clinical Review
            </div>
            <button id="exportBtn" class="secondary" disabled>Export Changes</button>
          </div>
	          <div id="resultsContainer" class="resultsContainer hidden">
	            <div id="statusBannerHost"></div>
	            <div id="statCards" class="stat-card-container">
	            </div>

	            <div class="dash-grid">
	              <div class="dash-col">
	                <div class="dash-card">
	                  <div class="dash-card-header">
	                    <div class="section-title">
	                      <span class="section-number">1</span>
	                      CPT Codes – Derived (Selected)
	                    </div>
	                  </div>
	                  <div class="dash-card-body">
	                    <table class="dash-table">
	                      <thead>
	                        <tr>
	                          <th width="12%">CPT Code</th>
	                          <th width="58%">Description & Rationale</th>
	                          <th width="10%">Units</th>
	                          <th width="20%">Role</th>
	                        </tr>
	                      </thead>
	                      <tbody id="billingSelectedBody"></tbody>
	                    </table>
	                  </div>
	                </div>

	                <div class="dash-card">
	                  <div class="dash-card-header">
	                    <div class="section-title">
	                      <span class="section-number">2</span>
	                      CPT Codes – Dropped / Suppressed
	                    </div>
	                  </div>
	                  <div class="dash-card-body">
	                    <table class="dash-table">
	                      <thead>
	                        <tr>
	                          <th width="12%">CPT Code</th>
	                          <th width="18%">Status</th>
	                          <th width="70%">Reason / Logic</th>
	                        </tr>
	                      </thead>
	                      <tbody id="billingSuppressedBody"></tbody>
	                    </table>
	                  </div>
	                </div>

	                <div class="dash-card">
	                  <div class="dash-card-header">
	                    <div class="section-title">
	                      <span class="section-number">3</span>
	                      Coding Logic &amp; Rationale (Per Code)
	                    </div>
	                  </div>
	                  <div class="dash-card-body">
	                    <table class="dash-table">
	                      <thead>
	                        <tr>
	                          <th width="12%">CPT Code</th>
	                          <th width="48%">Selection Logic</th>
	                          <th width="40%">Supporting Documentation Evidence</th>
	                        </tr>
	                      </thead>
	                      <tbody id="codingRationaleBody"></tbody>
	                    </table>
	                  </div>
	                </div>

	                <div class="dash-card">
	                  <div class="dash-card-header">
	                    <div class="section-title">
	                      <span class="section-number">4</span>
	                      Rules Applied (Bundling &amp; Policy)
	                    </div>
	                  </div>
	                  <div class="dash-card-body">
	                    <table class="dash-table">
	                      <thead>
	                        <tr>
	                          <th width="20%">Rule Type</th>
	                          <th width="20%">Codes Affected</th>
	                          <th width="15%">Outcome</th>
	                          <th width="45%">Details</th>
	                        </tr>
	                      </thead>
	                      <tbody id="rulesAppliedBody"></tbody>
	                    </table>
	                  </div>
	                </div>

	                <div class="dash-card">
	                  <div class="dash-card-header">
	                    <div class="section-title">
	                      <span class="section-number">5</span>
	                      Financial Summary
	                    </div>
	                  </div>
	                  <div class="dash-card-body">
	                    <div class="dash-metrics">
	                      <div class="dash-metric">
	                        <div class="dash-metric-label">Total work RVU</div>
	                        <div class="dash-metric-value" id="financialTotalRVU">—</div>
	                      </div>
	                      <div class="dash-metric">
	                        <div class="dash-metric-label">Estimated payment</div>
	                        <div class="dash-metric-value" id="financialTotalPayment">—</div>
	                      </div>
	                    </div>
	                    <table class="dash-table">
	                      <thead>
	                        <tr>
	                          <th width="12%">CPT</th>
	                          <th width="10%">Units</th>
	                          <th width="18%">Work RVU</th>
	                          <th width="20%">Facility RVU</th>
	                          <th width="20%">Payment</th>
	                          <th width="20%">Notes</th>
	                        </tr>
	                      </thead>
	                      <tbody id="financialSummaryBody"></tbody>
	                    </table>
	                  </div>
	                </div>

	                <div class="dash-card">
	                  <div class="dash-card-header">
	                    <div class="section-title">
	                      <span class="section-number">6</span>
	                      Audit &amp; Quality Flags (Condensed)
	                    </div>
	                  </div>
	                  <div class="dash-card-body">
	                    <table class="dash-table">
	                      <thead>
	                        <tr>
	                          <th width="30%">Category</th>
	                          <th width="70%">Notes</th>
	                        </tr>
	                      </thead>
	                      <tbody id="auditFlagsBody"></tbody>
	                    </table>
	                    <details class="dash-details">
	                      <summary>Pipeline metadata</summary>
	                      <table class="dash-table kv-table">
	                        <tbody id="pipelineMetadataBody"></tbody>
	                      </table>
	                    </details>
	                  </div>
	                </div>
	              </div>

	              <div class="dash-col">
	                <div class="dash-card">
	                  <div class="dash-card-header">
	                    <div class="section-title">
	                      <span class="section-number">7</span>
	                      Patient &amp; Clinical Context
	                    </div>
	                  </div>
	                  <div class="dash-card-body">
	                    <table class="dash-table kv-table">
	                      <tbody id="clinicalContextBody"></tbody>
	                    </table>
	                  </div>
	                </div>

	                <div class="dash-card">
	                  <div class="dash-card-header">
	                    <div class="section-title">
	                      <span class="section-number">8</span>
	                      Procedures Performed (Summary)
	                    </div>
	                  </div>
	                  <div class="dash-card-body">
	                    <table class="dash-table">
	                      <thead>
	                        <tr>
	                          <th width="35%">Procedure</th>
	                          <th width="15%">Performed</th>
	                          <th width="50%">Key Details</th>
	                        </tr>
	                      </thead>
	                      <tbody id="proceduresSummaryBody"></tbody>
	                    </table>
	                  </div>
	                </div>

	                <div class="dash-card" id="diagnosticFindingsCard">
	                  <div class="dash-card-header">
	                    <div class="section-title">
	                      <span class="section-number">9</span>
	                      Diagnostic Bronchoscopy Findings
	                    </div>
	                  </div>
	                  <div class="dash-card-body">
	                    <table class="dash-table kv-table">
	                      <tbody id="diagnosticFindingsBody"></tbody>
	                    </table>
	                  </div>
	                </div>

	                <div class="dash-card" id="balDetailsCard">
	                  <div class="dash-card-header">
	                    <div class="section-title">
	                      <span class="section-number">10</span>
	                      BAL Details
	                    </div>
	                  </div>
	                  <div class="dash-card-body">
	                    <table class="dash-table kv-table">
	                      <tbody id="balDetailsBody"></tbody>
	                    </table>
	                  </div>
	                </div>

	                <div class="dash-card" id="linearEbusSummaryCard">
	                  <div class="dash-card-header">
	                    <div class="section-title">
	                      <span class="section-number">11</span>
	                      Linear EBUS Technical Summary
	                    </div>
	                  </div>
	                  <div class="dash-card-body">
	                    <table class="dash-table kv-table">
	                      <tbody id="linearEbusSummaryBody"></tbody>
	                    </table>
	                  </div>
	                </div>

	                <div class="dash-card" id="ebusNodeEventsCard">
	                  <div class="dash-card-header">
	                    <div class="section-title">
	                      <span class="section-number">12</span>
	                      Linear EBUS Node Events (Granular)
	                    </div>
	                  </div>
	                  <div class="dash-card-body">
	                    <table class="dash-table">
	                      <thead>
	                        <tr>
	                          <th width="12%">Station</th>
	                          <th width="36%">Action</th>
	                          <th width="10%">Passes</th>
	                          <th width="20%">Elastography</th>
	                          <th width="22%">Evidence</th>
	                        </tr>
	                      </thead>
	                      <tbody id="ebusNodeEventsBody"></tbody>
	                    </table>
	                  </div>
	                </div>
	              </div>
	            </div>

	            <details class="raw-json-toggle">
	              <summary>Evidence Traceability</summary>
	              <div id="evidenceTraceabilityHost"></div>
	            </details>

	            <div class="debug-section no-print">
	              <details class="debug-details">
	                <summary>System Logic & Debugging Logs</summary>
	                <div id="systemLogs" class="log-box">
                </div>
              </details>
            </div>

            <details class="raw-json-toggle">
              <summary>View Raw JSON</summary>
              <pre id="serverResponse">(none)</pre>
            </details>
          </div>
        </div>
      </section>

      <aside class="sidePane">
        <div class="sideHeader">
          <div class="sideTitle">Detections</div>
          <div class="sideMeta">
            <span id="detectionsCount">0</span>
            <span class="subtle">items</span>
          </div>
        </div>
        <div id="detectionsList" class="detectionsList"></div>
        <div class="sideFooter">
          Uncheck items to exclude from redaction.
        </div>
      </aside>
    </main>
  </body>
</html>
