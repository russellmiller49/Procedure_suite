<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Procedure Suite - Clinical Dashboard</title>
    <link rel="stylesheet" href="./styles.css" />

    <!-- Monaco Editor (AMD loader) -->
    <script
      src="https://cdn.jsdelivr.net/npm/monaco-editor@0.45.0/min/vs/loader.js"
      crossorigin="anonymous"
    ></script>
    <script>
      window.__monacoReady = new Promise((resolve, reject) => {
        try {
          require.config({
            paths: {
              vs: "https://cdn.jsdelivr.net/npm/monaco-editor@0.45.0/min/vs",
            },
            onNodeCreated: function (node) {
              node.crossOrigin = "anonymous";
            },
          });
          require(["vs/editor/editor.main"], () => resolve(), reject);
        } catch (e) {
          reject(e);
        }
      });
      window.__monacoReady.catch((e) => {
        const el = document.getElementById("statusText");
        if (el) el.textContent = `Monaco failed to load: ${e?.message || e}`;
      });
    </script>
    <script type="module" src="./app.js"></script>
  </head>
  <body>
    <header class="topbar">
      <div class="title">
        <div class="h1">Procedure Suite - Clinical Dashboard</div>
        <div class="subtle">
          Client-side PHI detection. Scrub notes before submission.
        </div>
      </div>
      <div class="topbar-links">
        <a class="topbar-link" href="./workflow.html">Workflow</a>
      </div>
      <div class="status">
        <span id="statusText">Loading...</span>
        <span id="progressText" class="progress"></span>
      </div>
    </header>

    <main class="layout">
      <section class="editorPane">
        <!-- Section 1: De-identify Note -->
        <div class="section-header">
          <div class="section-title">
            <span class="section-number">1</span>
            De-identify Note
          </div>
        </div>

        <div class="controls">
          <button id="runBtn">Run Detection</button>
          <button id="cancelBtn" class="secondary" disabled>Cancel</button>
          <div class="spacer"></div>
          <button id="applyBtn" class="primary" disabled>Apply Redactions</button>
          <button id="revertBtn" class="secondary" disabled>Revert</button>
          <button id="submitBtn" class="success" disabled>Submit Scrubbed Note</button>

          <!-- Manual Redaction Controls -->
          <div class="manual-redaction-group">
            <label class="manual-label">Manual:</label>
            <select id="entityTypeSelect" class="param-select">
              <option value="PATIENT">Patient Name</option>
              <option value="ID">MRN / ID</option>
              <option value="DATE">Date</option>
              <option value="PHONE">Phone</option>
              <option value="GEO">Location</option>
              <option value="OTHER">Other</option>
            </select>
            <button id="addRedactionBtn" class="secondary" disabled>Add</button>
          </div>
        </div>

        <div class="warning">
          <strong>PHI Policy:</strong> This page runs detection locally in your browser.
          Apply redactions before submitting. The server receives only scrubbed text.
        </div>

        <div id="editor" class="editor"></div>

        <!-- Section 2: Clinical Review -->
        <div class="result">
          <div class="resultHeader">
            <div class="section-title">
              <span class="section-number">2</span>
              Clinical Review
            </div>
            <button id="exportBtn" class="secondary" disabled>Export Changes</button>
          </div>
          <div id="resultsContainer" class="resultsContainer">
            <!-- Status banner -->
            <div id="statusBanner" class="status-banner hidden"></div>

            <!-- CPT Codes Table -->
            <div id="cptSection" class="result-section hidden">
              <h3>CPT Codes</h3>
              <table class="result-table">
                <thead>
                  <tr>
                    <th>Code</th>
                    <th>Description</th>
                    <th>Confidence</th>
                    <th>RVU</th>
                    <th>Payment</th>
                  </tr>
                </thead>
                <tbody id="cptTableBody"></tbody>
              </table>
            </div>

            <!-- Registry Data (Editable) -->
            <div id="registrySection" class="result-section hidden">
              <h3>Registry Data</h3>
              <div id="registryForm"></div>
            </div>

            <!-- Raw JSON toggle -->
            <details class="raw-json-toggle">
              <summary>View Raw JSON</summary>
              <pre id="serverResponse">(none)</pre>
            </details>
          </div>
        </div>
      </section>

      <aside class="sidePane">
        <div class="sideHeader">
          <div class="sideTitle">Detections</div>
          <div class="sideMeta">
            <span id="detectionsCount">0</span>
            <span class="subtle">items</span>
          </div>
        </div>
        <div id="detectionsList" class="detectionsList"></div>
        <div class="sideFooter">
          Uncheck items to exclude from redaction.
        </div>
      </aside>
    </main>
  </body>
</html>
