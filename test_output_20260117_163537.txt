source ~/miniconda3/etc/profile.d/conda.sh && conda activate medparse-py311 && pytest
..FF..FF.F......................F..FFFFFF.F...F......................... [  5%]
........................................................................ [ 10%]
........................................................................ [ 15%]
....................................................................FFFF [ 20%]
FFF.FFFFFF...........................FFF.F.FFF..F..FFF...........F...... [ 25%]
sssssssss.................sssssssssssss................................. [ 31%]
........................................................................ [ 36%]
........................................................................ [ 41%]
........................................................................ [ 46%]
........................................................................ [ 51%]
.............FF....................................................F.... [ 57%]
.......................F................................................ [ 62%]
.......FF............................................................... [ 67%]
...............................FFFFFFFFFFFFF.F......FFF..F.............. [ 72%]
........................................................................ [ 77%]
........................................................................ [ 83%]
........................................................................ [ 88%]
........................................................................ [ 93%]
........................................................................ [ 98%]
...................                                                      [100%]
=================================== FAILURES ===================================
_________________ test_coder_run_blocked_when_review_required __________________

client = <starlette.testclient.TestClient object at 0x187edd5d0>

    def test_coder_run_blocked_when_review_required(client):
        resp = client.post(
            "/v1/coder/run",
            json={"note": "Patient X synthetic note.", "allow_weak_sedation_docs": False},
        )
>       assert resp.status_code == 400
E       assert 410 == 400
E        +  where 410 = <Response [410 Gone]>.status_code

tests/api/test_coding_phi_gating.py:131: AssertionError
----------------------------- Captured stderr call -----------------------------
{"timestamp": "2026-01-18T00:35:46.616716", "level": "INFO", "logger": "httpx", "message": "HTTP Request: POST http://testserver/v1/coder/run \"HTTP/1.1 410 Gone\""}
------------------------------ Captured log call -------------------------------
INFO     httpx:_client.py:1025 HTTP Request: POST http://testserver/v1/coder/run "HTTP/1.1 410 Gone"
_______________ test_coder_run_allowed_when_review_not_required ________________

monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x1740d7dd0>
client = <starlette.testclient.TestClient object at 0x188022790>

    def test_coder_run_allowed_when_review_not_required(monkeypatch, client):
        monkeypatch.setenv("CODER_REQUIRE_PHI_REVIEW", "false")
        fake = FakeCodingService()
        app.dependency_overrides[get_coding_service] = lambda: fake
    
        try:
            resp = client.post(
                "/v1/coder/run",
                json={"note": "Synthetic note text", "allow_weak_sedation_docs": False},
            )
>           assert resp.status_code == 200
E           assert 410 == 200
E            +  where 410 = <Response [410 Gone]>.status_code

tests/api/test_coding_phi_gating.py:144: AssertionError
----------------------------- Captured stderr call -----------------------------
{"timestamp": "2026-01-18T00:35:46.629360", "level": "INFO", "logger": "httpx", "message": "HTTP Request: POST http://testserver/v1/coder/run \"HTTP/1.1 410 Gone\""}
------------------------------ Captured log call -------------------------------
INFO     httpx:_client.py:1025 HTTP Request: POST http://testserver/v1/coder/run "HTTP/1.1 410 Gone"
_______________________ test_coder_run_fixture_response ________________________

api_client = <httpx.AsyncClient object at 0x18806a390>

    async def test_coder_run_fixture_response(api_client: AsyncClient) -> None:
        note = _read_fixture("ppl_nav_radial_tblb.txt")
        response = await api_client.post("/v1/coder/run", json={"note": note})
>       assert response.status_code == 200
E       assert 410 == 200
E        +  where 410 = <Response [410 Gone]>.status_code

tests/api/test_fastapi.py:42: AssertionError
----------------------------- Captured stderr call -----------------------------
{"timestamp": "2026-01-18T00:35:46.648583", "level": "INFO", "logger": "api_dependencies", "message": "Initializing CodingService", "kb_path": "data/knowledge/ip_coding_billing_v2_9.json", "kb_version": "v2_9", "keyword_mapping_dir": "data/keyword_mappings"}
{"timestamp": "2026-01-18T00:35:46.649842", "level": "INFO", "logger": "api_dependencies", "message": "Loaded KB version: 2.9"}
{"timestamp": "2026-01-18T00:35:46.653622", "level": "INFO", "logger": "api_dependencies", "message": "Loaded keyword mappings version: 68546a5f3c55051b"}
{"timestamp": "2026-01-18T00:35:46.653673", "level": "INFO", "logger": "api_dependencies", "message": "Negation detector version: simple_v1"}
{"timestamp": "2026-01-18T00:35:46.654058", "level": "WARNING", "logger": "rule_engine", "message": "IPCodingKnowledgeBase not available: No module named 'modules.autocode.ip_kb.ip_kb'"}
{"timestamp": "2026-01-18T00:35:46.654099", "level": "INFO", "logger": "coding_rules_engine", "message": "CodingRulesEngine initialized", "mode": "python", "version": "coding_rules_engine_v1"}
{"timestamp": "2026-01-18T00:35:46.654131", "level": "INFO", "logger": "rule_engine", "message": "CodingRulesEngine initialized", "mode": "python"}
{"timestamp": "2026-01-18T00:35:46.654158", "level": "INFO", "logger": "api_dependencies", "message": "Rule engine version: rule_engine_v2", "rules_mode": "python"}
{"timestamp": "2026-01-18T00:35:46.654186", "level": "INFO", "logger": "api_dependencies", "message": "LLM advisor disabled (CODER_USE_LLM_ADVISOR not set)"}
{"timestamp": "2026-01-18T00:35:46.654319", "level": "INFO", "logger": "ml_coder.predictor", "message": "Loading model from data/models/cpt_classifier.pkl"}
{"timestamp": "2026-01-18T00:35:46.682930", "level": "INFO", "logger": "ml_coder.predictor", "message": "Predictor initialized with 35 labels, upper=0.70, lower=0.40"}
{"timestamp": "2026-01-18T00:35:46.683318", "level": "INFO", "logger": "api_dependencies", "message": "SmartHybridOrchestrator built for RegistryService"}
{"timestamp": "2026-01-18T00:35:46.683528", "level": "WARNING", "logger": "ner.inference", "message": "GranularNERPredictor unavailable: Model directory not found: artifacts/granular_ner_model"}
{"timestamp": "2026-01-18T00:35:46.683631", "level": "INFO", "logger": "modules.infra.nlp_warmup", "message": "Loading spaCy model: en_core_sci_sm"}
{"timestamp": "2026-01-18T00:35:47.066350", "level": "INFO", "logger": "modules.infra.nlp_warmup", "message": "spaCy model en_core_sci_sm loaded successfully"}
{"timestamp": "2026-01-18T00:35:47.066480", "level": "INFO", "logger": "coder.parallel_pathway", "message": "ParallelPathwayOrchestrator initialized: NER=unavailable, ML=unavailable"}
{"timestamp": "2026-01-18T00:35:47.066524", "level": "INFO", "logger": "api_dependencies", "message": "RegistryService initialized", "default_version": "v2"}
{"timestamp": "2026-01-18T00:35:47.066562", "level": "INFO", "logger": "api_dependencies", "message": "CodingService initialized successfully"}
{"timestamp": "2026-01-18T00:35:47.067212", "level": "INFO", "logger": "httpx", "message": "HTTP Request: POST http://testserver/v1/coder/run \"HTTP/1.1 410 Gone\""}
------------------------------ Captured log call -------------------------------
INFO     api_dependencies:dependencies.py:78 Initializing CodingService
INFO     api_dependencies:dependencies.py:89 Loaded KB version: 2.9
INFO     api_dependencies:dependencies.py:93 Loaded keyword mappings version: 68546a5f3c55051b
INFO     api_dependencies:dependencies.py:97 Negation detector version: simple_v1
WARNING  rule_engine:rule_engine.py:101 IPCodingKnowledgeBase not available: No module named 'modules.autocode.ip_kb.ip_kb'
INFO     coding_rules_engine:coding_rules_engine.py:72 CodingRulesEngine initialized
INFO     rule_engine:rule_engine.py:107 CodingRulesEngine initialized
INFO     api_dependencies:dependencies.py:102 Rule engine version: rule_engine_v2
INFO     api_dependencies:dependencies.py:142 LLM advisor disabled (CODER_USE_LLM_ADVISOR not set)
INFO     ml_coder.predictor:predictor.py:175 Loading model from data/models/cpt_classifier.pkl
INFO     ml_coder.predictor:predictor.py:185 Predictor initialized with 35 labels, upper=0.70, lower=0.40
INFO     api_dependencies:dependencies.py:190 SmartHybridOrchestrator built for RegistryService
WARNING  ner.inference:inference.py:150 GranularNERPredictor unavailable: Model directory not found: artifacts/granular_ner_model
INFO     modules.infra.nlp_warmup:nlp_warmup.py:64 Loading spaCy model: en_core_sci_sm
INFO     modules.infra.nlp_warmup:nlp_warmup.py:66 spaCy model en_core_sci_sm loaded successfully
INFO     coder.parallel_pathway:orchestrator.py:157 ParallelPathwayOrchestrator initialized: NER=unavailable, ML=unavailable
INFO     api_dependencies:dependencies.py:198 RegistryService initialized
INFO     api_dependencies:dependencies.py:160 CodingService initialized successfully
INFO     httpx:_client.py:1740 HTTP Request: POST http://testserver/v1/coder/run "HTTP/1.1 410 Gone"
____________________ test_registry_run_normalizes_stations _____________________

api_client = <httpx.AsyncClient object at 0x188d20090>

    async def test_registry_run_normalizes_stations(api_client: AsyncClient) -> None:
        note = _read_fixture("ebus_staging_4R_7_11R.txt")
        response = await api_client.post(
            "/v1/registry/run",
            json={"note": note, "explain": True},
        )
>       assert response.status_code == 200
E       assert 410 == 200
E        +  where 410 = <Response [410 Gone]>.status_code

tests/api/test_fastapi.py:76: AssertionError
----------------------------- Captured stderr call -----------------------------
{"timestamp": "2026-01-18T00:35:47.073645", "level": "INFO", "logger": "httpx", "message": "HTTP Request: POST http://testserver/v1/registry/run \"HTTP/1.1 410 Gone\""}
------------------------------ Captured log call -------------------------------
INFO     httpx:_client.py:1740 HTTP Request: POST http://testserver/v1/registry/run "HTTP/1.1 410 Gone"
_____________ test_shape_registry_payload_prunes_none_and_enriches _____________

    async def test_shape_registry_payload_prunes_none_and_enriches():
        record = RegistryRecord(
            clinical_context={"asa_class": 3, "primary_indication": "Test case"},
            sedation={"type": "General", "agents_used": None},
            procedures_performed={
                "tbna_conventional": {
                    "performed": True,
                    "passes_per_station": 6,
                    "stations_sampled": ["LB10"],
                    "needle_gauge": None,
                }
            },
            billing={"cpt_codes": [{"code": "31645", "description": None}]},
        )
    
        payload = _shape_registry_payload(
            record,
            {"clinical_context": [Span(text="ASA 3", start=0, end=5)]},
        )
    
        def _contains_none(obj):
            if obj is None:
                return True
            if isinstance(obj, dict):
                return any(_contains_none(v) for v in obj.values())
            if isinstance(obj, list):
                return any(_contains_none(v) for v in obj)
            return False
    
        assert not _contains_none(payload), "Payload should be pruned of None values"
        assert payload["billing"]["cpt_codes_simple"] == ["31645"]
        tbna = payload["procedures_performed"]["tbna_conventional"]
        assert tbna["summary"].startswith("Performed")
>       assert payload["evidence"]["clinical_context"][0]["start"] == 0
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E       KeyError: 'start'

tests/api/test_fastapi.py:153: KeyError
____ TestRegistryExtractEndpoint.test_endpoint_returns_200_with_valid_input ____

self = <test_registry_extract_endpoint.TestRegistryExtractEndpoint object at 0x17409cfd0>
api_client = <httpx.AsyncClient object at 0x188edb1d0>

    @pytest.mark.asyncio
    async def test_endpoint_returns_200_with_valid_input(
        self, api_client: httpx.AsyncClient
    ) -> None:
        """Valid note text should return 200 with expected response structure."""
        response = await api_client.post(
            "/api/registry/extract",
            json={
                "note_text": (
                    "PROCEDURE: Diagnostic bronchoscopy\n\n"
                    "The patient underwent diagnostic bronchoscopy. Airways were inspected. "
                    "No abnormalities noted."
                )
            },
        )
    
        # Should return 200 (may be 503 if orchestrator not configured, which is acceptable)
>       assert response.status_code in (200, 503)
E       assert 410 in (200, 503)
E        +  where 410 = <Response [410 Gone]>.status_code

tests/api/test_registry_extract_endpoint.py:96: AssertionError
----------------------------- Captured stderr call -----------------------------
{"timestamp": "2026-01-18T00:35:47.383857", "level": "INFO", "logger": "httpx", "message": "HTTP Request: POST http://testserver/api/registry/extract \"HTTP/1.1 410 Gone\""}
------------------------------ Captured log call -------------------------------
INFO     httpx:_client.py:1740 HTTP Request: POST http://testserver/api/registry/extract "HTTP/1.1 410 Gone"
__ TestRegistryExtractWithMockedService.test_ebus_codes_reflected_in_response __

self = <test_registry_extract_endpoint.TestRegistryExtractWithMockedService object at 0x17409e7d0>

    @pytest.mark.asyncio
    async def test_ebus_codes_reflected_in_response(self) -> None:
        """EBUS CPT codes from service should appear in response."""
        mock_result = make_mock_extraction_result(
            cpt_codes=["31653", "31627"],
            coder_difficulty="high_confidence",
            coder_source="ml_rules_fastpath",
            mapped_fields={
                "procedures_performed": {
                    "linear_ebus": {"performed": True},
                    "navigational_bronchoscopy": {"performed": True},
                }
            },
            needs_manual_review=False,
            record_data={
                "procedures_performed": {
                    "linear_ebus": {"performed": True},
                    "navigational_bronchoscopy": {"performed": True},
                }
            },
        )
    
        mock_service = MagicMock(spec=RegistryService)
        mock_service.extract_fields.return_value = mock_result
    
        # Use FastAPI dependency override
        app.dependency_overrides[get_registry_service] = lambda: mock_service
    
        try:
            transport = httpx.ASGITransport(app=app, raise_app_exceptions=False)
            async with httpx.AsyncClient(
                transport=transport,
                base_url="http://testserver",
            ) as client:
                response = await client.post(
                    "/api/registry/extract",
                    json={
                        "note_text": (
                            "PROCEDURE: EBUS-TBNA with Navigation\n\n"
                            "The patient underwent EBUS-TBNA of stations 4R, 7, and 11L. "
                            "Navigation bronchoscopy was used."
                        )
                    },
                )
    
>               assert response.status_code == 200
E               assert 410 == 200
E                +  where 410 = <Response [410 Gone]>.status_code

tests/api/test_registry_extract_endpoint.py:184: AssertionError
----------------------------- Captured stderr call -----------------------------
{"timestamp": "2026-01-18T00:35:47.397402", "level": "INFO", "logger": "httpx", "message": "HTTP Request: POST http://testserver/api/registry/extract \"HTTP/1.1 410 Gone\""}
------------------------------ Captured log call -------------------------------
INFO     httpx:_client.py:1740 HTTP Request: POST http://testserver/api/registry/extract "HTTP/1.1 410 Gone"
__ TestRegistryExtractWithMockedService.test_low_conf_triggers_manual_review ___

self = <test_registry_extract_endpoint.TestRegistryExtractWithMockedService object at 0x17409ecd0>

    @pytest.mark.asyncio
    async def test_low_conf_triggers_manual_review(self) -> None:
        """LOW_CONF difficulty should set needs_manual_review=True."""
        mock_result = make_mock_extraction_result(
            cpt_codes=["31622"],
            coder_difficulty="low_confidence",
            coder_source="hybrid_llm_fallback",
            mapped_fields={},
            needs_manual_review=True,
            validation_errors=[
                "Hybrid coder marked this case as LOW_CONF; manual review required."
            ],
        )
    
        mock_service = MagicMock(spec=RegistryService)
        mock_service.extract_fields.return_value = mock_result
    
        app.dependency_overrides[get_registry_service] = lambda: mock_service
    
        try:
            transport = httpx.ASGITransport(app=app, raise_app_exceptions=False)
            async with httpx.AsyncClient(
                transport=transport,
                base_url="http://testserver",
            ) as client:
                response = await client.post(
                    "/api/registry/extract",
                    json={"note_text": "Some ambiguous procedure note that is hard to code."},
                )
    
>               assert response.status_code == 200
E               assert 410 == 200
E                +  where 410 = <Response [410 Gone]>.status_code

tests/api/test_registry_extract_endpoint.py:233: AssertionError
----------------------------- Captured stderr call -----------------------------
{"timestamp": "2026-01-18T00:35:47.404595", "level": "INFO", "logger": "httpx", "message": "HTTP Request: POST http://testserver/api/registry/extract \"HTTP/1.1 410 Gone\""}
------------------------------ Captured log call -------------------------------
INFO     httpx:_client.py:1740 HTTP Request: POST http://testserver/api/registry/extract "HTTP/1.1 410 Gone"
_ TestRegistryExtractWithMockedService.test_response_prunes_nulls_and_adds_formatted_fields _

self = <test_registry_extract_endpoint.TestRegistryExtractWithMockedService object at 0x17409f610>

    @pytest.mark.asyncio
    async def test_response_prunes_nulls_and_adds_formatted_fields(self) -> None:
        """Response should exclude None fields and add UI-friendly derived fields."""
        mock_result = make_mock_extraction_result(
            cpt_codes=["31653"],
            record_data={
                "billing": {
                    "cpt_codes": [
                        {"code": "31653", "description": None, "modifier": None},
                    ],
                },
                "procedures_performed": {
                    "linear_ebus": {
                        "performed": True,
                        "passes_per_station": 6,
                        "stations_sampled": ["4R", "7"],
                    }
                },
            },
        )
    
        mock_service = MagicMock(spec=RegistryService)
        mock_service.extract_fields.return_value = mock_result
    
        app.dependency_overrides[get_registry_service] = lambda: mock_service
    
        try:
            transport = httpx.ASGITransport(app=app, raise_app_exceptions=False)
            async with httpx.AsyncClient(
                transport=transport,
                base_url="http://testserver",
            ) as client:
                response = await client.post(
                    "/api/registry/extract",
                    json={
                        "note_text": "PROCEDURE: EBUS-TBNA performed at station 4R and 7."
                    },
                )
    
>               assert response.status_code == 200
E               assert 410 == 200
E                +  where 410 = <Response [410 Gone]>.status_code

tests/api/test_registry_extract_endpoint.py:281: AssertionError
----------------------------- Captured stderr call -----------------------------
{"timestamp": "2026-01-18T00:35:47.412005", "level": "INFO", "logger": "httpx", "message": "HTTP Request: POST http://testserver/api/registry/extract \"HTTP/1.1 410 Gone\""}
------------------------------ Captured log call -------------------------------
INFO     httpx:_client.py:1740 HTTP Request: POST http://testserver/api/registry/extract "HTTP/1.1 410 Gone"
___ TestRegistryExtractWithMockedService.test_validation_errors_in_response ____

self = <test_registry_extract_endpoint.TestRegistryExtractWithMockedService object at 0x17409fed0>

    @pytest.mark.asyncio
    async def test_validation_errors_in_response(self) -> None:
        """Validation errors should appear in response."""
        mock_result = make_mock_extraction_result(
            cpt_codes=["31652"],
            coder_difficulty="high_confidence",
            coder_source="ml_rules_fastpath",
            mapped_fields={"procedures_performed": {"linear_ebus": {"performed": True}}},
            warnings=["Some warning"],
            needs_manual_review=True,
            validation_errors=[
                "CPT 31652 present but procedures_performed.linear_ebus "
                "is not marked."
            ],
        )
    
        mock_service = MagicMock(spec=RegistryService)
        mock_service.extract_fields.return_value = mock_result
    
        app.dependency_overrides[get_registry_service] = lambda: mock_service
    
        try:
            transport = httpx.ASGITransport(app=app, raise_app_exceptions=False)
            async with httpx.AsyncClient(
                transport=transport,
                base_url="http://testserver",
            ) as client:
                response = await client.post(
                    "/api/registry/extract",
                    json={"note_text": "EBUS procedure but extractor missed the field."},
                )
    
>               assert response.status_code == 200
E               assert 410 == 200
E                +  where 410 = <Response [410 Gone]>.status_code

tests/api/test_registry_extract_endpoint.py:329: AssertionError
----------------------------- Captured stderr call -----------------------------
{"timestamp": "2026-01-18T00:35:47.419645", "level": "INFO", "logger": "httpx", "message": "HTTP Request: POST http://testserver/api/registry/extract \"HTTP/1.1 410 Gone\""}
------------------------------ Captured log call -------------------------------
INFO     httpx:_client.py:1740 HTTP Request: POST http://testserver/api/registry/extract "HTTP/1.1 410 Gone"
_______ TestRegistryExtractWithMockedService.test_pleural_codes_mapping ________

self = <test_registry_extract_endpoint.TestRegistryExtractWithMockedService object at 0x1740a4850>

    @pytest.mark.asyncio
    async def test_pleural_codes_mapping(self) -> None:
        """Pleural CPT codes should map to pleural_procedures section."""
        mock_result = make_mock_extraction_result(
            cpt_codes=["32555"],
            coder_difficulty="high_confidence",
            coder_source="ml_rules_fastpath",
            mapped_fields={"pleural_procedures": {"thoracentesis": {"performed": True}}},
            needs_manual_review=False,
            record_data={
                "pleural_procedures": {"thoracentesis": {"performed": True}},
            },
        )
    
        mock_service = MagicMock(spec=RegistryService)
        mock_service.extract_fields.return_value = mock_result
    
        app.dependency_overrides[get_registry_service] = lambda: mock_service
    
        try:
            transport = httpx.ASGITransport(app=app, raise_app_exceptions=False)
            async with httpx.AsyncClient(
                transport=transport,
                base_url="http://testserver",
            ) as client:
                response = await client.post(
                    "/api/registry/extract",
                    json={
                        "note_text": (
                            "Thoracentesis performed under ultrasound guidance. "
                            "1200mL removed."
                        )
                    },
                )
    
>               assert response.status_code == 200
E               assert 410 == 200
E                +  where 410 = <Response [410 Gone]>.status_code

tests/api/test_registry_extract_endpoint.py:374: AssertionError
----------------------------- Captured stderr call -----------------------------
{"timestamp": "2026-01-18T00:35:47.427457", "level": "INFO", "logger": "httpx", "message": "HTTP Request: POST http://testserver/api/registry/extract \"HTTP/1.1 410 Gone\""}
------------------------------ Captured log call -------------------------------
INFO     httpx:_client.py:1740 HTTP Request: POST http://testserver/api/registry/extract "HTTP/1.1 410 Gone"
_____ TestRegistryExtractErrorHandling.test_service_exception_returns_500 ______

self = <test_registry_extract_endpoint.TestRegistryExtractErrorHandling object at 0x1740a5390>

    @pytest.mark.asyncio
    async def test_service_exception_returns_500(self) -> None:
        """Service exceptions should return 500."""
        mock_service = MagicMock(spec=RegistryService)
        mock_service.extract_fields.side_effect = Exception("Internal error")
    
        app.dependency_overrides[get_registry_service] = lambda: mock_service
    
        try:
            transport = httpx.ASGITransport(app=app, raise_app_exceptions=False)
            async with httpx.AsyncClient(
                transport=transport,
                base_url="http://testserver",
            ) as client:
                response = await client.post(
                    "/api/registry/extract",
                    json={"note_text": "Some procedure note that causes an error."},
                )
    
>               assert response.status_code == 500
E               assert 410 == 500
E                +  where 410 = <Response [410 Gone]>.status_code

tests/api/test_registry_extract_endpoint.py:412: AssertionError
----------------------------- Captured stderr call -----------------------------
{"timestamp": "2026-01-18T00:35:47.434884", "level": "INFO", "logger": "httpx", "message": "HTTP Request: POST http://testserver/api/registry/extract \"HTTP/1.1 410 Gone\""}
------------------------------ Captured log call -------------------------------
INFO     httpx:_client.py:1740 HTTP Request: POST http://testserver/api/registry/extract "HTTP/1.1 410 Gone"
_____ TestResponseSchemaValidation.test_response_has_all_documented_fields _____

self = <test_registry_extract_endpoint.TestResponseSchemaValidation object at 0x1740a6850>

    @pytest.mark.asyncio
    async def test_response_has_all_documented_fields(self) -> None:
        """Response should contain all fields documented in Registry_API.md."""
        mock_result = make_mock_extraction_result(
            cpt_codes=["31622"],
            coder_difficulty="high_confidence",
            coder_source="ml_rules_fastpath",
            mapped_fields={},
            needs_manual_review=False,
        )
    
        mock_service = MagicMock(spec=RegistryService)
        mock_service.extract_fields.return_value = mock_result
    
        app.dependency_overrides[get_registry_service] = lambda: mock_service
    
        try:
            transport = httpx.ASGITransport(app=app, raise_app_exceptions=False)
            async with httpx.AsyncClient(
                transport=transport,
                base_url="http://testserver",
            ) as client:
                response = await client.post(
                    "/api/registry/extract",
                    json={"note_text": "Diagnostic bronchoscopy performed."},
                )
    
>               assert response.status_code == 200
E               assert 410 == 200
E                +  where 410 = <Response [410 Gone]>.status_code

tests/api/test_registry_extract_endpoint.py:463: AssertionError
----------------------------- Captured stderr call -----------------------------
{"timestamp": "2026-01-18T00:35:47.443948", "level": "INFO", "logger": "httpx", "message": "HTTP Request: POST http://testserver/api/registry/extract \"HTTP/1.1 410 Gone\""}
------------------------------ Captured log call -------------------------------
INFO     httpx:_client.py:1740 HTTP Request: POST http://testserver/api/registry/extract "HTTP/1.1 410 Gone"
____________________ test_unified_process_already_scrubbed _____________________

mock_registry_service = <MagicMock id='6593200784'>
mock_phi_scrubber = <MagicMock id='6592861520'>

    def test_unified_process_already_scrubbed(mock_registry_service, mock_phi_scrubber):
        # Setup mock return
        mock_record = IPRegistryV2(
            patient={"patient_id": "123"},
            procedure={"procedure_date": "2023-01-01", "indication": "Test"}
        )
        # We need a full RegistryRecord wrapping the V2 entry
        full_record = RegistryRecord(
            patient=mock_record.patient,
            procedure=mock_record.procedure,
            # minimal fields to satisfy validation
        )
    
        extraction_result = RegistryExtractionResult(
            record=full_record,
            cpt_codes=["31622"],
            coder_difficulty="HIGH_CONF",
            coder_source="ml_rules_fastpath",
            mapped_fields={},
            needs_manual_review=False
        )
    
        mock_registry_service.extract_fields.return_value = extraction_result
    
        payload = {
            "note": "Already scrubbed text",
            "already_scrubbed": True
        }
    
        response = client.post("/api/v1/process", json=payload)
    
        assert response.status_code == 200
        data = response.json()
>       assert data["cpt_codes"] == ["31622"]
E       AssertionError: assert [] == ['31622']
E         
E         Right contains one more item: '31622'
E         Use -v to get more diff

tests/api/test_unified_process.py:61: AssertionError
----------------------------- Captured stderr call -----------------------------
{"timestamp": "2026-01-18T00:35:47.459500", "level": "INFO", "logger": "httpx", "message": "HTTP Request: POST http://testserver/api/v1/process \"HTTP/1.1 200 OK\""}
------------------------------ Captured log call -------------------------------
INFO     httpx:_client.py:1025 HTTP Request: POST http://testserver/api/v1/process "HTTP/1.1 200 OK"
__________ TestCoderRunEndpointBasic.test_coder_run_rules_only_basic ___________

self = <api.test_coder_run_endpoint.TestCoderRunEndpointBasic object at 0x17418cd10>
client = (<starlette.testclient.TestClient object at 0x1881dae90>, <api.test_coder_run_endpoint.MockLLMAdvisor object at 0x1cefaf650>)

    def test_coder_run_rules_only_basic(self, client):
        """Test coder run with rules_only mode returns valid response."""
        test_client, _ = client
    
        response = test_client.post(
            "/v1/coder/run",
            json={
                "note": "EBUS-TBNA performed at station 4R. BAL collected from RML.",
                "locality": "00",
                "setting": "facility",
                "mode": "rules_only",
            },
        )
    
>       assert response.status_code == 200
E       assert 410 == 200
E        +  where 410 = <Response [410 Gone]>.status_code

tests/integration/api/test_coder_run_endpoint.py:403: AssertionError
----------------------------- Captured stderr call -----------------------------
{"timestamp": "2026-01-18T00:35:48.025693", "level": "INFO", "logger": "httpx", "message": "HTTP Request: POST http://testserver/v1/coder/run \"HTTP/1.1 410 Gone\""}
------------------------------ Captured log call -------------------------------
INFO     httpx:_client.py:1025 HTTP Request: POST http://testserver/v1/coder/run "HTTP/1.1 410 Gone"
_____ TestCoderRunEndpointBasic.test_coder_run_returns_200_for_simple_note _____

self = <api.test_coder_run_endpoint.TestCoderRunEndpointBasic object at 0x17418d250>
client = (<starlette.testclient.TestClient object at 0x1cee59d50>, <api.test_coder_run_endpoint.MockLLMAdvisor object at 0x188023a90>)

    def test_coder_run_returns_200_for_simple_note(self, client):
        """Test that a simple procedure note returns 200."""
        test_client, _ = client
    
        response = test_client.post(
            "/v1/coder/run",
            json={
                "note": "Diagnostic bronchoscopy performed.",
            },
        )
    
>       assert response.status_code == 200
E       assert 410 == 200
E        +  where 410 = <Response [410 Gone]>.status_code

tests/integration/api/test_coder_run_endpoint.py:433: AssertionError
----------------------------- Captured stderr call -----------------------------
{"timestamp": "2026-01-18T00:35:48.034254", "level": "INFO", "logger": "httpx", "message": "HTTP Request: POST http://testserver/v1/coder/run \"HTTP/1.1 410 Gone\""}
------------------------------ Captured log call -------------------------------
INFO     httpx:_client.py:1025 HTTP Request: POST http://testserver/v1/coder/run "HTTP/1.1 410 Gone"
____ TestCoderRunEndpointBasic.test_coder_run_default_locality_and_setting _____

self = <api.test_coder_run_endpoint.TestCoderRunEndpointBasic object at 0x17418d910>
client = (<starlette.testclient.TestClient object at 0x1cee56650>, <api.test_coder_run_endpoint.MockLLMAdvisor object at 0x1ceee8910>)

    def test_coder_run_default_locality_and_setting(self, client):
        """Test default values for locality and setting."""
        test_client, _ = client
    
        # Note: defaults are locality="00", setting="facility"
        response = test_client.post(
            "/v1/coder/run",
            json={
                "note": "BAL performed.",
            },
        )
    
>       assert response.status_code == 200
E       assert 410 == 200
E        +  where 410 = <Response [410 Gone]>.status_code

tests/integration/api/test_coder_run_endpoint.py:447: AssertionError
----------------------------- Captured stderr call -----------------------------
{"timestamp": "2026-01-18T00:35:48.042715", "level": "INFO", "logger": "httpx", "message": "HTTP Request: POST http://testserver/v1/coder/run \"HTTP/1.1 410 Gone\""}
------------------------------ Captured log call -------------------------------
INFO     httpx:_client.py:1025 HTTP Request: POST http://testserver/v1/coder/run "HTTP/1.1 410 Gone"
_________ TestCoderRunEndpointBasic.test_coder_run_financials_present __________

self = <api.test_coder_run_endpoint.TestCoderRunEndpointBasic object at 0x17418e050>
client = (<starlette.testclient.TestClient object at 0x188254350>, <api.test_coder_run_endpoint.MockLLMAdvisor object at 0x1cee68350>)

    def test_coder_run_financials_present(self, client):
        """Test that financials are included when codes are returned."""
        test_client, _ = client
    
        response = test_client.post(
            "/v1/coder/run",
            json={
                "note": "EBUS-TBNA performed at station 4R.",
                "locality": "00",
            },
        )
    
>       assert response.status_code == 200
E       assert 410 == 200
E        +  where 410 = <Response [410 Gone]>.status_code

tests/integration/api/test_coder_run_endpoint.py:461: AssertionError
----------------------------- Captured stderr call -----------------------------
{"timestamp": "2026-01-18T00:35:48.051343", "level": "INFO", "logger": "httpx", "message": "HTTP Request: POST http://testserver/v1/coder/run \"HTTP/1.1 410 Gone\""}
------------------------------ Captured log call -------------------------------
INFO     httpx:_client.py:1025 HTTP Request: POST http://testserver/v1/coder/run "HTTP/1.1 410 Gone"
____ TestCoderRunEndpointSmartHybrid.test_coder_run_smart_hybrid_llm_mocked ____

self = <api.test_coder_run_endpoint.TestCoderRunEndpointSmartHybrid object at 0x17418e890>
client = (<starlette.testclient.TestClient object at 0x1cefa1d10>, <api.test_coder_run_endpoint.MockLLMAdvisor object at 0x1cefa2ad0>)

    def test_coder_run_smart_hybrid_llm_mocked(self, client):
        """Test smart hybrid mode with mocked LLM advisor."""
        test_client, llm_advisor = client
    
        # Configure LLM to suggest codes
        llm_advisor.set_suggestions({"31652": 0.95, "31624": 0.88})
    
        response = test_client.post(
            "/v1/coder/run",
            json={
                "note": "EBUS-TBNA performed at station 4R. BAL collected.",
            },
        )
    
>       assert response.status_code == 200
E       assert 410 == 200
E        +  where 410 = <Response [410 Gone]>.status_code

tests/integration/api/test_coder_run_endpoint.py:490: AssertionError
----------------------------- Captured stderr call -----------------------------
{"timestamp": "2026-01-18T00:35:48.182759", "level": "INFO", "logger": "httpx", "message": "HTTP Request: POST http://testserver/v1/coder/run \"HTTP/1.1 410 Gone\""}
------------------------------ Captured log call -------------------------------
INFO     httpx:_client.py:1025 HTTP Request: POST http://testserver/v1/coder/run "HTTP/1.1 410 Gone"
_ TestCoderRunEndpointSmartHybrid.test_coder_run_llm_agreement_boosts_confidence _

self = <api.test_coder_run_endpoint.TestCoderRunEndpointSmartHybrid object at 0x17418efd0>
client = (<starlette.testclient.TestClient object at 0x1ce9fa910>, <api.test_coder_run_endpoint.MockLLMAdvisor object at 0x1cefa2f50>)

    def test_coder_run_llm_agreement_boosts_confidence(self, client):
        """Test that LLM agreement with rules results in hybrid source."""
        test_client, llm_advisor = client
    
        # Configure LLM to agree with rules
        llm_advisor.set_suggestions({"31652": 0.95})
    
        response = test_client.post(
            "/v1/coder/run",
            json={
                "note": "EBUS-TBNA performed at lymph node station 4R.",
            },
        )
    
>       assert response.status_code == 200
E       assert 410 == 200
E        +  where 410 = <Response [410 Gone]>.status_code

tests/integration/api/test_coder_run_endpoint.py:513: AssertionError
----------------------------- Captured stderr call -----------------------------
{"timestamp": "2026-01-18T00:35:48.191198", "level": "INFO", "logger": "httpx", "message": "HTTP Request: POST http://testserver/v1/coder/run \"HTTP/1.1 410 Gone\""}
------------------------------ Captured log call -------------------------------
INFO     httpx:_client.py:1025 HTTP Request: POST http://testserver/v1/coder/run "HTTP/1.1 410 Gone"
__ TestCoderRunEndpointSmartHybrid.test_coder_run_llm_suggestions_in_response __

self = <api.test_coder_run_endpoint.TestCoderRunEndpointSmartHybrid object at 0x17418f790>
client = (<starlette.testclient.TestClient object at 0x1cee4c850>, <api.test_coder_run_endpoint.MockLLMAdvisor object at 0x1cefa2e10>)

    def test_coder_run_llm_suggestions_in_response(self, client):
        """Test that LLM suggestions are included in response when available."""
        test_client, llm_advisor = client
    
        # Configure LLM suggestions
        llm_advisor.set_suggestions({"31627": 0.92})
    
        response = test_client.post(
            "/v1/coder/run",
            json={
                "note": "Navigation bronchoscopy performed.",
            },
        )
    
>       assert response.status_code == 200
E       assert 410 == 200
E        +  where 410 = <Response [410 Gone]>.status_code

tests/integration/api/test_coder_run_endpoint.py:540: AssertionError
----------------------------- Captured stderr call -----------------------------
{"timestamp": "2026-01-18T00:35:48.199609", "level": "INFO", "logger": "httpx", "message": "HTTP Request: POST http://testserver/v1/coder/run \"HTTP/1.1 410 Gone\""}
------------------------------ Captured log call -------------------------------
INFO     httpx:_client.py:1025 HTTP Request: POST http://testserver/v1/coder/run "HTTP/1.1 410 Gone"
_______ TestCoderRunEndpointValidation.test_coder_run_handles_empty_note _______

self = <api.test_coder_run_endpoint.TestCoderRunEndpointValidation object at 0x174190810>
client = (<starlette.testclient.TestClient object at 0x1cede21d0>, <api.test_coder_run_endpoint.MockLLMAdvisor object at 0x1cede1210>)

    def test_coder_run_handles_empty_note(self, client):
        """Test handling of empty note."""
        test_client, _ = client
    
        response = test_client.post(
            "/v1/coder/run",
            json={
                "note": "",
            },
        )
    
        # Should return 200 but possibly with no codes
>       assert response.status_code == 200
E       assert 410 == 200
E        +  where 410 = <Response [410 Gone]>.status_code

tests/integration/api/test_coder_run_endpoint.py:580: AssertionError
----------------------------- Captured stderr call -----------------------------
{"timestamp": "2026-01-18T00:35:48.210812", "level": "INFO", "logger": "httpx", "message": "HTTP Request: POST http://testserver/v1/coder/run \"HTTP/1.1 410 Gone\""}
------------------------------ Captured log call -------------------------------
INFO     httpx:_client.py:1025 HTTP Request: POST http://testserver/v1/coder/run "HTTP/1.1 410 Gone"
______ TestCoderRunEndpointValidation.test_coder_run_accepts_extra_fields ______

self = <api.test_coder_run_endpoint.TestCoderRunEndpointValidation object at 0x174190fd0>
client = (<starlette.testclient.TestClient object at 0x1ce9fb250>, <api.test_coder_run_endpoint.MockLLMAdvisor object at 0x1cede2fd0>)

    def test_coder_run_accepts_extra_fields(self, client):
        """Test that extra fields in request are ignored (not rejected)."""
        test_client, _ = client
    
        response = test_client.post(
            "/v1/coder/run",
            json={
                "note": "BAL performed.",
                "extra_field": "should be ignored",
                "another_field": 123,
            },
        )
    
>       assert response.status_code == 200
E       assert 410 == 200
E        +  where 410 = <Response [410 Gone]>.status_code

tests/integration/api/test_coder_run_endpoint.py:597: AssertionError
----------------------------- Captured stderr call -----------------------------
{"timestamp": "2026-01-18T00:35:48.219251", "level": "INFO", "logger": "httpx", "message": "HTTP Request: POST http://testserver/v1/coder/run \"HTTP/1.1 410 Gone\""}
------------------------------ Captured log call -------------------------------
INFO     httpx:_client.py:1025 HTTP Request: POST http://testserver/v1/coder/run "HTTP/1.1 410 Gone"
____ TestCoderRunEndpointProvenance.test_coder_run_has_provenance_in_codes _____

self = <api.test_coder_run_endpoint.TestCoderRunEndpointProvenance object at 0x174191850>
client = (<starlette.testclient.TestClient object at 0x1cefa5d50>, <api.test_coder_run_endpoint.MockLLMAdvisor object at 0x1cefa4990>)

    def test_coder_run_has_provenance_in_codes(self, client):
        """Test that codes include provenance information."""
        test_client, _ = client
    
        response = test_client.post(
            "/v1/coder/run",
            json={
                "note": "EBUS-TBNA performed at station 4R.",
            },
        )
    
>       assert response.status_code == 200
E       assert 410 == 200
E        +  where 410 = <Response [410 Gone]>.status_code

tests/integration/api/test_coder_run_endpoint.py:614: AssertionError
----------------------------- Captured stderr call -----------------------------
{"timestamp": "2026-01-18T00:35:48.227253", "level": "INFO", "logger": "httpx", "message": "HTTP Request: POST http://testserver/v1/coder/run \"HTTP/1.1 410 Gone\""}
------------------------------ Captured log call -------------------------------
INFO     httpx:_client.py:1025 HTTP Request: POST http://testserver/v1/coder/run "HTTP/1.1 410 Gone"
_____ TestCoderRunEndpointProvenance.test_coder_run_reasoning_in_rationale _____

self = <api.test_coder_run_endpoint.TestCoderRunEndpointProvenance object at 0x174191fd0>
client = (<starlette.testclient.TestClient object at 0x1cee54210>, <api.test_coder_run_endpoint.MockLLMAdvisor object at 0x1cee56f10>)

    def test_coder_run_reasoning_in_rationale(self, client):
        """Test that reasoning is captured in rationale field."""
        test_client, _ = client
    
        response = test_client.post(
            "/v1/coder/run",
            json={
                "note": "BAL bronchoalveolar lavage performed.",
            },
        )
    
>       assert response.status_code == 200
E       assert 410 == 200
E        +  where 410 = <Response [410 Gone]>.status_code

tests/integration/api/test_coder_run_endpoint.py:636: AssertionError
----------------------------- Captured stderr call -----------------------------
{"timestamp": "2026-01-18T00:35:48.235546", "level": "INFO", "logger": "httpx", "message": "HTTP Request: POST http://testserver/v1/coder/run \"HTTP/1.1 410 Gone\""}
------------------------------ Captured log call -------------------------------
INFO     httpx:_client.py:1025 HTTP Request: POST http://testserver/v1/coder/run "HTTP/1.1 410 Gone"
__ TestCoderRunEndpointComplexNotes.test_coder_run_complex_bronchoscopy_note ___

self = <api.test_coder_run_endpoint.TestCoderRunEndpointComplexNotes object at 0x1741928d0>
client = (<starlette.testclient.TestClient object at 0x1cee57f50>, <api.test_coder_run_endpoint.MockLLMAdvisor object at 0x1cee556d0>)

    def test_coder_run_complex_bronchoscopy_note(self, client):
        """Test with a complex bronchoscopy procedure note."""
        test_client, llm_advisor = client
    
        # Configure LLM
        llm_advisor.set_suggestions({"31652": 0.95, "31624": 0.88})
    
        complex_note = """
        PROCEDURE NOTE
    
        Patient: John Doe
        MRN: 12345
        Date: 2024-01-15
    
        INDICATION: Suspected lung malignancy with mediastinal lymphadenopathy
    
        PROCEDURE: Flexible bronchoscopy with EBUS-TBNA and BAL
    
        ANESTHESIA: Moderate sedation
    
        FINDINGS:
        1. Normal vocal cords and trachea
        2. EBUS-TBNA performed at lymph node station 4R (3 passes)
        3. Bronchoalveolar lavage collected from right middle lobe
    
        SPECIMENS:
        - EBUS-TBNA station 4R for cytology and flow cytometry
        - BAL for cell count and cultures
    
        COMPLICATIONS: None
    
        IMPRESSION: Successful bronchoscopy with staging and lavage
        """
    
        response = test_client.post(
            "/v1/coder/run",
            json={
                "note": complex_note,
                "locality": "00",
            },
        )
    
>       assert response.status_code == 200
E       assert 410 == 200
E        +  where 410 = <Response [410 Gone]>.status_code

tests/integration/api/test_coder_run_endpoint.py:692: AssertionError
----------------------------- Captured stderr call -----------------------------
{"timestamp": "2026-01-18T00:35:48.243303", "level": "INFO", "logger": "httpx", "message": "HTTP Request: POST http://testserver/v1/coder/run \"HTTP/1.1 410 Gone\""}
------------------------------ Captured log call -------------------------------
INFO     httpx:_client.py:1025 HTTP Request: POST http://testserver/v1/coder/run "HTTP/1.1 410 Gone"
______ TestCoderRunEndpointComplexNotes.test_coder_run_thoracentesis_note ______

self = <api.test_coder_run_endpoint.TestCoderRunEndpointComplexNotes object at 0x174193050>
client = (<starlette.testclient.TestClient object at 0x1cee7ced0>, <api.test_coder_run_endpoint.MockLLMAdvisor object at 0x1cee7ddd0>)

    def test_coder_run_thoracentesis_note(self, client):
        """Test with thoracentesis procedure note."""
        test_client, _ = client
    
        response = test_client.post(
            "/v1/coder/run",
            json={
                "note": """
                Ultrasound-guided thoracentesis performed.
                1500ml of pleural fluid removed from right pleural space.
                Fluid sent for cell count, cultures, and cytology.
                """,
            },
        )
    
>       assert response.status_code == 200
E       assert 410 == 200
E        +  where 410 = <Response [410 Gone]>.status_code

tests/integration/api/test_coder_run_endpoint.py:716: AssertionError
----------------------------- Captured stderr call -----------------------------
{"timestamp": "2026-01-18T00:35:48.251664", "level": "INFO", "logger": "httpx", "message": "HTTP Request: POST http://testserver/v1/coder/run \"HTTP/1.1 410 Gone\""}
------------------------------ Captured log call -------------------------------
INFO     httpx:_client.py:1025 HTTP Request: POST http://testserver/v1/coder/run "HTTP/1.1 410 Gone"
______ TestSuggestCodesEndpoint.test_suggest_codes_happy_path_rules_only _______

self = <api.test_procedure_codes_endpoints.TestSuggestCodesEndpoint object at 0x1741cf8d0>
client = (<starlette.testclient.TestClient object at 0x1ceeeb410>, <api.test_procedure_codes_endpoints.MockLLMAdvisor object at 0x189106b50>)

    def test_suggest_codes_happy_path_rules_only(self, client):
        """Test suggestion endpoint with rules-only mode."""
        test_client, _ = client
    
        response = test_client.post(
            "/api/v1/procedures/test-001/codes/suggest",
            json={
                "report_text": "EBUS-TBNA performed at station 4R. BAL collected from RML.",
                "use_llm": False,  # Rules only
            },
        )
    
>       assert response.status_code == 200
E       assert 400 == 200
E        +  where 400 = <Response [400 Bad Request]>.status_code

tests/integration/api/test_procedure_codes_endpoints.py:374: AssertionError
----------------------------- Captured stderr call -----------------------------
{"timestamp": "2026-01-18T00:35:48.499458", "level": "INFO", "logger": "httpx", "message": "HTTP Request: POST http://testserver/api/v1/procedures/test-001/codes/suggest \"HTTP/1.1 400 Bad Request\""}
------------------------------ Captured log call -------------------------------
INFO     httpx:_client.py:1025 HTTP Request: POST http://testserver/api/v1/procedures/test-001/codes/suggest "HTTP/1.1 400 Bad Request"
________ TestSuggestCodesEndpoint.test_suggest_codes_with_llm_agreement ________

self = <api.test_procedure_codes_endpoints.TestSuggestCodesEndpoint object at 0x17414ffd0>
client = (<starlette.testclient.TestClient object at 0x18916ba50>, <api.test_procedure_codes_endpoints.MockLLMAdvisor object at 0x189168b90>)

    def test_suggest_codes_with_llm_agreement(self, client):
        """Test suggestion with LLM agreeing with rules."""
        test_client, llm_advisor = client
    
        # Configure LLM to agree with rules
        llm_advisor.set_suggestions({"31652": 0.95})
    
        response = test_client.post(
            "/api/v1/procedures/test-002/codes/suggest",
            json={
                "report_text": "EBUS-TBNA performed at station 4R.",
                "use_llm": True,
            },
        )
    
>       assert response.status_code == 200
E       assert 400 == 200
E        +  where 400 = <Response [400 Bad Request]>.status_code

tests/integration/api/test_procedure_codes_endpoints.py:407: AssertionError
----------------------------- Captured stderr call -----------------------------
{"timestamp": "2026-01-18T00:35:48.511802", "level": "INFO", "logger": "httpx", "message": "HTTP Request: POST http://testserver/api/v1/procedures/test-002/codes/suggest \"HTTP/1.1 400 Bad Request\""}
------------------------------ Captured log call -------------------------------
INFO     httpx:_client.py:1025 HTTP Request: POST http://testserver/api/v1/procedures/test-002/codes/suggest "HTTP/1.1 400 Bad Request"
______ TestSuggestCodesEndpoint.test_suggest_codes_llm_addition_verified _______

self = <api.test_procedure_codes_endpoints.TestSuggestCodesEndpoint object at 0x1741cfbd0>
client = (<starlette.testclient.TestClient object at 0x189169010>, <api.test_procedure_codes_endpoints.MockLLMAdvisor object at 0x18916a0d0>)

    def test_suggest_codes_llm_addition_verified(self, client):
        """Test LLM-only code that gets verified by keywords."""
        test_client, llm_advisor = client
    
        # LLM suggests a code that rules miss
        llm_advisor.set_suggestions({"31627": 0.92})
    
        response = test_client.post(
            "/api/v1/procedures/test-003/codes/suggest",
            json={
                "report_text": "Electromagnetic navigation bronchoscopy performed.",
                "use_llm": True,
            },
        )
    
>       assert response.status_code == 200
E       assert 400 == 200
E        +  where 400 = <Response [400 Bad Request]>.status_code

tests/integration/api/test_procedure_codes_endpoints.py:436: AssertionError
----------------------------- Captured stderr call -----------------------------
{"timestamp": "2026-01-18T00:35:48.521384", "level": "INFO", "logger": "httpx", "message": "HTTP Request: POST http://testserver/api/v1/procedures/test-003/codes/suggest \"HTTP/1.1 400 Bad Request\""}
------------------------------ Captured log call -------------------------------
INFO     httpx:_client.py:1025 HTTP Request: POST http://testserver/api/v1/procedures/test-003/codes/suggest "HTTP/1.1 400 Bad Request"
__________ TestGetSuggestionsEndpoint.test_get_suggestions_after_post __________

self = <api.test_procedure_codes_endpoints.TestGetSuggestionsEndpoint object at 0x1741e02d0>
client = (<starlette.testclient.TestClient object at 0x18916b190>, <api.test_procedure_codes_endpoints.MockLLMAdvisor object at 0x18916bad0>)

    def test_get_suggestions_after_post(self, client):
        """Test retrieving suggestions after POST."""
        test_client, _ = client
    
        # First POST to generate suggestions
        post_response = test_client.post(
            "/api/v1/procedures/test-010/codes/suggest",
            json={
                "report_text": "EBUS-TBNA at station 4R. BAL performed.",
                "use_llm": False,
            },
        )
>       assert post_response.status_code == 200
E       assert 400 == 200
E        +  where 400 = <Response [400 Bad Request]>.status_code

tests/integration/api/test_procedure_codes_endpoints.py:481: AssertionError
----------------------------- Captured stderr call -----------------------------
{"timestamp": "2026-01-18T00:35:48.535995", "level": "INFO", "logger": "httpx", "message": "HTTP Request: POST http://testserver/api/v1/procedures/test-010/codes/suggest \"HTTP/1.1 400 Bad Request\""}
------------------------------ Captured log call -------------------------------
INFO     httpx:_client.py:1025 HTTP Request: POST http://testserver/api/v1/procedures/test-010/codes/suggest "HTTP/1.1 400 Bad Request"
__________________ TestReviewEndpoint.test_accept_suggestion ___________________

self = <api.test_procedure_codes_endpoints.TestReviewEndpoint object at 0x1741e0dd0>
client = (<starlette.testclient.TestClient object at 0x1ce9c9810>, <api.test_procedure_codes_endpoints.MockLLMAdvisor object at 0x174190a90>)

    def test_accept_suggestion(self, client):
        """Test accepting a code suggestion."""
        test_client, _ = client
    
        # Generate suggestions first
        post_response = test_client.post(
            "/api/v1/procedures/test-020/codes/suggest",
            json={
                "report_text": "EBUS-TBNA performed at station 4R.",
                "use_llm": False,
            },
        )
>       assert post_response.status_code == 200
E       assert 400 == 200
E        +  where 400 = <Response [400 Bad Request]>.status_code

tests/integration/api/test_procedure_codes_endpoints.py:520: AssertionError
----------------------------- Captured stderr call -----------------------------
{"timestamp": "2026-01-18T00:35:48.548923", "level": "INFO", "logger": "httpx", "message": "HTTP Request: POST http://testserver/api/v1/procedures/test-020/codes/suggest \"HTTP/1.1 400 Bad Request\""}
------------------------------ Captured log call -------------------------------
INFO     httpx:_client.py:1025 HTTP Request: POST http://testserver/api/v1/procedures/test-020/codes/suggest "HTTP/1.1 400 Bad Request"
__________________ TestReviewEndpoint.test_reject_suggestion ___________________

self = <api.test_procedure_codes_endpoints.TestReviewEndpoint object at 0x1741e14d0>
client = (<starlette.testclient.TestClient object at 0x1890ef550>, <api.test_procedure_codes_endpoints.MockLLMAdvisor object at 0x1890ef750>)

    def test_reject_suggestion(self, client):
        """Test rejecting a code suggestion."""
        test_client, _ = client
    
        # Generate suggestions first
        post_response = test_client.post(
            "/api/v1/procedures/test-021/codes/suggest",
            json={
                "report_text": "BAL performed.",
                "use_llm": False,
            },
        )
>       assert post_response.status_code == 200
E       assert 400 == 200
E        +  where 400 = <Response [400 Bad Request]>.status_code

tests/integration/api/test_procedure_codes_endpoints.py:557: AssertionError
----------------------------- Captured stderr call -----------------------------
{"timestamp": "2026-01-18T00:35:48.559176", "level": "INFO", "logger": "httpx", "message": "HTTP Request: POST http://testserver/api/v1/procedures/test-021/codes/suggest \"HTTP/1.1 400 Bad Request\""}
------------------------------ Captured log call -------------------------------
INFO     httpx:_client.py:1025 HTTP Request: POST http://testserver/api/v1/procedures/test-021/codes/suggest "HTTP/1.1 400 Bad Request"
__________________ TestReviewEndpoint.test_modify_suggestion ___________________

self = <api.test_procedure_codes_endpoints.TestReviewEndpoint object at 0x1741e1bd0>
client = (<starlette.testclient.TestClient object at 0x1cee3f310>, <api.test_procedure_codes_endpoints.MockLLMAdvisor object at 0x1890ef7d0>)

    def test_modify_suggestion(self, client):
        """Test modifying a code suggestion."""
        test_client, _ = client
    
        # Generate suggestions first
        post_response = test_client.post(
            "/api/v1/procedures/test-022/codes/suggest",
            json={
                "report_text": "EBUS performed at station 4R.",
                "use_llm": False,
            },
        )
>       assert post_response.status_code == 200
E       assert 400 == 200
E        +  where 400 = <Response [400 Bad Request]>.status_code

tests/integration/api/test_procedure_codes_endpoints.py:593: AssertionError
----------------------------- Captured stderr call -----------------------------
{"timestamp": "2026-01-18T00:35:48.568760", "level": "INFO", "logger": "httpx", "message": "HTTP Request: POST http://testserver/api/v1/procedures/test-022/codes/suggest \"HTTP/1.1 400 Bad Request\""}
------------------------------ Captured log call -------------------------------
INFO     httpx:_client.py:1025 HTTP Request: POST http://testserver/api/v1/procedures/test-022/codes/suggest "HTTP/1.1 400 Bad Request"
_____________ TestFinalCodesEndpoint.test_final_codes_after_accept _____________

self = <api.test_procedure_codes_endpoints.TestFinalCodesEndpoint object at 0x1741e3250>
client = (<starlette.testclient.TestClient object at 0x189133550>, <api.test_procedure_codes_endpoints.MockLLMAdvisor object at 0x1cee3dc10>)

    def test_final_codes_after_accept(self, client):
        """Test final codes are populated after accepting suggestions."""
        test_client, _ = client
    
        # Generate and accept a suggestion
        post_response = test_client.post(
            "/api/v1/procedures/test-030/codes/suggest",
            json={
                "report_text": "EBUS-TBNA at station 4R. BAL performed.",
                "use_llm": False,
            },
        )
>       assert post_response.status_code == 200
E       assert 400 == 200
E        +  where 400 = <Response [400 Bad Request]>.status_code

tests/integration/api/test_procedure_codes_endpoints.py:674: AssertionError
----------------------------- Captured stderr call -----------------------------
{"timestamp": "2026-01-18T00:35:48.587231", "level": "INFO", "logger": "httpx", "message": "HTTP Request: POST http://testserver/api/v1/procedures/test-030/codes/suggest \"HTTP/1.1 400 Bad Request\""}
------------------------------ Captured log call -------------------------------
INFO     httpx:_client.py:1025 HTTP Request: POST http://testserver/api/v1/procedures/test-030/codes/suggest "HTTP/1.1 400 Bad Request"
_______________ TestMetricsEndpoint.test_metrics_after_workflow ________________

self = <api.test_procedure_codes_endpoints.TestMetricsEndpoint object at 0x1741e4a50>
client = (<starlette.testclient.TestClient object at 0x1cef86750>, <api.test_procedure_codes_endpoints.MockLLMAdvisor object at 0x10ba70c50>)

    def test_metrics_after_workflow(self, client):
        """Test metrics calculation after full workflow."""
        test_client, _ = client
    
        # Generate suggestions
        post_response = test_client.post(
            "/api/v1/procedures/test-050/codes/suggest",
            json={
                "report_text": "EBUS-TBNA at station 4R. BAL performed.",
                "use_llm": False,
            },
        )
>       suggestions = post_response.json()["suggestions"]
                      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E       KeyError: 'suggestions'

tests/integration/api/test_procedure_codes_endpoints.py:761: KeyError
----------------------------- Captured stderr call -----------------------------
{"timestamp": "2026-01-18T00:35:48.608754", "level": "INFO", "logger": "httpx", "message": "HTTP Request: POST http://testserver/api/v1/procedures/test-050/codes/suggest \"HTTP/1.1 400 Bad Request\""}
------------------------------ Captured log call -------------------------------
INFO     httpx:_client.py:1025 HTTP Request: POST http://testserver/api/v1/procedures/test-050/codes/suggest "HTTP/1.1 400 Bad Request"
________________ TestFullWorkflow.test_complete_coding_workflow ________________

self = <api.test_procedure_codes_endpoints.TestFullWorkflow object at 0x1741e5310>
client = (<starlette.testclient.TestClient object at 0x189126550>, <api.test_procedure_codes_endpoints.MockLLMAdvisor object at 0x1cede02d0>)

    def test_complete_coding_workflow(self, client):
        """Test complete suggest  review  final workflow."""
        test_client, llm_advisor = client
    
        # Configure LLM to suggest additional codes
        llm_advisor.set_suggestions({"31652": 0.95, "31627": 0.88})
    
        # Step 1: Generate suggestions
        suggest_response = test_client.post(
            "/api/v1/procedures/test-100/codes/suggest",
            json={
                "report_text": """
                PROCEDURE NOTE
    
                Indication: Lung mass, suspected malignancy
    
                Procedure: Flexible bronchoscopy with EBUS-TBNA and navigation
    
                Findings:
                - EBUS-TBNA performed at lymph node stations 4R and 7
                - Electromagnetic navigation used to access peripheral lesion
                - Samples sent to pathology
    
                Impression: Successful bronchoscopy with staging and biopsy
                """,
                "use_llm": True,
            },
        )
    
>       assert suggest_response.status_code == 200
E       assert 400 == 200
E        +  where 400 = <Response [400 Bad Request]>.status_code

tests/integration/api/test_procedure_codes_endpoints.py:832: AssertionError
----------------------------- Captured stderr call -----------------------------
{"timestamp": "2026-01-18T00:35:48.617918", "level": "INFO", "logger": "httpx", "message": "HTTP Request: POST http://testserver/api/v1/procedures/test-100/codes/suggest \"HTTP/1.1 400 Bad Request\""}
------------------------------ Captured log call -------------------------------
INFO     httpx:_client.py:1025 HTTP Request: POST http://testserver/api/v1/procedures/test-100/codes/suggest "HTTP/1.1 400 Bad Request"
___________ TestFullWorkflow.test_rules_only_mode_works_without_llm ____________

self = <api.test_procedure_codes_endpoints.TestFullWorkflow object at 0x1741e1a50>
client = (<starlette.testclient.TestClient object at 0x189126a10>, <api.test_procedure_codes_endpoints.MockLLMAdvisor object at 0x1891249d0>)

    def test_rules_only_mode_works_without_llm(self, client):
        """Verify rules_only mode doesn't require LLM."""
        test_client, llm_advisor = client
    
        # Even with LLM configured to return codes, use_llm=False should ignore it
        llm_advisor.set_suggestions({"99999": 0.99})  # Invalid code
    
        response = test_client.post(
            "/api/v1/procedures/test-101/codes/suggest",
            json={
                "report_text": "BAL performed. Thoracentesis with ultrasound guidance.",
                "use_llm": False,
            },
        )
    
>       assert response.status_code == 200
E       assert 400 == 200
E        +  where 400 = <Response [400 Bad Request]>.status_code

tests/integration/api/test_procedure_codes_endpoints.py:902: AssertionError
----------------------------- Captured stderr call -----------------------------
{"timestamp": "2026-01-18T00:35:48.627810", "level": "INFO", "logger": "httpx", "message": "HTTP Request: POST http://testserver/api/v1/procedures/test-101/codes/suggest \"HTTP/1.1 400 Bad Request\""}
------------------------------ Captured log call -------------------------------
INFO     httpx:_client.py:1025 HTTP Request: POST http://testserver/api/v1/procedures/test-101/codes/suggest "HTTP/1.1 400 Bad Request"
___ TestRegistryExportFullWorkflow.test_full_workflow_suggest_review_export ____

self = <api.test_registry_endpoints.TestRegistryExportFullWorkflow object at 0x1741f2890>
client = (<starlette.testclient.TestClient object at 0x18827fbd0>, <modules.coder.adapters.persistence.inmemory_procedure_store.InMemoryProcedureStore object at 0x18827d290>)

    def test_full_workflow_suggest_review_export(self, client):
        """Test complete workflow: suggest  review  export."""
        from tests.integration.api.test_procedure_codes_endpoints import (
            create_mock_coding_service,
            MockLLMAdvisor,
            mock_apply_ncci_edits,
            mock_apply_mer_rules,
        )
    
        http_client, store = client
        proc_id = "test-workflow-001"
    
        # Setup mock coding service
        mock_llm = MockLLMAdvisor(codes_to_return={"31652": 0.9})
        mock_service = create_mock_coding_service(mock_llm)
        app.dependency_overrides[get_coding_service] = lambda: mock_service
    
        with patch("modules.coder.application.coding_service.apply_ncci_edits", mock_apply_ncci_edits), \
             patch("modules.coder.application.coding_service.apply_mer_rules", mock_apply_mer_rules):
    
            # Step 1: Suggest codes
            suggest_response = http_client.post(
                f"/api/v1/procedures/{proc_id}/codes/suggest",
                json={
                    "report_text": "EBUS-TBNA performed at station 4R.",
                    "use_llm": False,
                },
            )
>           assert suggest_response.status_code == 200
E           assert 400 == 200
E            +  where 400 = <Response [400 Bad Request]>.status_code

tests/integration/api/test_registry_endpoints.py:387: AssertionError
---------------------------- Captured stderr setup -----------------------------
{"timestamp": "2026-01-18T00:35:48.674144", "level": "WARNING", "logger": "ner.inference", "message": "GranularNERPredictor unavailable: Model directory not found: artifacts/granular_ner_model"}
{"timestamp": "2026-01-18T00:35:48.674252", "level": "INFO", "logger": "coder.parallel_pathway", "message": "ParallelPathwayOrchestrator initialized: NER=unavailable, ML=unavailable"}
------------------------------ Captured log setup ------------------------------
WARNING  ner.inference:inference.py:150 GranularNERPredictor unavailable: Model directory not found: artifacts/granular_ner_model
INFO     coder.parallel_pathway:orchestrator.py:157 ParallelPathwayOrchestrator initialized: NER=unavailable, ML=unavailable
----------------------------- Captured stderr call -----------------------------
{"timestamp": "2026-01-18T00:35:48.679881", "level": "INFO", "logger": "httpx", "message": "HTTP Request: POST http://testserver/api/v1/procedures/test-workflow-001/codes/suggest \"HTTP/1.1 400 Bad Request\""}
------------------------------ Captured log call -------------------------------
INFO     httpx:_client.py:1025 HTTP Request: POST http://testserver/api/v1/procedures/test-workflow-001/codes/suggest "HTTP/1.1 400 Bad Request"
________ test_audit_compare_report_computes_missing_sets_and_high_conf _________

monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x1cf2d1810>

    def test_audit_compare_report_computes_missing_sets_and_high_conf(
        monkeypatch: pytest.MonkeyPatch,
    ) -> None:
        monkeypatch.setenv("PROCSUITE_PIPELINE_MODE", "extraction_first")
        monkeypatch.setenv("REGISTRY_AUDITOR_SOURCE", "raw_ml")
        monkeypatch.setenv("REGISTRY_ML_AUDIT_USE_BUCKETS", "1")
        monkeypatch.setenv("REGISTRY_ML_AUDIT_TOP_K", "7")
        monkeypatch.setenv("REGISTRY_ML_AUDIT_MIN_PROB", "0.42")
        monkeypatch.setenv("REGISTRY_ML_SELF_CORRECT_MIN_PROB", "0.95")
    
        # Guardrails: orchestrator/rules must never be invoked for audit compare.
        from modules.coder.application.smart_hybrid_policy import SmartHybridOrchestrator
        from modules.coder.rules_engine import CodingRulesEngine
    
        monkeypatch.setattr(SmartHybridOrchestrator, "get_codes", _raise)
        monkeypatch.setattr(CodingRulesEngine, "validate", _raise)
    
        # Deterministic derivation: derive 31624 via BAL performed.
        record = RegistryRecord(procedures_performed={"bal": {"performed": True}})
        engine = _StubRegistryEngine(record)
    
        # RAW-ML: high-conf suggests IPC (32550), but deterministic derivation misses it.
        from modules.ml_coder.predictor import CaseClassification, CodePrediction, MLCoderPredictor
        from modules.ml_coder.thresholds import CaseDifficulty
    
        classify_calls: list[str] = []
    
        monkeypatch.setattr(MLCoderPredictor, "__init__", lambda self, *a, **k: None)
    
        def _fake_classify_case(self, note_text: str):  # type: ignore[no-untyped-def]
            classify_calls.append(note_text)
            return CaseClassification(
                predictions=[CodePrediction(cpt="32550", prob=0.97)],
                high_conf=[CodePrediction(cpt="32550", prob=0.97)],
                gray_zone=[],
                difficulty=CaseDifficulty.HIGH_CONF,
            )
    
        monkeypatch.setattr(MLCoderPredictor, "classify_case", _fake_classify_case)
    
        service = RegistryService(
            hybrid_orchestrator=MagicMock(),
            registry_engine=engine,
        )
    
        raw_note = "HPI: Mentions tunneled pleural catheter.\n\nPROCEDURE: BAL performed."
        result = service.extract_fields(raw_note)
    
        assert classify_calls == [raw_note]
        assert result.audit_report is not None
    
        report = result.audit_report
>       assert report.derived_codes == ["31624"]
E       AssertionError: assert ['32550'] == ['31624']
E         
E         At index 0 diff: '32550' != '31624'
E         Use -v to get more diff

tests/registry/test_audit_compare_report.py:75: AssertionError
----------------------------- Captured stderr call -----------------------------
{"timestamp": "2026-01-18T00:35:56.957532", "level": "WARNING", "logger": "ner.inference", "message": "GranularNERPredictor unavailable: Model directory not found: artifacts/granular_ner_model"}
{"timestamp": "2026-01-18T00:35:56.957691", "level": "INFO", "logger": "coder.parallel_pathway", "message": "ParallelPathwayOrchestrator initialized: NER=unavailable, ML=unavailable"}
{"timestamp": "2026-01-18T00:35:57.003277", "level": "WARNING", "logger": "registry.inference_pytorch", "message": "TorchRegistryPredictor unavailable: Unrecognized model in data/models/registry_runtime. Should have a `model_type` key in its config.json, or contain one of the following strings in its name: albert, align, altclip, arcee, aria, aria_text, audio-spectrogram-transformer, autoformer, aya_vision, bamba, bark, bart, beit, bert, bert-generation, big_bird, bigbird_pegasus, biogpt, bit, bitnet, blenderbot, blenderbot-small, blip, blip-2, blip_2_qformer, bloom, bridgetower, bros, camembert, canine, chameleon, chinese_clip, chinese_clip_vision_model, clap, clip, clip_text_model, clip_vision_model, clipseg, clvp, code_llama, codegen, cohere, cohere2, colpali, colqwen2, conditional_detr, convbert, convnext, convnextv2, cpmant, csm, ctrl, cvt, d_fine, dab-detr, dac, data2vec-audio, data2vec-text, data2vec-vision, dbrx, deberta, deberta-v2, decision_transformer, deepseek_v3, deformable_detr, deit, depth_anything, depth_pro, deta, detr, dia, diffllama, dinat, dinov2, dinov2_with_registers, distilbert, donut-swin, dots1, dpr, dpt, efficientformer, efficientnet, electra, emu3, encodec, encoder-decoder, ernie, ernie_m, esm, falcon, falcon_h1, falcon_mamba, fastspeech2_conformer, flaubert, flava, fnet, focalnet, fsmt, funnel, fuyu, gemma, gemma2, gemma3, gemma3_text, gemma3n, gemma3n_audio, gemma3n_text, gemma3n_vision, git, glm, glm4, glm4v, glm4v_text, glpn, got_ocr2, gpt-sw3, gpt2, gpt_bigcode, gpt_neo, gpt_neox, gpt_neox_japanese, gptj, gptsan-japanese, granite, granite_speech, granitemoe, granitemoehybrid, granitemoeshared, granitevision, graphormer, grounding-dino, groupvit, helium, hgnet_v2, hiera, hubert, ibert, idefics, idefics2, idefics3, idefics3_vision, ijepa, imagegpt, informer, instructblip, instructblipvideo, internvl, internvl_vision, jamba, janus, jetmoe, jukebox, kosmos-2, kyutai_speech_to_text, layoutlm, layoutlmv2, layoutlmv3, led, levit, lightglue, lilt, llama, llama4, llama4_text, llava, llava_next, llava_next_video, llava_onevision, longformer, longt5, luke, lxmert, m2m_100, mamba, mamba2, marian, markuplm, mask2former, maskformer, maskformer-swin, mbart, mctct, mega, megatron-bert, mgp-str, mimi, minimax, mistral, mistral3, mixtral, mlcd, mllama, mobilebert, mobilenet_v1, mobilenet_v2, mobilevit, mobilevitv2, modernbert, moonshine, moshi, mpnet, mpt, mra, mt5, musicgen, musicgen_melody, mvp, nat, nemotron, nezha, nllb-moe, nougat, nystromformer, olmo, olmo2, olmoe, omdet-turbo, oneformer, open-llama, openai-gpt, opt, owlv2, owlvit, paligemma, patchtsmixer, patchtst, pegasus, pegasus_x, perceiver, persimmon, phi, phi3, phi4_multimodal, phimoe, pix2struct, pixtral, plbart, poolformer, pop2piano, prompt_depth_anything, prophetnet, pvt, pvt_v2, qdqbert, qwen2, qwen2_5_omni, qwen2_5_vl, qwen2_5_vl_text, qwen2_audio, qwen2_audio_encoder, qwen2_moe, qwen2_vl, qwen2_vl_text, qwen3, qwen3_moe, rag, realm, recurrent_gemma, reformer, regnet, rembert, resnet, retribert, roberta, roberta-prelayernorm, roc_bert, roformer, rt_detr, rt_detr_resnet, rt_detr_v2, rwkv, sam, sam_hq, sam_hq_vision_model, sam_vision_model, seamless_m4t, seamless_m4t_v2, segformer, seggpt, sew, sew-d, shieldgemma2, siglip, siglip2, siglip_vision_model, smollm3, smolvlm, smolvlm_vision, speech-encoder-decoder, speech_to_text, speech_to_text_2, speecht5, splinter, squeezebert, stablelm, starcoder2, superglue, superpoint, swiftformer, swin, swin2sr, swinv2, switch_transformers, t5, t5gemma, table-transformer, tapas, textnet, time_series_transformer, timesfm, timesformer, timm_backbone, timm_wrapper, trajectory_transformer, transfo-xl, trocr, tvlt, tvp, udop, umt5, unispeech, unispeech-sat, univnet, upernet, van, video_llava, videomae, vilt, vipllava, vision-encoder-decoder, vision-text-dual-encoder, visual_bert, vit, vit_hybrid, vit_mae, vit_msn, vitdet, vitmatte, vitpose, vitpose_backbone, vits, vivit, vjepa2, wav2vec2, wav2vec2-bert, wav2vec2-conformer, wavlm, whisper, xclip, xglm, xlm, xlm-prophetnet, xlm-roberta, xlm-roberta-xl, xlnet, xmod, yolos, yoso, zamba, zamba2, zoedepth"}
{"timestamp": "2026-01-18T00:35:57.003398", "level": "INFO", "logger": "ml_coder.registry_predictor", "message": "Loading registry model from data/models/registry_classifier.pkl"}
{"timestamp": "2026-01-18T00:35:57.037607", "level": "INFO", "logger": "ml_coder.registry_predictor", "message": "Loaded 21 labels from MLB"}
{"timestamp": "2026-01-18T00:35:57.037882", "level": "INFO", "logger": "ml_coder.registry_predictor", "message": "RegistryMLPredictor initialized with 21 labels"}
{"timestamp": "2026-01-18T00:35:57.037944", "level": "INFO", "logger": "registry_service", "message": "Using RegistryMLPredictor (TF-IDF) with 21 labels"}
{"timestamp": "2026-01-18T00:35:57.067164", "level": "WARNING", "logger": "coder.parallel_pathway", "message": "Path B failed: 'list' object has no attribute 'predictions'"}
------------------------------ Captured log call -------------------------------
WARNING  ner.inference:inference.py:150 GranularNERPredictor unavailable: Model directory not found: artifacts/granular_ner_model
INFO     coder.parallel_pathway:orchestrator.py:157 ParallelPathwayOrchestrator initialized: NER=unavailable, ML=unavailable
WARNING  registry.inference_pytorch:inference_pytorch.py:78 TorchRegistryPredictor unavailable: Unrecognized model in data/models/registry_runtime. Should have a `model_type` key in its config.json, or contain one of the following strings in its name: albert, align, altclip, arcee, aria, aria_text, audio-spectrogram-transformer, autoformer, aya_vision, bamba, bark, bart, beit, bert, bert-generation, big_bird, bigbird_pegasus, biogpt, bit, bitnet, blenderbot, blenderbot-small, blip, blip-2, blip_2_qformer, bloom, bridgetower, bros, camembert, canine, chameleon, chinese_clip, chinese_clip_vision_model, clap, clip, clip_text_model, clip_vision_model, clipseg, clvp, code_llama, codegen, cohere, cohere2, colpali, colqwen2, conditional_detr, convbert, convnext, convnextv2, cpmant, csm, ctrl, cvt, d_fine, dab-detr, dac, data2vec-audio, data2vec-text, data2vec-vision, dbrx, deberta, deberta-v2, decision_transformer, deepseek_v3, deformable_detr, deit, depth_anything, depth_pro, deta, detr, dia, diffllama, dinat, dinov2, dinov2_with_registers, distilbert, donut-swin, dots1, dpr, dpt, efficientformer, efficientnet, electra, emu3, encodec, encoder-decoder, ernie, ernie_m, esm, falcon, falcon_h1, falcon_mamba, fastspeech2_conformer, flaubert, flava, fnet, focalnet, fsmt, funnel, fuyu, gemma, gemma2, gemma3, gemma3_text, gemma3n, gemma3n_audio, gemma3n_text, gemma3n_vision, git, glm, glm4, glm4v, glm4v_text, glpn, got_ocr2, gpt-sw3, gpt2, gpt_bigcode, gpt_neo, gpt_neox, gpt_neox_japanese, gptj, gptsan-japanese, granite, granite_speech, granitemoe, granitemoehybrid, granitemoeshared, granitevision, graphormer, grounding-dino, groupvit, helium, hgnet_v2, hiera, hubert, ibert, idefics, idefics2, idefics3, idefics3_vision, ijepa, imagegpt, informer, instructblip, instructblipvideo, internvl, internvl_vision, jamba, janus, jetmoe, jukebox, kosmos-2, kyutai_speech_to_text, layoutlm, layoutlmv2, layoutlmv3, led, levit, lightglue, lilt, llama, llama4, llama4_text, llava, llava_next, llava_next_video, llava_onevision, longformer, longt5, luke, lxmert, m2m_100, mamba, mamba2, marian, markuplm, mask2former, maskformer, maskformer-swin, mbart, mctct, mega, megatron-bert, mgp-str, mimi, minimax, mistral, mistral3, mixtral, mlcd, mllama, mobilebert, mobilenet_v1, mobilenet_v2, mobilevit, mobilevitv2, modernbert, moonshine, moshi, mpnet, mpt, mra, mt5, musicgen, musicgen_melody, mvp, nat, nemotron, nezha, nllb-moe, nougat, nystromformer, olmo, olmo2, olmoe, omdet-turbo, oneformer, open-llama, openai-gpt, opt, owlv2, owlvit, paligemma, patchtsmixer, patchtst, pegasus, pegasus_x, perceiver, persimmon, phi, phi3, phi4_multimodal, phimoe, pix2struct, pixtral, plbart, poolformer, pop2piano, prompt_depth_anything, prophetnet, pvt, pvt_v2, qdqbert, qwen2, qwen2_5_omni, qwen2_5_vl, qwen2_5_vl_text, qwen2_audio, qwen2_audio_encoder, qwen2_moe, qwen2_vl, qwen2_vl_text, qwen3, qwen3_moe, rag, realm, recurrent_gemma, reformer, regnet, rembert, resnet, retribert, roberta, roberta-prelayernorm, roc_bert, roformer, rt_detr, rt_detr_resnet, rt_detr_v2, rwkv, sam, sam_hq, sam_hq_vision_model, sam_vision_model, seamless_m4t, seamless_m4t_v2, segformer, seggpt, sew, sew-d, shieldgemma2, siglip, siglip2, siglip_vision_model, smollm3, smolvlm, smolvlm_vision, speech-encoder-decoder, speech_to_text, speech_to_text_2, speecht5, splinter, squeezebert, stablelm, starcoder2, superglue, superpoint, swiftformer, swin, swin2sr, swinv2, switch_transformers, t5, t5gemma, table-transformer, tapas, textnet, time_series_transformer, timesfm, timesformer, timm_backbone, timm_wrapper, trajectory_transformer, transfo-xl, trocr, tvlt, tvp, udop, umt5, unispeech, unispeech-sat, univnet, upernet, van, video_llava, videomae, vilt, vipllava, vision-encoder-decoder, vision-text-dual-encoder, visual_bert, vit, vit_hybrid, vit_mae, vit_msn, vitdet, vitmatte, vitpose, vitpose_backbone, vits, vivit, vjepa2, wav2vec2, wav2vec2-bert, wav2vec2-conformer, wavlm, whisper, xclip, xglm, xlm, xlm-prophetnet, xlm-roberta, xlm-roberta-xl, xlnet, xmod, yolos, yoso, zamba, zamba2, zoedepth
INFO     ml_coder.registry_predictor:registry_predictor.py:156 Loading registry model from data/models/registry_classifier.pkl
INFO     ml_coder.registry_predictor:registry_predictor.py:163 Loaded 21 labels from MLB
INFO     ml_coder.registry_predictor:registry_predictor.py:180 RegistryMLPredictor initialized with 21 labels
INFO     registry_service:registry_service.py:337 Using RegistryMLPredictor (TF-IDF) with 21 labels
WARNING  coder.parallel_pathway:orchestrator.py:430 Path B failed: 'list' object has no attribute 'predictions'
___________ test_audit_compare_report_created_when_auditor_disabled ____________

monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x1cf123d50>

    def test_audit_compare_report_created_when_auditor_disabled(
        monkeypatch: pytest.MonkeyPatch,
    ) -> None:
        monkeypatch.setenv("PROCSUITE_PIPELINE_MODE", "extraction_first")
        monkeypatch.setenv("REGISTRY_AUDITOR_SOURCE", "disabled")
        monkeypatch.setenv("REGISTRY_ML_AUDIT_USE_BUCKETS", "1")
        monkeypatch.setenv("REGISTRY_ML_AUDIT_TOP_K", "9")
        monkeypatch.setenv("REGISTRY_ML_AUDIT_MIN_PROB", "0.11")
        monkeypatch.setenv("REGISTRY_ML_SELF_CORRECT_MIN_PROB", "0.91")
    
        # Guardrails: orchestrator/rules must never be invoked for audit compare.
        from modules.coder.application.smart_hybrid_policy import SmartHybridOrchestrator
        from modules.coder.rules_engine import CodingRulesEngine
    
        monkeypatch.setattr(SmartHybridOrchestrator, "get_codes", _raise)
        monkeypatch.setattr(CodingRulesEngine, "validate", _raise)
    
        # RAW-ML must not run when auditor is disabled.
        from modules.ml_coder.predictor import MLCoderPredictor
    
        monkeypatch.setattr(MLCoderPredictor, "classify_case", _raise)
    
        record = RegistryRecord(procedures_performed={"bal": {"performed": True}})
        service = RegistryService(
            hybrid_orchestrator=MagicMock(),
            registry_engine=_StubRegistryEngine(record),
        )
    
        result = service.extract_fields("PROCEDURE: BAL performed.")
        assert result.audit_report is not None
    
        report = result.audit_report
        assert report.ml_audit_codes == []
        assert report.missing_in_derived == []
        assert report.high_conf_omissions == []
>       assert report.missing_in_ml == ["31624"]
E       AssertionError: assert [] == ['31624']
E         
E         Right contains one more item: '31624'
E         Use -v to get more diff

tests/registry/test_audit_compare_report.py:125: AssertionError
----------------------------- Captured stderr call -----------------------------
{"timestamp": "2026-01-18T00:35:57.076696", "level": "WARNING", "logger": "ner.inference", "message": "GranularNERPredictor unavailable: Model directory not found: artifacts/granular_ner_model"}
{"timestamp": "2026-01-18T00:35:57.076817", "level": "INFO", "logger": "coder.parallel_pathway", "message": "ParallelPathwayOrchestrator initialized: NER=unavailable, ML=unavailable"}
{"timestamp": "2026-01-18T00:35:57.094205", "level": "WARNING", "logger": "registry.inference_pytorch", "message": "TorchRegistryPredictor unavailable: Unrecognized model in data/models/registry_runtime. Should have a `model_type` key in its config.json, or contain one of the following strings in its name: albert, align, altclip, arcee, aria, aria_text, audio-spectrogram-transformer, autoformer, aya_vision, bamba, bark, bart, beit, bert, bert-generation, big_bird, bigbird_pegasus, biogpt, bit, bitnet, blenderbot, blenderbot-small, blip, blip-2, blip_2_qformer, bloom, bridgetower, bros, camembert, canine, chameleon, chinese_clip, chinese_clip_vision_model, clap, clip, clip_text_model, clip_vision_model, clipseg, clvp, code_llama, codegen, cohere, cohere2, colpali, colqwen2, conditional_detr, convbert, convnext, convnextv2, cpmant, csm, ctrl, cvt, d_fine, dab-detr, dac, data2vec-audio, data2vec-text, data2vec-vision, dbrx, deberta, deberta-v2, decision_transformer, deepseek_v3, deformable_detr, deit, depth_anything, depth_pro, deta, detr, dia, diffllama, dinat, dinov2, dinov2_with_registers, distilbert, donut-swin, dots1, dpr, dpt, efficientformer, efficientnet, electra, emu3, encodec, encoder-decoder, ernie, ernie_m, esm, falcon, falcon_h1, falcon_mamba, fastspeech2_conformer, flaubert, flava, fnet, focalnet, fsmt, funnel, fuyu, gemma, gemma2, gemma3, gemma3_text, gemma3n, gemma3n_audio, gemma3n_text, gemma3n_vision, git, glm, glm4, glm4v, glm4v_text, glpn, got_ocr2, gpt-sw3, gpt2, gpt_bigcode, gpt_neo, gpt_neox, gpt_neox_japanese, gptj, gptsan-japanese, granite, granite_speech, granitemoe, granitemoehybrid, granitemoeshared, granitevision, graphormer, grounding-dino, groupvit, helium, hgnet_v2, hiera, hubert, ibert, idefics, idefics2, idefics3, idefics3_vision, ijepa, imagegpt, informer, instructblip, instructblipvideo, internvl, internvl_vision, jamba, janus, jetmoe, jukebox, kosmos-2, kyutai_speech_to_text, layoutlm, layoutlmv2, layoutlmv3, led, levit, lightglue, lilt, llama, llama4, llama4_text, llava, llava_next, llava_next_video, llava_onevision, longformer, longt5, luke, lxmert, m2m_100, mamba, mamba2, marian, markuplm, mask2former, maskformer, maskformer-swin, mbart, mctct, mega, megatron-bert, mgp-str, mimi, minimax, mistral, mistral3, mixtral, mlcd, mllama, mobilebert, mobilenet_v1, mobilenet_v2, mobilevit, mobilevitv2, modernbert, moonshine, moshi, mpnet, mpt, mra, mt5, musicgen, musicgen_melody, mvp, nat, nemotron, nezha, nllb-moe, nougat, nystromformer, olmo, olmo2, olmoe, omdet-turbo, oneformer, open-llama, openai-gpt, opt, owlv2, owlvit, paligemma, patchtsmixer, patchtst, pegasus, pegasus_x, perceiver, persimmon, phi, phi3, phi4_multimodal, phimoe, pix2struct, pixtral, plbart, poolformer, pop2piano, prompt_depth_anything, prophetnet, pvt, pvt_v2, qdqbert, qwen2, qwen2_5_omni, qwen2_5_vl, qwen2_5_vl_text, qwen2_audio, qwen2_audio_encoder, qwen2_moe, qwen2_vl, qwen2_vl_text, qwen3, qwen3_moe, rag, realm, recurrent_gemma, reformer, regnet, rembert, resnet, retribert, roberta, roberta-prelayernorm, roc_bert, roformer, rt_detr, rt_detr_resnet, rt_detr_v2, rwkv, sam, sam_hq, sam_hq_vision_model, sam_vision_model, seamless_m4t, seamless_m4t_v2, segformer, seggpt, sew, sew-d, shieldgemma2, siglip, siglip2, siglip_vision_model, smollm3, smolvlm, smolvlm_vision, speech-encoder-decoder, speech_to_text, speech_to_text_2, speecht5, splinter, squeezebert, stablelm, starcoder2, superglue, superpoint, swiftformer, swin, swin2sr, swinv2, switch_transformers, t5, t5gemma, table-transformer, tapas, textnet, time_series_transformer, timesfm, timesformer, timm_backbone, timm_wrapper, trajectory_transformer, transfo-xl, trocr, tvlt, tvp, udop, umt5, unispeech, unispeech-sat, univnet, upernet, van, video_llava, videomae, vilt, vipllava, vision-encoder-decoder, vision-text-dual-encoder, visual_bert, vit, vit_hybrid, vit_mae, vit_msn, vitdet, vitmatte, vitpose, vitpose_backbone, vits, vivit, vjepa2, wav2vec2, wav2vec2-bert, wav2vec2-conformer, wavlm, whisper, xclip, xglm, xlm, xlm-prophetnet, xlm-roberta, xlm-roberta-xl, xlnet, xmod, yolos, yoso, zamba, zamba2, zoedepth"}
{"timestamp": "2026-01-18T00:35:57.094322", "level": "INFO", "logger": "ml_coder.registry_predictor", "message": "Loading registry model from data/models/registry_classifier.pkl"}
{"timestamp": "2026-01-18T00:35:57.126806", "level": "INFO", "logger": "ml_coder.registry_predictor", "message": "Loaded 21 labels from MLB"}
{"timestamp": "2026-01-18T00:35:57.126955", "level": "INFO", "logger": "ml_coder.registry_predictor", "message": "RegistryMLPredictor initialized with 21 labels"}
{"timestamp": "2026-01-18T00:35:57.126997", "level": "INFO", "logger": "registry_service", "message": "Using RegistryMLPredictor (TF-IDF) with 21 labels"}
{"timestamp": "2026-01-18T00:35:57.145807", "level": "WARNING", "logger": "coder.parallel_pathway", "message": "Path B failed: 'list' object has no attribute 'predictions'"}
------------------------------ Captured log call -------------------------------
WARNING  ner.inference:inference.py:150 GranularNERPredictor unavailable: Model directory not found: artifacts/granular_ner_model
INFO     coder.parallel_pathway:orchestrator.py:157 ParallelPathwayOrchestrator initialized: NER=unavailable, ML=unavailable
WARNING  registry.inference_pytorch:inference_pytorch.py:78 TorchRegistryPredictor unavailable: Unrecognized model in data/models/registry_runtime. Should have a `model_type` key in its config.json, or contain one of the following strings in its name: albert, align, altclip, arcee, aria, aria_text, audio-spectrogram-transformer, autoformer, aya_vision, bamba, bark, bart, beit, bert, bert-generation, big_bird, bigbird_pegasus, biogpt, bit, bitnet, blenderbot, blenderbot-small, blip, blip-2, blip_2_qformer, bloom, bridgetower, bros, camembert, canine, chameleon, chinese_clip, chinese_clip_vision_model, clap, clip, clip_text_model, clip_vision_model, clipseg, clvp, code_llama, codegen, cohere, cohere2, colpali, colqwen2, conditional_detr, convbert, convnext, convnextv2, cpmant, csm, ctrl, cvt, d_fine, dab-detr, dac, data2vec-audio, data2vec-text, data2vec-vision, dbrx, deberta, deberta-v2, decision_transformer, deepseek_v3, deformable_detr, deit, depth_anything, depth_pro, deta, detr, dia, diffllama, dinat, dinov2, dinov2_with_registers, distilbert, donut-swin, dots1, dpr, dpt, efficientformer, efficientnet, electra, emu3, encodec, encoder-decoder, ernie, ernie_m, esm, falcon, falcon_h1, falcon_mamba, fastspeech2_conformer, flaubert, flava, fnet, focalnet, fsmt, funnel, fuyu, gemma, gemma2, gemma3, gemma3_text, gemma3n, gemma3n_audio, gemma3n_text, gemma3n_vision, git, glm, glm4, glm4v, glm4v_text, glpn, got_ocr2, gpt-sw3, gpt2, gpt_bigcode, gpt_neo, gpt_neox, gpt_neox_japanese, gptj, gptsan-japanese, granite, granite_speech, granitemoe, granitemoehybrid, granitemoeshared, granitevision, graphormer, grounding-dino, groupvit, helium, hgnet_v2, hiera, hubert, ibert, idefics, idefics2, idefics3, idefics3_vision, ijepa, imagegpt, informer, instructblip, instructblipvideo, internvl, internvl_vision, jamba, janus, jetmoe, jukebox, kosmos-2, kyutai_speech_to_text, layoutlm, layoutlmv2, layoutlmv3, led, levit, lightglue, lilt, llama, llama4, llama4_text, llava, llava_next, llava_next_video, llava_onevision, longformer, longt5, luke, lxmert, m2m_100, mamba, mamba2, marian, markuplm, mask2former, maskformer, maskformer-swin, mbart, mctct, mega, megatron-bert, mgp-str, mimi, minimax, mistral, mistral3, mixtral, mlcd, mllama, mobilebert, mobilenet_v1, mobilenet_v2, mobilevit, mobilevitv2, modernbert, moonshine, moshi, mpnet, mpt, mra, mt5, musicgen, musicgen_melody, mvp, nat, nemotron, nezha, nllb-moe, nougat, nystromformer, olmo, olmo2, olmoe, omdet-turbo, oneformer, open-llama, openai-gpt, opt, owlv2, owlvit, paligemma, patchtsmixer, patchtst, pegasus, pegasus_x, perceiver, persimmon, phi, phi3, phi4_multimodal, phimoe, pix2struct, pixtral, plbart, poolformer, pop2piano, prompt_depth_anything, prophetnet, pvt, pvt_v2, qdqbert, qwen2, qwen2_5_omni, qwen2_5_vl, qwen2_5_vl_text, qwen2_audio, qwen2_audio_encoder, qwen2_moe, qwen2_vl, qwen2_vl_text, qwen3, qwen3_moe, rag, realm, recurrent_gemma, reformer, regnet, rembert, resnet, retribert, roberta, roberta-prelayernorm, roc_bert, roformer, rt_detr, rt_detr_resnet, rt_detr_v2, rwkv, sam, sam_hq, sam_hq_vision_model, sam_vision_model, seamless_m4t, seamless_m4t_v2, segformer, seggpt, sew, sew-d, shieldgemma2, siglip, siglip2, siglip_vision_model, smollm3, smolvlm, smolvlm_vision, speech-encoder-decoder, speech_to_text, speech_to_text_2, speecht5, splinter, squeezebert, stablelm, starcoder2, superglue, superpoint, swiftformer, swin, swin2sr, swinv2, switch_transformers, t5, t5gemma, table-transformer, tapas, textnet, time_series_transformer, timesfm, timesformer, timm_backbone, timm_wrapper, trajectory_transformer, transfo-xl, trocr, tvlt, tvp, udop, umt5, unispeech, unispeech-sat, univnet, upernet, van, video_llava, videomae, vilt, vipllava, vision-encoder-decoder, vision-text-dual-encoder, visual_bert, vit, vit_hybrid, vit_mae, vit_msn, vitdet, vitmatte, vitpose, vitpose_backbone, vits, vivit, vjepa2, wav2vec2, wav2vec2-bert, wav2vec2-conformer, wavlm, whisper, xclip, xglm, xlm, xlm-prophetnet, xlm-roberta, xlm-roberta-xl, xlnet, xmod, yolos, yoso, zamba, zamba2, zoedepth
INFO     ml_coder.registry_predictor:registry_predictor.py:156 Loading registry model from data/models/registry_classifier.pkl
INFO     ml_coder.registry_predictor:registry_predictor.py:163 Loaded 21 labels from MLB
INFO     ml_coder.registry_predictor:registry_predictor.py:180 RegistryMLPredictor initialized with 21 labels
INFO     registry_service:registry_service.py:337 Using RegistryMLPredictor (TF-IDF) with 21 labels
WARNING  coder.parallel_pathway:orchestrator.py:430 Path B failed: 'list' object has no attribute 'predictions'
__________ test_extraction_first_does_not_consult_cpt_or_orchestrator __________

monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x189057750>

    def test_extraction_first_does_not_consult_cpt_or_orchestrator(monkeypatch: pytest.MonkeyPatch) -> None:
        monkeypatch.setenv("PROCSUITE_PIPELINE_MODE", "extraction_first")
        monkeypatch.setenv("REGISTRY_AUDITOR_SOURCE", "raw_ml")
    
        engine = _AssertingRegistryEngine()
    
        orchestrator = MagicMock()
        orchestrator.get_codes.side_effect = RuntimeError("orchestrator called (should not happen)")
    
        service = RegistryService(hybrid_orchestrator=orchestrator, registry_engine=engine)
    
        # Guard against CPT-seeded merge in extraction-first mode.
        monkeypatch.setattr(
            service,
            "_merge_cpt_fields_into_record",
            lambda *args, **kwargs: (_ for _ in ()).throw(RuntimeError("_merge_cpt_fields_into_record called")),
        )
    
        # Stub RAW-ML predictor so the extraction-first path can complete once implemented.
        from modules.ml_coder.predictor import CaseClassification, MLCoderPredictor
        from modules.ml_coder.thresholds import CaseDifficulty
    
        monkeypatch.setattr(MLCoderPredictor, "__init__", lambda self, *a, **k: None)
        monkeypatch.setattr(
            MLCoderPredictor,
            "classify_case",
            lambda self, raw_note_text: CaseClassification(
                predictions=[],
                high_conf=[],
                gray_zone=[],
                difficulty=CaseDifficulty.LOW_CONF,
            ),
        )
    
        result = service.extract_fields("Synthetic note text describing a bronchoscopy procedure.")
    
        # The test is primarily a call-graph guardrail:
        # - No orchestrator
        # - No CPT merge
        # - No CPT hints passed into extraction
        assert orchestrator.get_codes.call_count == 0
>       assert engine.calls, "expected extractor to run"
E       AssertionError: expected extractor to run
E       assert []
E        +  where [] = <test_extraction_first_flow._AssertingRegistryEngine object at 0x1cf29e250>.calls

tests/registry/test_extraction_first_flow.py:66: AssertionError
----------------------------- Captured stderr call -----------------------------
{"timestamp": "2026-01-18T00:35:57.305762", "level": "WARNING", "logger": "ner.inference", "message": "GranularNERPredictor unavailable: Model directory not found: artifacts/granular_ner_model"}
{"timestamp": "2026-01-18T00:35:57.305844", "level": "INFO", "logger": "coder.parallel_pathway", "message": "ParallelPathwayOrchestrator initialized: NER=unavailable, ML=unavailable"}
{"timestamp": "2026-01-18T00:35:57.322464", "level": "WARNING", "logger": "registry.inference_pytorch", "message": "TorchRegistryPredictor unavailable: Unrecognized model in data/models/registry_runtime. Should have a `model_type` key in its config.json, or contain one of the following strings in its name: albert, align, altclip, arcee, aria, aria_text, audio-spectrogram-transformer, autoformer, aya_vision, bamba, bark, bart, beit, bert, bert-generation, big_bird, bigbird_pegasus, biogpt, bit, bitnet, blenderbot, blenderbot-small, blip, blip-2, blip_2_qformer, bloom, bridgetower, bros, camembert, canine, chameleon, chinese_clip, chinese_clip_vision_model, clap, clip, clip_text_model, clip_vision_model, clipseg, clvp, code_llama, codegen, cohere, cohere2, colpali, colqwen2, conditional_detr, convbert, convnext, convnextv2, cpmant, csm, ctrl, cvt, d_fine, dab-detr, dac, data2vec-audio, data2vec-text, data2vec-vision, dbrx, deberta, deberta-v2, decision_transformer, deepseek_v3, deformable_detr, deit, depth_anything, depth_pro, deta, detr, dia, diffllama, dinat, dinov2, dinov2_with_registers, distilbert, donut-swin, dots1, dpr, dpt, efficientformer, efficientnet, electra, emu3, encodec, encoder-decoder, ernie, ernie_m, esm, falcon, falcon_h1, falcon_mamba, fastspeech2_conformer, flaubert, flava, fnet, focalnet, fsmt, funnel, fuyu, gemma, gemma2, gemma3, gemma3_text, gemma3n, gemma3n_audio, gemma3n_text, gemma3n_vision, git, glm, glm4, glm4v, glm4v_text, glpn, got_ocr2, gpt-sw3, gpt2, gpt_bigcode, gpt_neo, gpt_neox, gpt_neox_japanese, gptj, gptsan-japanese, granite, granite_speech, granitemoe, granitemoehybrid, granitemoeshared, granitevision, graphormer, grounding-dino, groupvit, helium, hgnet_v2, hiera, hubert, ibert, idefics, idefics2, idefics3, idefics3_vision, ijepa, imagegpt, informer, instructblip, instructblipvideo, internvl, internvl_vision, jamba, janus, jetmoe, jukebox, kosmos-2, kyutai_speech_to_text, layoutlm, layoutlmv2, layoutlmv3, led, levit, lightglue, lilt, llama, llama4, llama4_text, llava, llava_next, llava_next_video, llava_onevision, longformer, longt5, luke, lxmert, m2m_100, mamba, mamba2, marian, markuplm, mask2former, maskformer, maskformer-swin, mbart, mctct, mega, megatron-bert, mgp-str, mimi, minimax, mistral, mistral3, mixtral, mlcd, mllama, mobilebert, mobilenet_v1, mobilenet_v2, mobilevit, mobilevitv2, modernbert, moonshine, moshi, mpnet, mpt, mra, mt5, musicgen, musicgen_melody, mvp, nat, nemotron, nezha, nllb-moe, nougat, nystromformer, olmo, olmo2, olmoe, omdet-turbo, oneformer, open-llama, openai-gpt, opt, owlv2, owlvit, paligemma, patchtsmixer, patchtst, pegasus, pegasus_x, perceiver, persimmon, phi, phi3, phi4_multimodal, phimoe, pix2struct, pixtral, plbart, poolformer, pop2piano, prompt_depth_anything, prophetnet, pvt, pvt_v2, qdqbert, qwen2, qwen2_5_omni, qwen2_5_vl, qwen2_5_vl_text, qwen2_audio, qwen2_audio_encoder, qwen2_moe, qwen2_vl, qwen2_vl_text, qwen3, qwen3_moe, rag, realm, recurrent_gemma, reformer, regnet, rembert, resnet, retribert, roberta, roberta-prelayernorm, roc_bert, roformer, rt_detr, rt_detr_resnet, rt_detr_v2, rwkv, sam, sam_hq, sam_hq_vision_model, sam_vision_model, seamless_m4t, seamless_m4t_v2, segformer, seggpt, sew, sew-d, shieldgemma2, siglip, siglip2, siglip_vision_model, smollm3, smolvlm, smolvlm_vision, speech-encoder-decoder, speech_to_text, speech_to_text_2, speecht5, splinter, squeezebert, stablelm, starcoder2, superglue, superpoint, swiftformer, swin, swin2sr, swinv2, switch_transformers, t5, t5gemma, table-transformer, tapas, textnet, time_series_transformer, timesfm, timesformer, timm_backbone, timm_wrapper, trajectory_transformer, transfo-xl, trocr, tvlt, tvp, udop, umt5, unispeech, unispeech-sat, univnet, upernet, van, video_llava, videomae, vilt, vipllava, vision-encoder-decoder, vision-text-dual-encoder, visual_bert, vit, vit_hybrid, vit_mae, vit_msn, vitdet, vitmatte, vitpose, vitpose_backbone, vits, vivit, vjepa2, wav2vec2, wav2vec2-bert, wav2vec2-conformer, wavlm, whisper, xclip, xglm, xlm, xlm-prophetnet, xlm-roberta, xlm-roberta-xl, xlnet, xmod, yolos, yoso, zamba, zamba2, zoedepth"}
{"timestamp": "2026-01-18T00:35:57.322573", "level": "INFO", "logger": "ml_coder.registry_predictor", "message": "Loading registry model from data/models/registry_classifier.pkl"}
{"timestamp": "2026-01-18T00:35:57.354302", "level": "INFO", "logger": "ml_coder.registry_predictor", "message": "Loaded 21 labels from MLB"}
{"timestamp": "2026-01-18T00:35:57.354434", "level": "INFO", "logger": "ml_coder.registry_predictor", "message": "RegistryMLPredictor initialized with 21 labels"}
{"timestamp": "2026-01-18T00:35:57.354471", "level": "INFO", "logger": "registry_service", "message": "Using RegistryMLPredictor (TF-IDF) with 21 labels"}
{"timestamp": "2026-01-18T00:35:57.371733", "level": "WARNING", "logger": "coder.parallel_pathway", "message": "Path B failed: 'list' object has no attribute 'predictions'"}
------------------------------ Captured log call -------------------------------
WARNING  ner.inference:inference.py:150 GranularNERPredictor unavailable: Model directory not found: artifacts/granular_ner_model
INFO     coder.parallel_pathway:orchestrator.py:157 ParallelPathwayOrchestrator initialized: NER=unavailable, ML=unavailable
WARNING  registry.inference_pytorch:inference_pytorch.py:78 TorchRegistryPredictor unavailable: Unrecognized model in data/models/registry_runtime. Should have a `model_type` key in its config.json, or contain one of the following strings in its name: albert, align, altclip, arcee, aria, aria_text, audio-spectrogram-transformer, autoformer, aya_vision, bamba, bark, bart, beit, bert, bert-generation, big_bird, bigbird_pegasus, biogpt, bit, bitnet, blenderbot, blenderbot-small, blip, blip-2, blip_2_qformer, bloom, bridgetower, bros, camembert, canine, chameleon, chinese_clip, chinese_clip_vision_model, clap, clip, clip_text_model, clip_vision_model, clipseg, clvp, code_llama, codegen, cohere, cohere2, colpali, colqwen2, conditional_detr, convbert, convnext, convnextv2, cpmant, csm, ctrl, cvt, d_fine, dab-detr, dac, data2vec-audio, data2vec-text, data2vec-vision, dbrx, deberta, deberta-v2, decision_transformer, deepseek_v3, deformable_detr, deit, depth_anything, depth_pro, deta, detr, dia, diffllama, dinat, dinov2, dinov2_with_registers, distilbert, donut-swin, dots1, dpr, dpt, efficientformer, efficientnet, electra, emu3, encodec, encoder-decoder, ernie, ernie_m, esm, falcon, falcon_h1, falcon_mamba, fastspeech2_conformer, flaubert, flava, fnet, focalnet, fsmt, funnel, fuyu, gemma, gemma2, gemma3, gemma3_text, gemma3n, gemma3n_audio, gemma3n_text, gemma3n_vision, git, glm, glm4, glm4v, glm4v_text, glpn, got_ocr2, gpt-sw3, gpt2, gpt_bigcode, gpt_neo, gpt_neox, gpt_neox_japanese, gptj, gptsan-japanese, granite, granite_speech, granitemoe, granitemoehybrid, granitemoeshared, granitevision, graphormer, grounding-dino, groupvit, helium, hgnet_v2, hiera, hubert, ibert, idefics, idefics2, idefics3, idefics3_vision, ijepa, imagegpt, informer, instructblip, instructblipvideo, internvl, internvl_vision, jamba, janus, jetmoe, jukebox, kosmos-2, kyutai_speech_to_text, layoutlm, layoutlmv2, layoutlmv3, led, levit, lightglue, lilt, llama, llama4, llama4_text, llava, llava_next, llava_next_video, llava_onevision, longformer, longt5, luke, lxmert, m2m_100, mamba, mamba2, marian, markuplm, mask2former, maskformer, maskformer-swin, mbart, mctct, mega, megatron-bert, mgp-str, mimi, minimax, mistral, mistral3, mixtral, mlcd, mllama, mobilebert, mobilenet_v1, mobilenet_v2, mobilevit, mobilevitv2, modernbert, moonshine, moshi, mpnet, mpt, mra, mt5, musicgen, musicgen_melody, mvp, nat, nemotron, nezha, nllb-moe, nougat, nystromformer, olmo, olmo2, olmoe, omdet-turbo, oneformer, open-llama, openai-gpt, opt, owlv2, owlvit, paligemma, patchtsmixer, patchtst, pegasus, pegasus_x, perceiver, persimmon, phi, phi3, phi4_multimodal, phimoe, pix2struct, pixtral, plbart, poolformer, pop2piano, prompt_depth_anything, prophetnet, pvt, pvt_v2, qdqbert, qwen2, qwen2_5_omni, qwen2_5_vl, qwen2_5_vl_text, qwen2_audio, qwen2_audio_encoder, qwen2_moe, qwen2_vl, qwen2_vl_text, qwen3, qwen3_moe, rag, realm, recurrent_gemma, reformer, regnet, rembert, resnet, retribert, roberta, roberta-prelayernorm, roc_bert, roformer, rt_detr, rt_detr_resnet, rt_detr_v2, rwkv, sam, sam_hq, sam_hq_vision_model, sam_vision_model, seamless_m4t, seamless_m4t_v2, segformer, seggpt, sew, sew-d, shieldgemma2, siglip, siglip2, siglip_vision_model, smollm3, smolvlm, smolvlm_vision, speech-encoder-decoder, speech_to_text, speech_to_text_2, speecht5, splinter, squeezebert, stablelm, starcoder2, superglue, superpoint, swiftformer, swin, swin2sr, swinv2, switch_transformers, t5, t5gemma, table-transformer, tapas, textnet, time_series_transformer, timesfm, timesformer, timm_backbone, timm_wrapper, trajectory_transformer, transfo-xl, trocr, tvlt, tvp, udop, umt5, unispeech, unispeech-sat, univnet, upernet, van, video_llava, videomae, vilt, vipllava, vision-encoder-decoder, vision-text-dual-encoder, visual_bert, vit, vit_hybrid, vit_mae, vit_msn, vitdet, vitmatte, vitpose, vitpose_backbone, vits, vivit, vjepa2, wav2vec2, wav2vec2-bert, wav2vec2-conformer, wavlm, whisper, xclip, xglm, xlm, xlm-prophetnet, xlm-roberta, xlm-roberta-xl, xlnet, xmod, yolos, yoso, zamba, zamba2, zoedepth
INFO     ml_coder.registry_predictor:registry_predictor.py:156 Loading registry model from data/models/registry_classifier.pkl
INFO     ml_coder.registry_predictor:registry_predictor.py:163 Loaded 21 labels from MLB
INFO     ml_coder.registry_predictor:registry_predictor.py:180 RegistryMLPredictor initialized with 21 labels
INFO     registry_service:registry_service.py:337 Using RegistryMLPredictor (TF-IDF) with 21 labels
WARNING  coder.parallel_pathway:orchestrator.py:430 Path B failed: 'list' object has no attribute 'predictions'
_ test_focusing_can_change_extraction_but_auditor_uses_raw_text_and_report_flags_gap _

monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x1cf25f950>

    def test_focusing_can_change_extraction_but_auditor_uses_raw_text_and_report_flags_gap(
        monkeypatch: pytest.MonkeyPatch,
    ) -> None:
        monkeypatch.setenv("PROCSUITE_PIPELINE_MODE", "extraction_first")
        monkeypatch.setenv("REGISTRY_AUDITOR_SOURCE", "raw_ml")
        monkeypatch.setenv("REGISTRY_EXTRACTION_ENGINE", "agents_focus_then_engine")
        monkeypatch.setenv("REGISTRY_ML_AUDIT_USE_BUCKETS", "1")
        monkeypatch.setenv("REGISTRY_ML_SELF_CORRECT_MIN_PROB", "0.95")
    
        # Guardrails: orchestrator/rules must never be invoked for audit compare.
        from modules.coder.application.smart_hybrid_policy import SmartHybridOrchestrator
        from modules.coder.rules_engine import CodingRulesEngine
    
        monkeypatch.setattr(SmartHybridOrchestrator, "get_codes", _raise)
        monkeypatch.setattr(CodingRulesEngine, "validate", _raise)
    
        # RAW-ML should see the raw note text and predict IPC.
        from modules.ml_coder.predictor import CaseClassification, CodePrediction, MLCoderPredictor
        from modules.ml_coder.thresholds import CaseDifficulty
    
        classify_calls: list[str] = []
    
        monkeypatch.setattr(MLCoderPredictor, "__init__", lambda self, *a, **k: None)
    
        def _fake_classify_case(self, note_text: str):  # type: ignore[no-untyped-def]
            classify_calls.append(note_text)
            return CaseClassification(
                predictions=[CodePrediction(cpt="32550", prob=0.97)],
                high_conf=[CodePrediction(cpt="32550", prob=0.97)],
                gray_zone=[],
                difficulty=CaseDifficulty.HIGH_CONF,
            )
    
        monkeypatch.setattr(MLCoderPredictor, "classify_case", _fake_classify_case)
    
        engine = _FocusSensitiveRegistryEngine()
        service = RegistryService(hybrid_orchestrator=MagicMock(), registry_engine=engine)
    
        raw_note = (
            "HPI: Recurrent malignant pleural effusion; plan for PleurX catheter.\n"
            "PROCEDURE: Diagnostic bronchoscopy only.\n"
            "FINDINGS: Airways normal.\n"
        )
    
        result = service.extract_fields(raw_note)
    
        assert classify_calls == [raw_note]
        assert engine.note_texts, "Deterministic extraction should run"
        assert "pleurx" not in engine.note_texts[0].lower(), "Focused text should omit HPI keyword"
    
        assert result.audit_report is not None
>       assert [p.cpt for p in result.audit_report.missing_in_derived] == ["32550"]
E       AssertionError: assert [] == ['32550']
E         
E         Right contains one more item: '32550'
E         Use -v to get more diff

tests/registry/test_focusing_audit_guardrail.py:77: AssertionError
----------------------------- Captured stderr call -----------------------------
{"timestamp": "2026-01-18T00:35:57.398080", "level": "WARNING", "logger": "ner.inference", "message": "GranularNERPredictor unavailable: Model directory not found: artifacts/granular_ner_model"}
{"timestamp": "2026-01-18T00:35:57.398157", "level": "INFO", "logger": "coder.parallel_pathway", "message": "ParallelPathwayOrchestrator initialized: NER=unavailable, ML=unavailable"}
------------------------------ Captured log call -------------------------------
WARNING  ner.inference:inference.py:150 GranularNERPredictor unavailable: Model directory not found: artifacts/granular_ner_model
INFO     coder.parallel_pathway:orchestrator.py:157 ParallelPathwayOrchestrator initialized: NER=unavailable, ML=unavailable
___________________ test_kitchen_sink_extraction_first_flags ___________________

monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x1d1a1b010>

    def test_kitchen_sink_extraction_first_flags(monkeypatch: pytest.MonkeyPatch) -> None:
        monkeypatch.setenv("PROCSUITE_PIPELINE_MODE", "extraction_first")
        monkeypatch.setenv("REGISTRY_EXTRACTION_ENGINE", "engine")
        monkeypatch.setenv("REGISTRY_AUDITOR_SOURCE", "disabled")
        monkeypatch.setenv("REGISTRY_USE_STUB_LLM", "1")
    
        note_text = Path(
            "tests/fixtures/notes/kitchen_sink_ion_nav_ebus_fiducial_dilation.txt"
        ).read_text()
    
        result = RegistryService().extract_fields(note_text)
        record = result.record
    
        assert "NAVIGATION" in (record.procedure_families or [])
    
        assert record.procedures_performed is not None
    
        assert record.procedures_performed.navigational_bronchoscopy is not None
        assert record.procedures_performed.navigational_bronchoscopy.performed is True
    
        assert record.procedures_performed.airway_dilation is not None
        assert record.procedures_performed.airway_dilation.performed is True
    
        assert record.procedures_performed.therapeutic_aspiration is not None
        assert record.procedures_performed.therapeutic_aspiration.performed is True
    
        assert record.procedures_performed.radial_ebus is not None
        assert record.procedures_performed.radial_ebus.performed is True
    
        assert record.procedures_performed.linear_ebus is not None
>       assert record.procedures_performed.linear_ebus.performed is True
E       AssertionError: assert False is True
E        +  where False = LinearEBUSProcedure(performed=False, stations_sampled=['11R'], stations_planned=['11R'], stations_detail=[{'station': ...hotodocumentation_complete=None, elastography_used=True, elastography_pattern='qua', doppler_used=None, node_events=[]).performed
E        +    where LinearEBUSProcedure(performed=False, stations_sampled=['11R'], stations_planned=['11R'], stations_detail=[{'station': ...hotodocumentation_complete=None, elastography_used=True, elastography_pattern='qua', doppler_used=None, node_events=[]) = RegistryrecordProceduresPerformed(diagnostic_bronchoscopy=None, bal=None, bronchial_wash=None, brushings=None, endobro...ermoplasty=None, whole_lung_lavage=None, rigid_bronchoscopy=None, percutaneous_tracheostomy=None, neck_ultrasound=None).linear_ebus
E        +      where RegistryrecordProceduresPerformed(diagnostic_bronchoscopy=None, bal=None, bronchial_wash=None, brushings=None, endobro...ermoplasty=None, whole_lung_lavage=None, rigid_bronchoscopy=None, percutaneous_tracheostomy=None, neck_ultrasound=None) = RegistryRecord(patient_mrn=None, procedure_date=None, procedure_start_time=None, procedure_end_time=None, procedure_du...pled is empty/missing', 'procedures_performed.tbna_conventional.performed=true but stations_sampled is empty/missing']).procedures_performed

tests/registry/test_kitchen_sink_extraction_first.py:40: AssertionError
----------------------------- Captured stderr call -----------------------------
{"timestamp": "2026-01-18T00:35:57.447257", "level": "WARNING", "logger": "ner.inference", "message": "GranularNERPredictor unavailable: Model directory not found: artifacts/granular_ner_model"}
{"timestamp": "2026-01-18T00:35:57.447353", "level": "INFO", "logger": "coder.parallel_pathway", "message": "ParallelPathwayOrchestrator initialized: NER=unavailable, ML=unavailable"}
{"timestamp": "2026-01-18T00:35:57.450587", "level": "WARNING", "logger": "common.llm", "message": "Using DeterministicStubLLM. Set GEMINI_API_KEY for real inference."}
{"timestamp": "2026-01-18T00:35:57.456568", "level": "WARNING", "logger": "keyword_guard", "message": "SILENT_FAILURE: Text mentions 'brush' or 'brushings'. (Pattern: '(?i)\\bbrush(?:ings?)?\\b')"}
------------------------------ Captured log call -------------------------------
WARNING  ner.inference:inference.py:150 GranularNERPredictor unavailable: Model directory not found: artifacts/granular_ner_model
INFO     coder.parallel_pathway:orchestrator.py:157 ParallelPathwayOrchestrator initialized: NER=unavailable, ML=unavailable
WARNING  common.llm:llm.py:747 Using DeterministicStubLLM. Set GEMINI_API_KEY for real inference.
WARNING  keyword_guard:keyword_guard.py:102 SILENT_FAILURE: Text mentions 'brush' or 'brushings'. (Pattern: '(?i)\bbrush(?:ings?)?\b')
________________ test_registry_llm_timeout_falls_back_to_engine ________________

monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x1cf0c0d90>

    def test_registry_llm_timeout_falls_back_to_engine(monkeypatch: pytest.MonkeyPatch) -> None:
        monkeypatch.setenv("PROCSUITE_PIPELINE_MODE", "current")
    
        note_text = Path(
            "tests/fixtures/notes/kitchen_sink_ion_nav_ebus_fiducial_dilation.txt"
        ).read_text()
    
        engine = RegistryEngine()
    
        def _timeout(*_args, **_kwargs):  # type: ignore[no-untyped-def]
            raise TimeoutError("simulated LLM timeout")
    
        monkeypatch.setattr(engine.llm_extractor, "extract", _timeout)
    
        orchestrator = MagicMock()
        orchestrator.get_codes.return_value = HybridCoderResult(
            codes=[],
            source="ml_rules_fastpath",
            difficulty=CaseDifficulty.HIGH_CONF,
            metadata={},
        )
    
        service = RegistryService(hybrid_orchestrator=orchestrator, registry_engine=engine)
>       result = service.extract_fields(note_text)
                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/registry/test_llm_timeout_fallback.py:37: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <modules.registry.application.registry_service.RegistryService object at 0x1d5c96350>
note_text = 'Initial Airway Inspection Findings:\n \nCT Chest scan was placed on separate planning station to generate 3D renderin...ytology for diagnostic completeness.\n \n11R position appears to be a simple cyst that was drained after 2 passes. \n'
mode = 'default'

    def extract_fields(self, note_text: str, mode: str = "default") -> RegistryExtractionResult:
        """Extract registry fields using hybrid-first flow.
    
        This method orchestrates:
        1. Run hybrid coder to get CPT codes and difficulty classification
        2. Map CPT codes to registry boolean flags
        3. Run RegistryEngine extractor with coder context as hints
        4. Merge CPT-driven fields into the extraction result
        5. Validate and finalize the result
    
        Args:
            note_text: The procedure note text.
            mode: Optional override (e.g., "parallel_ner").
    
        Returns:
            RegistryExtractionResult with extracted record and metadata.
        """
        if mode == "parallel_ner":
            predictor = self._get_registry_ml_predictor()
            result = self.parallel_orchestrator.run_parallel_process(
                note_text,
                ml_predictor=predictor,
            )
            return self._apply_guardrails_to_result(note_text, result)
    
        pipeline_mode = os.getenv("PROCSUITE_PIPELINE_MODE", "current").strip().lower()
        if pipeline_mode != "extraction_first":
            allow_legacy = os.getenv("PROCSUITE_ALLOW_LEGACY_PIPELINES", "0").strip().lower() in {
                "1",
                "true",
                "yes",
                "y",
            }
            if not allow_legacy:
>               raise ValueError(
                    "Legacy pipelines are disabled. Set PROCSUITE_ALLOW_LEGACY_PIPELINES=1 to enable."
                )
E               ValueError: Legacy pipelines are disabled. Set PROCSUITE_ALLOW_LEGACY_PIPELINES=1 to enable.

modules/registry/application/registry_service.py:622: ValueError
----------------------------- Captured stderr call -----------------------------
{"timestamp": "2026-01-18T00:35:57.462906", "level": "WARNING", "logger": "ner.inference", "message": "GranularNERPredictor unavailable: Model directory not found: artifacts/granular_ner_model"}
{"timestamp": "2026-01-18T00:35:57.462996", "level": "INFO", "logger": "coder.parallel_pathway", "message": "ParallelPathwayOrchestrator initialized: NER=unavailable, ML=unavailable"}
------------------------------ Captured log call -------------------------------
WARNING  ner.inference:inference.py:150 GranularNERPredictor unavailable: Model directory not found: artifacts/granular_ner_model
INFO     coder.parallel_pathway:orchestrator.py:157 ParallelPathwayOrchestrator initialized: NER=unavailable, ML=unavailable
_ TestRegistryServiceHybridFlow.test_ebus_navigation_mapping_and_validation_high_conf _

self = <test_registry_service_hybrid_flow.TestRegistryServiceHybridFlow object at 0x181089f90>

    def test_ebus_navigation_mapping_and_validation_high_conf(self) -> None:
        """High-confidence EBUS+NAV case should not require manual review."""
        # Arrange: fake orchestrator
        fake_orchestrator = MagicMock()
        fake_orchestrator.get_codes.return_value = make_fake_hybrid_result(
            codes=["31653", "31627"],
            difficulty="high_confidence",
        )
    
        # Create stub engine that returns a record WITH the expected fields set
        # (simulating LLM correctly extracting procedures)
        preset_record = RegistryRecord(
            procedure_type="bronchoscopy",
            procedures_performed={
                "linear_ebus": {"performed": True},
                "navigational_bronchoscopy": {"performed": True},
            },
        )
        stub_engine = StubRegistryEngine(preset_record=preset_record)
    
        service = RegistryService(
            hybrid_orchestrator=fake_orchestrator,
            registry_engine=stub_engine,
        )
    
        # Act
        result = service.extract_fields("Synthetic EBUS + NAV note")
    
        # Assert CPT codes and mapping
>       assert result.cpt_codes == ["31653", "31627"]
E       AssertionError: assert [] == ['31653', '31627']
E         
E         Right contains 2 more items, first extra item: '31653'
E         Use -v to get more diff

tests/registry/test_registry_service_hybrid_flow.py:288: AssertionError
----------------------------- Captured stderr call -----------------------------
{"timestamp": "2026-01-18T00:35:57.553793", "level": "WARNING", "logger": "ner.inference", "message": "GranularNERPredictor unavailable: Model directory not found: artifacts/granular_ner_model"}
{"timestamp": "2026-01-18T00:35:57.553890", "level": "INFO", "logger": "coder.parallel_pathway", "message": "ParallelPathwayOrchestrator initialized: NER=unavailable, ML=unavailable"}
{"timestamp": "2026-01-18T00:35:57.569318", "level": "WARNING", "logger": "registry.inference_pytorch", "message": "TorchRegistryPredictor unavailable: Unrecognized model in data/models/registry_runtime. Should have a `model_type` key in its config.json, or contain one of the following strings in its name: albert, align, altclip, arcee, aria, aria_text, audio-spectrogram-transformer, autoformer, aya_vision, bamba, bark, bart, beit, bert, bert-generation, big_bird, bigbird_pegasus, biogpt, bit, bitnet, blenderbot, blenderbot-small, blip, blip-2, blip_2_qformer, bloom, bridgetower, bros, camembert, canine, chameleon, chinese_clip, chinese_clip_vision_model, clap, clip, clip_text_model, clip_vision_model, clipseg, clvp, code_llama, codegen, cohere, cohere2, colpali, colqwen2, conditional_detr, convbert, convnext, convnextv2, cpmant, csm, ctrl, cvt, d_fine, dab-detr, dac, data2vec-audio, data2vec-text, data2vec-vision, dbrx, deberta, deberta-v2, decision_transformer, deepseek_v3, deformable_detr, deit, depth_anything, depth_pro, deta, detr, dia, diffllama, dinat, dinov2, dinov2_with_registers, distilbert, donut-swin, dots1, dpr, dpt, efficientformer, efficientnet, electra, emu3, encodec, encoder-decoder, ernie, ernie_m, esm, falcon, falcon_h1, falcon_mamba, fastspeech2_conformer, flaubert, flava, fnet, focalnet, fsmt, funnel, fuyu, gemma, gemma2, gemma3, gemma3_text, gemma3n, gemma3n_audio, gemma3n_text, gemma3n_vision, git, glm, glm4, glm4v, glm4v_text, glpn, got_ocr2, gpt-sw3, gpt2, gpt_bigcode, gpt_neo, gpt_neox, gpt_neox_japanese, gptj, gptsan-japanese, granite, granite_speech, granitemoe, granitemoehybrid, granitemoeshared, granitevision, graphormer, grounding-dino, groupvit, helium, hgnet_v2, hiera, hubert, ibert, idefics, idefics2, idefics3, idefics3_vision, ijepa, imagegpt, informer, instructblip, instructblipvideo, internvl, internvl_vision, jamba, janus, jetmoe, jukebox, kosmos-2, kyutai_speech_to_text, layoutlm, layoutlmv2, layoutlmv3, led, levit, lightglue, lilt, llama, llama4, llama4_text, llava, llava_next, llava_next_video, llava_onevision, longformer, longt5, luke, lxmert, m2m_100, mamba, mamba2, marian, markuplm, mask2former, maskformer, maskformer-swin, mbart, mctct, mega, megatron-bert, mgp-str, mimi, minimax, mistral, mistral3, mixtral, mlcd, mllama, mobilebert, mobilenet_v1, mobilenet_v2, mobilevit, mobilevitv2, modernbert, moonshine, moshi, mpnet, mpt, mra, mt5, musicgen, musicgen_melody, mvp, nat, nemotron, nezha, nllb-moe, nougat, nystromformer, olmo, olmo2, olmoe, omdet-turbo, oneformer, open-llama, openai-gpt, opt, owlv2, owlvit, paligemma, patchtsmixer, patchtst, pegasus, pegasus_x, perceiver, persimmon, phi, phi3, phi4_multimodal, phimoe, pix2struct, pixtral, plbart, poolformer, pop2piano, prompt_depth_anything, prophetnet, pvt, pvt_v2, qdqbert, qwen2, qwen2_5_omni, qwen2_5_vl, qwen2_5_vl_text, qwen2_audio, qwen2_audio_encoder, qwen2_moe, qwen2_vl, qwen2_vl_text, qwen3, qwen3_moe, rag, realm, recurrent_gemma, reformer, regnet, rembert, resnet, retribert, roberta, roberta-prelayernorm, roc_bert, roformer, rt_detr, rt_detr_resnet, rt_detr_v2, rwkv, sam, sam_hq, sam_hq_vision_model, sam_vision_model, seamless_m4t, seamless_m4t_v2, segformer, seggpt, sew, sew-d, shieldgemma2, siglip, siglip2, siglip_vision_model, smollm3, smolvlm, smolvlm_vision, speech-encoder-decoder, speech_to_text, speech_to_text_2, speecht5, splinter, squeezebert, stablelm, starcoder2, superglue, superpoint, swiftformer, swin, swin2sr, swinv2, switch_transformers, t5, t5gemma, table-transformer, tapas, textnet, time_series_transformer, timesfm, timesformer, timm_backbone, timm_wrapper, trajectory_transformer, transfo-xl, trocr, tvlt, tvp, udop, umt5, unispeech, unispeech-sat, univnet, upernet, van, video_llava, videomae, vilt, vipllava, vision-encoder-decoder, vision-text-dual-encoder, visual_bert, vit, vit_hybrid, vit_mae, vit_msn, vitdet, vitmatte, vitpose, vitpose_backbone, vits, vivit, vjepa2, wav2vec2, wav2vec2-bert, wav2vec2-conformer, wavlm, whisper, xclip, xglm, xlm, xlm-prophetnet, xlm-roberta, xlm-roberta-xl, xlnet, xmod, yolos, yoso, zamba, zamba2, zoedepth"}
{"timestamp": "2026-01-18T00:35:57.569442", "level": "INFO", "logger": "ml_coder.registry_predictor", "message": "Loading registry model from data/models/registry_classifier.pkl"}
{"timestamp": "2026-01-18T00:35:57.600993", "level": "INFO", "logger": "ml_coder.registry_predictor", "message": "Loaded 21 labels from MLB"}
{"timestamp": "2026-01-18T00:35:57.601136", "level": "INFO", "logger": "ml_coder.registry_predictor", "message": "RegistryMLPredictor initialized with 21 labels"}
{"timestamp": "2026-01-18T00:35:57.601188", "level": "INFO", "logger": "registry_service", "message": "Using RegistryMLPredictor (TF-IDF) with 21 labels"}
{"timestamp": "2026-01-18T00:35:57.618376", "level": "WARNING", "logger": "coder.parallel_pathway", "message": "Path B failed: 'list' object has no attribute 'predictions'"}
{"timestamp": "2026-01-18T00:35:57.618629", "level": "INFO", "logger": "ml_coder.predictor", "message": "Loading model from data/models/cpt_classifier.pkl"}
{"timestamp": "2026-01-18T00:35:57.645170", "level": "INFO", "logger": "ml_coder.predictor", "message": "Predictor initialized with 35 labels, upper=0.70, lower=0.40"}
------------------------------ Captured log call -------------------------------
WARNING  ner.inference:inference.py:150 GranularNERPredictor unavailable: Model directory not found: artifacts/granular_ner_model
INFO     coder.parallel_pathway:orchestrator.py:157 ParallelPathwayOrchestrator initialized: NER=unavailable, ML=unavailable
WARNING  registry.inference_pytorch:inference_pytorch.py:78 TorchRegistryPredictor unavailable: Unrecognized model in data/models/registry_runtime. Should have a `model_type` key in its config.json, or contain one of the following strings in its name: albert, align, altclip, arcee, aria, aria_text, audio-spectrogram-transformer, autoformer, aya_vision, bamba, bark, bart, beit, bert, bert-generation, big_bird, bigbird_pegasus, biogpt, bit, bitnet, blenderbot, blenderbot-small, blip, blip-2, blip_2_qformer, bloom, bridgetower, bros, camembert, canine, chameleon, chinese_clip, chinese_clip_vision_model, clap, clip, clip_text_model, clip_vision_model, clipseg, clvp, code_llama, codegen, cohere, cohere2, colpali, colqwen2, conditional_detr, convbert, convnext, convnextv2, cpmant, csm, ctrl, cvt, d_fine, dab-detr, dac, data2vec-audio, data2vec-text, data2vec-vision, dbrx, deberta, deberta-v2, decision_transformer, deepseek_v3, deformable_detr, deit, depth_anything, depth_pro, deta, detr, dia, diffllama, dinat, dinov2, dinov2_with_registers, distilbert, donut-swin, dots1, dpr, dpt, efficientformer, efficientnet, electra, emu3, encodec, encoder-decoder, ernie, ernie_m, esm, falcon, falcon_h1, falcon_mamba, fastspeech2_conformer, flaubert, flava, fnet, focalnet, fsmt, funnel, fuyu, gemma, gemma2, gemma3, gemma3_text, gemma3n, gemma3n_audio, gemma3n_text, gemma3n_vision, git, glm, glm4, glm4v, glm4v_text, glpn, got_ocr2, gpt-sw3, gpt2, gpt_bigcode, gpt_neo, gpt_neox, gpt_neox_japanese, gptj, gptsan-japanese, granite, granite_speech, granitemoe, granitemoehybrid, granitemoeshared, granitevision, graphormer, grounding-dino, groupvit, helium, hgnet_v2, hiera, hubert, ibert, idefics, idefics2, idefics3, idefics3_vision, ijepa, imagegpt, informer, instructblip, instructblipvideo, internvl, internvl_vision, jamba, janus, jetmoe, jukebox, kosmos-2, kyutai_speech_to_text, layoutlm, layoutlmv2, layoutlmv3, led, levit, lightglue, lilt, llama, llama4, llama4_text, llava, llava_next, llava_next_video, llava_onevision, longformer, longt5, luke, lxmert, m2m_100, mamba, mamba2, marian, markuplm, mask2former, maskformer, maskformer-swin, mbart, mctct, mega, megatron-bert, mgp-str, mimi, minimax, mistral, mistral3, mixtral, mlcd, mllama, mobilebert, mobilenet_v1, mobilenet_v2, mobilevit, mobilevitv2, modernbert, moonshine, moshi, mpnet, mpt, mra, mt5, musicgen, musicgen_melody, mvp, nat, nemotron, nezha, nllb-moe, nougat, nystromformer, olmo, olmo2, olmoe, omdet-turbo, oneformer, open-llama, openai-gpt, opt, owlv2, owlvit, paligemma, patchtsmixer, patchtst, pegasus, pegasus_x, perceiver, persimmon, phi, phi3, phi4_multimodal, phimoe, pix2struct, pixtral, plbart, poolformer, pop2piano, prompt_depth_anything, prophetnet, pvt, pvt_v2, qdqbert, qwen2, qwen2_5_omni, qwen2_5_vl, qwen2_5_vl_text, qwen2_audio, qwen2_audio_encoder, qwen2_moe, qwen2_vl, qwen2_vl_text, qwen3, qwen3_moe, rag, realm, recurrent_gemma, reformer, regnet, rembert, resnet, retribert, roberta, roberta-prelayernorm, roc_bert, roformer, rt_detr, rt_detr_resnet, rt_detr_v2, rwkv, sam, sam_hq, sam_hq_vision_model, sam_vision_model, seamless_m4t, seamless_m4t_v2, segformer, seggpt, sew, sew-d, shieldgemma2, siglip, siglip2, siglip_vision_model, smollm3, smolvlm, smolvlm_vision, speech-encoder-decoder, speech_to_text, speech_to_text_2, speecht5, splinter, squeezebert, stablelm, starcoder2, superglue, superpoint, swiftformer, swin, swin2sr, swinv2, switch_transformers, t5, t5gemma, table-transformer, tapas, textnet, time_series_transformer, timesfm, timesformer, timm_backbone, timm_wrapper, trajectory_transformer, transfo-xl, trocr, tvlt, tvp, udop, umt5, unispeech, unispeech-sat, univnet, upernet, van, video_llava, videomae, vilt, vipllava, vision-encoder-decoder, vision-text-dual-encoder, visual_bert, vit, vit_hybrid, vit_mae, vit_msn, vitdet, vitmatte, vitpose, vitpose_backbone, vits, vivit, vjepa2, wav2vec2, wav2vec2-bert, wav2vec2-conformer, wavlm, whisper, xclip, xglm, xlm, xlm-prophetnet, xlm-roberta, xlm-roberta-xl, xlnet, xmod, yolos, yoso, zamba, zamba2, zoedepth
INFO     ml_coder.registry_predictor:registry_predictor.py:156 Loading registry model from data/models/registry_classifier.pkl
INFO     ml_coder.registry_predictor:registry_predictor.py:163 Loaded 21 labels from MLB
INFO     ml_coder.registry_predictor:registry_predictor.py:180 RegistryMLPredictor initialized with 21 labels
INFO     registry_service:registry_service.py:337 Using RegistryMLPredictor (TF-IDF) with 21 labels
WARNING  coder.parallel_pathway:orchestrator.py:430 Path B failed: 'list' object has no attribute 'predictions'
INFO     ml_coder.predictor:predictor.py:175 Loading model from data/models/cpt_classifier.pkl
INFO     ml_coder.predictor:predictor.py:185 Predictor initialized with 35 labels, upper=0.70, lower=0.40
______ TestRegistryServiceHybridFlow.test_cpt_merge_fills_missing_fields _______

self = <test_registry_service_hybrid_flow.TestRegistryServiceHybridFlow object at 0x18108f290>

    def test_cpt_merge_fills_missing_fields(self) -> None:
        """CPT mapping should fill fields that LLM extractor missed."""
        # Arrange: orchestrator returns BAL code
        fake_orchestrator = MagicMock()
        fake_orchestrator.get_codes.return_value = make_fake_hybrid_result(
            codes=["31624"],
            difficulty="high_confidence",
        )
    
        # Stub engine returns record WITHOUT BAL set (LLM missed it)
        preset_record = RegistryRecord(procedure_type="bronchoscopy")
        stub_engine = StubRegistryEngine(preset_record=preset_record)
    
        service = RegistryService(
            hybrid_orchestrator=fake_orchestrator,
            registry_engine=stub_engine,
        )
    
        # Act
        result = service.extract_fields("BAL performed from RML")
    
        # Assert: CPT mapping filled in the missing BAL field
        assert result.record.procedures_performed is not None
>       assert result.record.procedures_performed.bal is not None
E       assert None is not None
E        +  where None = RegistryrecordProceduresPerformed(diagnostic_bronchoscopy=None, bal=None, bronchial_wash=None, brushings=None, endobro...ermoplasty=None, whole_lung_lavage=None, rigid_bronchoscopy=None, percutaneous_tracheostomy=None, neck_ultrasound=None).bal
E        +    where RegistryrecordProceduresPerformed(diagnostic_bronchoscopy=None, bal=None, bronchial_wash=None, brushings=None, endobro...ermoplasty=None, whole_lung_lavage=None, rigid_bronchoscopy=None, percutaneous_tracheostomy=None, neck_ultrasound=None) = RegistryRecord(patient_mrn=None, procedure_date=None, procedure_start_time=None, procedure_end_time=None, procedure_du...None, pleural_thoracoscopy_findings=None, bronch_num_tbbx=None, bronch_tbbx_tool=None, granular_validation_warnings=[]).procedures_performed
E        +      where RegistryRecord(patient_mrn=None, procedure_date=None, procedure_start_time=None, procedure_end_time=None, procedure_du...None, pleural_thoracoscopy_findings=None, bronch_num_tbbx=None, bronch_tbbx_tool=None, granular_validation_warnings=[]) = RegistryExtractionResult(record=RegistryRecord(patient_mrn=None, procedure_date=None, procedure_start_time=None, proce...ConfigSnapshot(use_buckets=True, top_k=25, min_prob=0.5, self_correct_min_prob=0.95), warnings=[]), self_correction=[]).record

tests/registry/test_registry_service_hybrid_flow.py:335: AssertionError
----------------------------- Captured stderr call -----------------------------
{"timestamp": "2026-01-18T00:35:57.672742", "level": "WARNING", "logger": "ner.inference", "message": "GranularNERPredictor unavailable: Model directory not found: artifacts/granular_ner_model"}
{"timestamp": "2026-01-18T00:35:57.672862", "level": "INFO", "logger": "coder.parallel_pathway", "message": "ParallelPathwayOrchestrator initialized: NER=unavailable, ML=unavailable"}
{"timestamp": "2026-01-18T00:35:57.690914", "level": "WARNING", "logger": "registry.inference_pytorch", "message": "TorchRegistryPredictor unavailable: Unrecognized model in data/models/registry_runtime. Should have a `model_type` key in its config.json, or contain one of the following strings in its name: albert, align, altclip, arcee, aria, aria_text, audio-spectrogram-transformer, autoformer, aya_vision, bamba, bark, bart, beit, bert, bert-generation, big_bird, bigbird_pegasus, biogpt, bit, bitnet, blenderbot, blenderbot-small, blip, blip-2, blip_2_qformer, bloom, bridgetower, bros, camembert, canine, chameleon, chinese_clip, chinese_clip_vision_model, clap, clip, clip_text_model, clip_vision_model, clipseg, clvp, code_llama, codegen, cohere, cohere2, colpali, colqwen2, conditional_detr, convbert, convnext, convnextv2, cpmant, csm, ctrl, cvt, d_fine, dab-detr, dac, data2vec-audio, data2vec-text, data2vec-vision, dbrx, deberta, deberta-v2, decision_transformer, deepseek_v3, deformable_detr, deit, depth_anything, depth_pro, deta, detr, dia, diffllama, dinat, dinov2, dinov2_with_registers, distilbert, donut-swin, dots1, dpr, dpt, efficientformer, efficientnet, electra, emu3, encodec, encoder-decoder, ernie, ernie_m, esm, falcon, falcon_h1, falcon_mamba, fastspeech2_conformer, flaubert, flava, fnet, focalnet, fsmt, funnel, fuyu, gemma, gemma2, gemma3, gemma3_text, gemma3n, gemma3n_audio, gemma3n_text, gemma3n_vision, git, glm, glm4, glm4v, glm4v_text, glpn, got_ocr2, gpt-sw3, gpt2, gpt_bigcode, gpt_neo, gpt_neox, gpt_neox_japanese, gptj, gptsan-japanese, granite, granite_speech, granitemoe, granitemoehybrid, granitemoeshared, granitevision, graphormer, grounding-dino, groupvit, helium, hgnet_v2, hiera, hubert, ibert, idefics, idefics2, idefics3, idefics3_vision, ijepa, imagegpt, informer, instructblip, instructblipvideo, internvl, internvl_vision, jamba, janus, jetmoe, jukebox, kosmos-2, kyutai_speech_to_text, layoutlm, layoutlmv2, layoutlmv3, led, levit, lightglue, lilt, llama, llama4, llama4_text, llava, llava_next, llava_next_video, llava_onevision, longformer, longt5, luke, lxmert, m2m_100, mamba, mamba2, marian, markuplm, mask2former, maskformer, maskformer-swin, mbart, mctct, mega, megatron-bert, mgp-str, mimi, minimax, mistral, mistral3, mixtral, mlcd, mllama, mobilebert, mobilenet_v1, mobilenet_v2, mobilevit, mobilevitv2, modernbert, moonshine, moshi, mpnet, mpt, mra, mt5, musicgen, musicgen_melody, mvp, nat, nemotron, nezha, nllb-moe, nougat, nystromformer, olmo, olmo2, olmoe, omdet-turbo, oneformer, open-llama, openai-gpt, opt, owlv2, owlvit, paligemma, patchtsmixer, patchtst, pegasus, pegasus_x, perceiver, persimmon, phi, phi3, phi4_multimodal, phimoe, pix2struct, pixtral, plbart, poolformer, pop2piano, prompt_depth_anything, prophetnet, pvt, pvt_v2, qdqbert, qwen2, qwen2_5_omni, qwen2_5_vl, qwen2_5_vl_text, qwen2_audio, qwen2_audio_encoder, qwen2_moe, qwen2_vl, qwen2_vl_text, qwen3, qwen3_moe, rag, realm, recurrent_gemma, reformer, regnet, rembert, resnet, retribert, roberta, roberta-prelayernorm, roc_bert, roformer, rt_detr, rt_detr_resnet, rt_detr_v2, rwkv, sam, sam_hq, sam_hq_vision_model, sam_vision_model, seamless_m4t, seamless_m4t_v2, segformer, seggpt, sew, sew-d, shieldgemma2, siglip, siglip2, siglip_vision_model, smollm3, smolvlm, smolvlm_vision, speech-encoder-decoder, speech_to_text, speech_to_text_2, speecht5, splinter, squeezebert, stablelm, starcoder2, superglue, superpoint, swiftformer, swin, swin2sr, swinv2, switch_transformers, t5, t5gemma, table-transformer, tapas, textnet, time_series_transformer, timesfm, timesformer, timm_backbone, timm_wrapper, trajectory_transformer, transfo-xl, trocr, tvlt, tvp, udop, umt5, unispeech, unispeech-sat, univnet, upernet, van, video_llava, videomae, vilt, vipllava, vision-encoder-decoder, vision-text-dual-encoder, visual_bert, vit, vit_hybrid, vit_mae, vit_msn, vitdet, vitmatte, vitpose, vitpose_backbone, vits, vivit, vjepa2, wav2vec2, wav2vec2-bert, wav2vec2-conformer, wavlm, whisper, xclip, xglm, xlm, xlm-prophetnet, xlm-roberta, xlm-roberta-xl, xlnet, xmod, yolos, yoso, zamba, zamba2, zoedepth"}
{"timestamp": "2026-01-18T00:35:57.691053", "level": "INFO", "logger": "ml_coder.registry_predictor", "message": "Loading registry model from data/models/registry_classifier.pkl"}
{"timestamp": "2026-01-18T00:35:57.723312", "level": "INFO", "logger": "ml_coder.registry_predictor", "message": "Loaded 21 labels from MLB"}
{"timestamp": "2026-01-18T00:35:57.723491", "level": "INFO", "logger": "ml_coder.registry_predictor", "message": "RegistryMLPredictor initialized with 21 labels"}
{"timestamp": "2026-01-18T00:35:57.723540", "level": "INFO", "logger": "registry_service", "message": "Using RegistryMLPredictor (TF-IDF) with 21 labels"}
{"timestamp": "2026-01-18T00:35:57.740132", "level": "WARNING", "logger": "coder.parallel_pathway", "message": "Path B failed: 'list' object has no attribute 'predictions'"}
{"timestamp": "2026-01-18T00:35:57.740358", "level": "INFO", "logger": "ml_coder.predictor", "message": "Loading model from data/models/cpt_classifier.pkl"}
{"timestamp": "2026-01-18T00:35:57.767882", "level": "INFO", "logger": "ml_coder.predictor", "message": "Predictor initialized with 35 labels, upper=0.70, lower=0.40"}
------------------------------ Captured log call -------------------------------
WARNING  ner.inference:inference.py:150 GranularNERPredictor unavailable: Model directory not found: artifacts/granular_ner_model
INFO     coder.parallel_pathway:orchestrator.py:157 ParallelPathwayOrchestrator initialized: NER=unavailable, ML=unavailable
WARNING  registry.inference_pytorch:inference_pytorch.py:78 TorchRegistryPredictor unavailable: Unrecognized model in data/models/registry_runtime. Should have a `model_type` key in its config.json, or contain one of the following strings in its name: albert, align, altclip, arcee, aria, aria_text, audio-spectrogram-transformer, autoformer, aya_vision, bamba, bark, bart, beit, bert, bert-generation, big_bird, bigbird_pegasus, biogpt, bit, bitnet, blenderbot, blenderbot-small, blip, blip-2, blip_2_qformer, bloom, bridgetower, bros, camembert, canine, chameleon, chinese_clip, chinese_clip_vision_model, clap, clip, clip_text_model, clip_vision_model, clipseg, clvp, code_llama, codegen, cohere, cohere2, colpali, colqwen2, conditional_detr, convbert, convnext, convnextv2, cpmant, csm, ctrl, cvt, d_fine, dab-detr, dac, data2vec-audio, data2vec-text, data2vec-vision, dbrx, deberta, deberta-v2, decision_transformer, deepseek_v3, deformable_detr, deit, depth_anything, depth_pro, deta, detr, dia, diffllama, dinat, dinov2, dinov2_with_registers, distilbert, donut-swin, dots1, dpr, dpt, efficientformer, efficientnet, electra, emu3, encodec, encoder-decoder, ernie, ernie_m, esm, falcon, falcon_h1, falcon_mamba, fastspeech2_conformer, flaubert, flava, fnet, focalnet, fsmt, funnel, fuyu, gemma, gemma2, gemma3, gemma3_text, gemma3n, gemma3n_audio, gemma3n_text, gemma3n_vision, git, glm, glm4, glm4v, glm4v_text, glpn, got_ocr2, gpt-sw3, gpt2, gpt_bigcode, gpt_neo, gpt_neox, gpt_neox_japanese, gptj, gptsan-japanese, granite, granite_speech, granitemoe, granitemoehybrid, granitemoeshared, granitevision, graphormer, grounding-dino, groupvit, helium, hgnet_v2, hiera, hubert, ibert, idefics, idefics2, idefics3, idefics3_vision, ijepa, imagegpt, informer, instructblip, instructblipvideo, internvl, internvl_vision, jamba, janus, jetmoe, jukebox, kosmos-2, kyutai_speech_to_text, layoutlm, layoutlmv2, layoutlmv3, led, levit, lightglue, lilt, llama, llama4, llama4_text, llava, llava_next, llava_next_video, llava_onevision, longformer, longt5, luke, lxmert, m2m_100, mamba, mamba2, marian, markuplm, mask2former, maskformer, maskformer-swin, mbart, mctct, mega, megatron-bert, mgp-str, mimi, minimax, mistral, mistral3, mixtral, mlcd, mllama, mobilebert, mobilenet_v1, mobilenet_v2, mobilevit, mobilevitv2, modernbert, moonshine, moshi, mpnet, mpt, mra, mt5, musicgen, musicgen_melody, mvp, nat, nemotron, nezha, nllb-moe, nougat, nystromformer, olmo, olmo2, olmoe, omdet-turbo, oneformer, open-llama, openai-gpt, opt, owlv2, owlvit, paligemma, patchtsmixer, patchtst, pegasus, pegasus_x, perceiver, persimmon, phi, phi3, phi4_multimodal, phimoe, pix2struct, pixtral, plbart, poolformer, pop2piano, prompt_depth_anything, prophetnet, pvt, pvt_v2, qdqbert, qwen2, qwen2_5_omni, qwen2_5_vl, qwen2_5_vl_text, qwen2_audio, qwen2_audio_encoder, qwen2_moe, qwen2_vl, qwen2_vl_text, qwen3, qwen3_moe, rag, realm, recurrent_gemma, reformer, regnet, rembert, resnet, retribert, roberta, roberta-prelayernorm, roc_bert, roformer, rt_detr, rt_detr_resnet, rt_detr_v2, rwkv, sam, sam_hq, sam_hq_vision_model, sam_vision_model, seamless_m4t, seamless_m4t_v2, segformer, seggpt, sew, sew-d, shieldgemma2, siglip, siglip2, siglip_vision_model, smollm3, smolvlm, smolvlm_vision, speech-encoder-decoder, speech_to_text, speech_to_text_2, speecht5, splinter, squeezebert, stablelm, starcoder2, superglue, superpoint, swiftformer, swin, swin2sr, swinv2, switch_transformers, t5, t5gemma, table-transformer, tapas, textnet, time_series_transformer, timesfm, timesformer, timm_backbone, timm_wrapper, trajectory_transformer, transfo-xl, trocr, tvlt, tvp, udop, umt5, unispeech, unispeech-sat, univnet, upernet, van, video_llava, videomae, vilt, vipllava, vision-encoder-decoder, vision-text-dual-encoder, visual_bert, vit, vit_hybrid, vit_mae, vit_msn, vitdet, vitmatte, vitpose, vitpose_backbone, vits, vivit, vjepa2, wav2vec2, wav2vec2-bert, wav2vec2-conformer, wavlm, whisper, xclip, xglm, xlm, xlm-prophetnet, xlm-roberta, xlm-roberta-xl, xlnet, xmod, yolos, yoso, zamba, zamba2, zoedepth
INFO     ml_coder.registry_predictor:registry_predictor.py:156 Loading registry model from data/models/registry_classifier.pkl
INFO     ml_coder.registry_predictor:registry_predictor.py:163 Loaded 21 labels from MLB
INFO     ml_coder.registry_predictor:registry_predictor.py:180 RegistryMLPredictor initialized with 21 labels
INFO     registry_service:registry_service.py:337 Using RegistryMLPredictor (TF-IDF) with 21 labels
WARNING  coder.parallel_pathway:orchestrator.py:430 Path B failed: 'list' object has no attribute 'predictions'
INFO     ml_coder.predictor:predictor.py:175 Loading model from data/models/cpt_classifier.pkl
INFO     ml_coder.predictor:predictor.py:185 Predictor initialized with 35 labels, upper=0.70, lower=0.40
__ TestRegistryServiceHybridFlow.test_tblb_mismatch_triggers_validation_error __

self = <test_registry_service_hybrid_flow.TestRegistryServiceHybridFlow object at 0x18108d890>

    def test_tblb_mismatch_triggers_validation_error(self) -> None:
        """When CPT says TBLB but LLM doesn't extract it, validation error should trigger."""
        # Arrange: orchestrator returns TBLB code
        fake_orchestrator = MagicMock()
        fake_orchestrator.get_codes.return_value = make_fake_hybrid_result(
            codes=["31628"],  # TBLB
            difficulty="high_confidence",
        )
    
        # Stub engine returns record WITHOUT transbronchial_biopsy set
        # AND we patch the merge to NOT set it (simulating a case where
        # both LLM and CPT mapping somehow miss the field - which shouldn't
        # happen with current code, but tests the validation logic)
        preset_record = RegistryRecord(
            procedure_type="bronchoscopy",
            procedures_performed=None,  # No procedures set
        )
        stub_engine = StubRegistryEngine(preset_record=preset_record)
    
        service = RegistryService(
            hybrid_orchestrator=fake_orchestrator,
            registry_engine=stub_engine,
        )
    
        # Disable ML hybrid audit for this test (we're testing CPT merge logic only)
        service._registry_ml_predictor = None
        service._ml_predictor_init_attempted = True
    
        # Act
        result = service.extract_fields("Transbronchial biopsy obtained")
    
        # Assert: After merge, CPT mapping should have filled transbronchial_biopsy
        # So validation should pass. Let's verify the merge worked:
        assert result.record.procedures_performed is not None
>       assert result.record.procedures_performed.transbronchial_biopsy is not None
E       assert None is not None
E        +  where None = RegistryrecordProceduresPerformed(diagnostic_bronchoscopy=None, bal=None, bronchial_wash=None, brushings=None, endobro...ermoplasty=None, whole_lung_lavage=None, rigid_bronchoscopy=None, percutaneous_tracheostomy=None, neck_ultrasound=None).transbronchial_biopsy
E        +    where RegistryrecordProceduresPerformed(diagnostic_bronchoscopy=None, bal=None, bronchial_wash=None, brushings=None, endobro...ermoplasty=None, whole_lung_lavage=None, rigid_bronchoscopy=None, percutaneous_tracheostomy=None, neck_ultrasound=None) = RegistryRecord(patient_mrn=None, procedure_date=None, procedure_start_time=None, procedure_end_time=None, procedure_du...None, pleural_thoracoscopy_findings=None, bronch_num_tbbx=None, bronch_tbbx_tool=None, granular_validation_warnings=[]).procedures_performed
E        +      where RegistryRecord(patient_mrn=None, procedure_date=None, procedure_start_time=None, procedure_end_time=None, procedure_du...None, pleural_thoracoscopy_findings=None, bronch_num_tbbx=None, bronch_tbbx_tool=None, granular_validation_warnings=[]) = RegistryExtractionResult(record=RegistryRecord(patient_mrn=None, procedure_date=None, procedure_start_time=None, proce...ConfigSnapshot(use_buckets=True, top_k=25, min_prob=0.5, self_correct_min_prob=0.95), warnings=[]), self_correction=[]).record

tests/registry/test_registry_service_hybrid_flow.py:372: AssertionError
----------------------------- Captured stderr call -----------------------------
{"timestamp": "2026-01-18T00:35:57.835069", "level": "WARNING", "logger": "ner.inference", "message": "GranularNERPredictor unavailable: Model directory not found: artifacts/granular_ner_model"}
{"timestamp": "2026-01-18T00:35:57.835646", "level": "INFO", "logger": "coder.parallel_pathway", "message": "ParallelPathwayOrchestrator initialized: NER=unavailable, ML=unavailable"}
{"timestamp": "2026-01-18T00:35:57.846024", "level": "INFO", "logger": "ml_coder.predictor", "message": "Loading model from data/models/cpt_classifier.pkl"}
{"timestamp": "2026-01-18T00:35:57.875558", "level": "INFO", "logger": "ml_coder.predictor", "message": "Predictor initialized with 35 labels, upper=0.70, lower=0.40"}
------------------------------ Captured log call -------------------------------
WARNING  ner.inference:inference.py:150 GranularNERPredictor unavailable: Model directory not found: artifacts/granular_ner_model
INFO     coder.parallel_pathway:orchestrator.py:157 ParallelPathwayOrchestrator initialized: NER=unavailable, ML=unavailable
INFO     ml_coder.predictor:predictor.py:175 Loading model from data/models/cpt_classifier.pkl
INFO     ml_coder.predictor:predictor.py:185 Predictor initialized with 35 labels, upper=0.70, lower=0.40
_ TestRegistryServiceHybridFlow.test_validation_error_when_cpt_field_not_extractable _

self = <test_registry_service_hybrid_flow.TestRegistryServiceHybridFlow object at 0x18108fc90>

    def test_validation_error_when_cpt_field_not_extractable(self) -> None:
        """When CPT code present but corresponding field can't be set, validation should flag it.
    
        This tests the edge case where neither LLM nor CPT merge can set the field.
        We simulate this by patching _merge_cpt_fields_into_record to return unchanged.
        """
        fake_orchestrator = MagicMock()
        fake_orchestrator.get_codes.return_value = make_fake_hybrid_result(
            codes=["31654"],  # Radial EBUS (corrected from 31620)
            difficulty="high_confidence",
        )
    
        preset_record = RegistryRecord(procedure_type="bronchoscopy")
        stub_engine = StubRegistryEngine(preset_record=preset_record)
    
        service = RegistryService(
            hybrid_orchestrator=fake_orchestrator,
            registry_engine=stub_engine,
        )
    
        # Patch merge to return unchanged record (simulating merge failure)
        original_merge = service._merge_cpt_fields_into_record
    
        def no_op_merge(record, mapped_fields):
            return record  # Don't actually merge
    
        service._merge_cpt_fields_into_record = no_op_merge
    
        # Act
        result = service.extract_fields("Radial EBUS performed")
    
        # Assert: Validation should flag the mismatch
        assert result.needs_manual_review is True
>       assert any("31654" in e and "radial_ebus" in e for e in result.validation_errors)
E       assert False
E        +  where False = any(<generator object TestRegistryServiceHybridFlow.test_validation_error_when_cpt_field_not_extractable.<locals>.<genexpr> at 0x1d5e8e0c0>)

tests/registry/test_registry_service_hybrid_flow.py:412: AssertionError
----------------------------- Captured stderr call -----------------------------
{"timestamp": "2026-01-18T00:35:57.902118", "level": "WARNING", "logger": "ner.inference", "message": "GranularNERPredictor unavailable: Model directory not found: artifacts/granular_ner_model"}
{"timestamp": "2026-01-18T00:35:57.902259", "level": "INFO", "logger": "coder.parallel_pathway", "message": "ParallelPathwayOrchestrator initialized: NER=unavailable, ML=unavailable"}
{"timestamp": "2026-01-18T00:35:57.920532", "level": "WARNING", "logger": "registry.inference_pytorch", "message": "TorchRegistryPredictor unavailable: Unrecognized model in data/models/registry_runtime. Should have a `model_type` key in its config.json, or contain one of the following strings in its name: albert, align, altclip, arcee, aria, aria_text, audio-spectrogram-transformer, autoformer, aya_vision, bamba, bark, bart, beit, bert, bert-generation, big_bird, bigbird_pegasus, biogpt, bit, bitnet, blenderbot, blenderbot-small, blip, blip-2, blip_2_qformer, bloom, bridgetower, bros, camembert, canine, chameleon, chinese_clip, chinese_clip_vision_model, clap, clip, clip_text_model, clip_vision_model, clipseg, clvp, code_llama, codegen, cohere, cohere2, colpali, colqwen2, conditional_detr, convbert, convnext, convnextv2, cpmant, csm, ctrl, cvt, d_fine, dab-detr, dac, data2vec-audio, data2vec-text, data2vec-vision, dbrx, deberta, deberta-v2, decision_transformer, deepseek_v3, deformable_detr, deit, depth_anything, depth_pro, deta, detr, dia, diffllama, dinat, dinov2, dinov2_with_registers, distilbert, donut-swin, dots1, dpr, dpt, efficientformer, efficientnet, electra, emu3, encodec, encoder-decoder, ernie, ernie_m, esm, falcon, falcon_h1, falcon_mamba, fastspeech2_conformer, flaubert, flava, fnet, focalnet, fsmt, funnel, fuyu, gemma, gemma2, gemma3, gemma3_text, gemma3n, gemma3n_audio, gemma3n_text, gemma3n_vision, git, glm, glm4, glm4v, glm4v_text, glpn, got_ocr2, gpt-sw3, gpt2, gpt_bigcode, gpt_neo, gpt_neox, gpt_neox_japanese, gptj, gptsan-japanese, granite, granite_speech, granitemoe, granitemoehybrid, granitemoeshared, granitevision, graphormer, grounding-dino, groupvit, helium, hgnet_v2, hiera, hubert, ibert, idefics, idefics2, idefics3, idefics3_vision, ijepa, imagegpt, informer, instructblip, instructblipvideo, internvl, internvl_vision, jamba, janus, jetmoe, jukebox, kosmos-2, kyutai_speech_to_text, layoutlm, layoutlmv2, layoutlmv3, led, levit, lightglue, lilt, llama, llama4, llama4_text, llava, llava_next, llava_next_video, llava_onevision, longformer, longt5, luke, lxmert, m2m_100, mamba, mamba2, marian, markuplm, mask2former, maskformer, maskformer-swin, mbart, mctct, mega, megatron-bert, mgp-str, mimi, minimax, mistral, mistral3, mixtral, mlcd, mllama, mobilebert, mobilenet_v1, mobilenet_v2, mobilevit, mobilevitv2, modernbert, moonshine, moshi, mpnet, mpt, mra, mt5, musicgen, musicgen_melody, mvp, nat, nemotron, nezha, nllb-moe, nougat, nystromformer, olmo, olmo2, olmoe, omdet-turbo, oneformer, open-llama, openai-gpt, opt, owlv2, owlvit, paligemma, patchtsmixer, patchtst, pegasus, pegasus_x, perceiver, persimmon, phi, phi3, phi4_multimodal, phimoe, pix2struct, pixtral, plbart, poolformer, pop2piano, prompt_depth_anything, prophetnet, pvt, pvt_v2, qdqbert, qwen2, qwen2_5_omni, qwen2_5_vl, qwen2_5_vl_text, qwen2_audio, qwen2_audio_encoder, qwen2_moe, qwen2_vl, qwen2_vl_text, qwen3, qwen3_moe, rag, realm, recurrent_gemma, reformer, regnet, rembert, resnet, retribert, roberta, roberta-prelayernorm, roc_bert, roformer, rt_detr, rt_detr_resnet, rt_detr_v2, rwkv, sam, sam_hq, sam_hq_vision_model, sam_vision_model, seamless_m4t, seamless_m4t_v2, segformer, seggpt, sew, sew-d, shieldgemma2, siglip, siglip2, siglip_vision_model, smollm3, smolvlm, smolvlm_vision, speech-encoder-decoder, speech_to_text, speech_to_text_2, speecht5, splinter, squeezebert, stablelm, starcoder2, superglue, superpoint, swiftformer, swin, swin2sr, swinv2, switch_transformers, t5, t5gemma, table-transformer, tapas, textnet, time_series_transformer, timesfm, timesformer, timm_backbone, timm_wrapper, trajectory_transformer, transfo-xl, trocr, tvlt, tvp, udop, umt5, unispeech, unispeech-sat, univnet, upernet, van, video_llava, videomae, vilt, vipllava, vision-encoder-decoder, vision-text-dual-encoder, visual_bert, vit, vit_hybrid, vit_mae, vit_msn, vitdet, vitmatte, vitpose, vitpose_backbone, vits, vivit, vjepa2, wav2vec2, wav2vec2-bert, wav2vec2-conformer, wavlm, whisper, xclip, xglm, xlm, xlm-prophetnet, xlm-roberta, xlm-roberta-xl, xlnet, xmod, yolos, yoso, zamba, zamba2, zoedepth"}
{"timestamp": "2026-01-18T00:35:57.920826", "level": "INFO", "logger": "ml_coder.registry_predictor", "message": "Loading registry model from data/models/registry_classifier.pkl"}
{"timestamp": "2026-01-18T00:35:57.957844", "level": "INFO", "logger": "ml_coder.registry_predictor", "message": "Loaded 21 labels from MLB"}
{"timestamp": "2026-01-18T00:35:57.958011", "level": "INFO", "logger": "ml_coder.registry_predictor", "message": "RegistryMLPredictor initialized with 21 labels"}
{"timestamp": "2026-01-18T00:35:57.958058", "level": "INFO", "logger": "registry_service", "message": "Using RegistryMLPredictor (TF-IDF) with 21 labels"}
{"timestamp": "2026-01-18T00:35:57.976977", "level": "WARNING", "logger": "coder.parallel_pathway", "message": "Path B failed: 'list' object has no attribute 'predictions'"}
{"timestamp": "2026-01-18T00:35:57.977276", "level": "INFO", "logger": "ml_coder.predictor", "message": "Loading model from data/models/cpt_classifier.pkl"}
{"timestamp": "2026-01-18T00:35:58.004915", "level": "INFO", "logger": "ml_coder.predictor", "message": "Predictor initialized with 35 labels, upper=0.70, lower=0.40"}
------------------------------ Captured log call -------------------------------
WARNING  ner.inference:inference.py:150 GranularNERPredictor unavailable: Model directory not found: artifacts/granular_ner_model
INFO     coder.parallel_pathway:orchestrator.py:157 ParallelPathwayOrchestrator initialized: NER=unavailable, ML=unavailable
WARNING  registry.inference_pytorch:inference_pytorch.py:78 TorchRegistryPredictor unavailable: Unrecognized model in data/models/registry_runtime. Should have a `model_type` key in its config.json, or contain one of the following strings in its name: albert, align, altclip, arcee, aria, aria_text, audio-spectrogram-transformer, autoformer, aya_vision, bamba, bark, bart, beit, bert, bert-generation, big_bird, bigbird_pegasus, biogpt, bit, bitnet, blenderbot, blenderbot-small, blip, blip-2, blip_2_qformer, bloom, bridgetower, bros, camembert, canine, chameleon, chinese_clip, chinese_clip_vision_model, clap, clip, clip_text_model, clip_vision_model, clipseg, clvp, code_llama, codegen, cohere, cohere2, colpali, colqwen2, conditional_detr, convbert, convnext, convnextv2, cpmant, csm, ctrl, cvt, d_fine, dab-detr, dac, data2vec-audio, data2vec-text, data2vec-vision, dbrx, deberta, deberta-v2, decision_transformer, deepseek_v3, deformable_detr, deit, depth_anything, depth_pro, deta, detr, dia, diffllama, dinat, dinov2, dinov2_with_registers, distilbert, donut-swin, dots1, dpr, dpt, efficientformer, efficientnet, electra, emu3, encodec, encoder-decoder, ernie, ernie_m, esm, falcon, falcon_h1, falcon_mamba, fastspeech2_conformer, flaubert, flava, fnet, focalnet, fsmt, funnel, fuyu, gemma, gemma2, gemma3, gemma3_text, gemma3n, gemma3n_audio, gemma3n_text, gemma3n_vision, git, glm, glm4, glm4v, glm4v_text, glpn, got_ocr2, gpt-sw3, gpt2, gpt_bigcode, gpt_neo, gpt_neox, gpt_neox_japanese, gptj, gptsan-japanese, granite, granite_speech, granitemoe, granitemoehybrid, granitemoeshared, granitevision, graphormer, grounding-dino, groupvit, helium, hgnet_v2, hiera, hubert, ibert, idefics, idefics2, idefics3, idefics3_vision, ijepa, imagegpt, informer, instructblip, instructblipvideo, internvl, internvl_vision, jamba, janus, jetmoe, jukebox, kosmos-2, kyutai_speech_to_text, layoutlm, layoutlmv2, layoutlmv3, led, levit, lightglue, lilt, llama, llama4, llama4_text, llava, llava_next, llava_next_video, llava_onevision, longformer, longt5, luke, lxmert, m2m_100, mamba, mamba2, marian, markuplm, mask2former, maskformer, maskformer-swin, mbart, mctct, mega, megatron-bert, mgp-str, mimi, minimax, mistral, mistral3, mixtral, mlcd, mllama, mobilebert, mobilenet_v1, mobilenet_v2, mobilevit, mobilevitv2, modernbert, moonshine, moshi, mpnet, mpt, mra, mt5, musicgen, musicgen_melody, mvp, nat, nemotron, nezha, nllb-moe, nougat, nystromformer, olmo, olmo2, olmoe, omdet-turbo, oneformer, open-llama, openai-gpt, opt, owlv2, owlvit, paligemma, patchtsmixer, patchtst, pegasus, pegasus_x, perceiver, persimmon, phi, phi3, phi4_multimodal, phimoe, pix2struct, pixtral, plbart, poolformer, pop2piano, prompt_depth_anything, prophetnet, pvt, pvt_v2, qdqbert, qwen2, qwen2_5_omni, qwen2_5_vl, qwen2_5_vl_text, qwen2_audio, qwen2_audio_encoder, qwen2_moe, qwen2_vl, qwen2_vl_text, qwen3, qwen3_moe, rag, realm, recurrent_gemma, reformer, regnet, rembert, resnet, retribert, roberta, roberta-prelayernorm, roc_bert, roformer, rt_detr, rt_detr_resnet, rt_detr_v2, rwkv, sam, sam_hq, sam_hq_vision_model, sam_vision_model, seamless_m4t, seamless_m4t_v2, segformer, seggpt, sew, sew-d, shieldgemma2, siglip, siglip2, siglip_vision_model, smollm3, smolvlm, smolvlm_vision, speech-encoder-decoder, speech_to_text, speech_to_text_2, speecht5, splinter, squeezebert, stablelm, starcoder2, superglue, superpoint, swiftformer, swin, swin2sr, swinv2, switch_transformers, t5, t5gemma, table-transformer, tapas, textnet, time_series_transformer, timesfm, timesformer, timm_backbone, timm_wrapper, trajectory_transformer, transfo-xl, trocr, tvlt, tvp, udop, umt5, unispeech, unispeech-sat, univnet, upernet, van, video_llava, videomae, vilt, vipllava, vision-encoder-decoder, vision-text-dual-encoder, visual_bert, vit, vit_hybrid, vit_mae, vit_msn, vitdet, vitmatte, vitpose, vitpose_backbone, vits, vivit, vjepa2, wav2vec2, wav2vec2-bert, wav2vec2-conformer, wavlm, whisper, xclip, xglm, xlm, xlm-prophetnet, xlm-roberta, xlm-roberta-xl, xlnet, xmod, yolos, yoso, zamba, zamba2, zoedepth
INFO     ml_coder.registry_predictor:registry_predictor.py:156 Loading registry model from data/models/registry_classifier.pkl
INFO     ml_coder.registry_predictor:registry_predictor.py:163 Loaded 21 labels from MLB
INFO     ml_coder.registry_predictor:registry_predictor.py:180 RegistryMLPredictor initialized with 21 labels
INFO     registry_service:registry_service.py:337 Using RegistryMLPredictor (TF-IDF) with 21 labels
WARNING  coder.parallel_pathway:orchestrator.py:430 Path B failed: 'list' object has no attribute 'predictions'
INFO     ml_coder.predictor:predictor.py:175 Loading model from data/models/cpt_classifier.pkl
INFO     ml_coder.predictor:predictor.py:185 Predictor initialized with 35 labels, upper=0.70, lower=0.40
______ TestRegistryServiceHybridFlow.test_low_conf_triggers_manual_review ______

self = <test_registry_service_hybrid_flow.TestRegistryServiceHybridFlow object at 0x181094090>

    def test_low_conf_triggers_manual_review(self) -> None:
        """LOW_CONF difficulty should trigger manual review."""
        fake_orchestrator = MagicMock()
        fake_orchestrator.get_codes.return_value = make_fake_hybrid_result(
            codes=["31622"],
            difficulty="low_confidence",
        )
    
        preset_record = RegistryRecord(procedure_type="bronchoscopy")
        stub_engine = StubRegistryEngine(preset_record=preset_record)
    
        service = RegistryService(
            hybrid_orchestrator=fake_orchestrator,
            registry_engine=stub_engine,
        )
    
        result = service.extract_fields("Diagnostic bronchoscopy")
    
>       assert result.needs_manual_review is True
E       assert False is True
E        +  where False = RegistryExtractionResult(record=RegistryRecord(patient_mrn=None, procedure_date=None, procedure_start_time=None, proce...ConfigSnapshot(use_buckets=True, top_k=25, min_prob=0.5, self_correct_min_prob=0.95), warnings=[]), self_correction=[]).needs_manual_review

tests/registry/test_registry_service_hybrid_flow.py:432: AssertionError
----------------------------- Captured stderr call -----------------------------
{"timestamp": "2026-01-18T00:35:58.031604", "level": "WARNING", "logger": "ner.inference", "message": "GranularNERPredictor unavailable: Model directory not found: artifacts/granular_ner_model"}
{"timestamp": "2026-01-18T00:35:58.031710", "level": "INFO", "logger": "coder.parallel_pathway", "message": "ParallelPathwayOrchestrator initialized: NER=unavailable, ML=unavailable"}
{"timestamp": "2026-01-18T00:35:58.048129", "level": "WARNING", "logger": "registry.inference_pytorch", "message": "TorchRegistryPredictor unavailable: Unrecognized model in data/models/registry_runtime. Should have a `model_type` key in its config.json, or contain one of the following strings in its name: albert, align, altclip, arcee, aria, aria_text, audio-spectrogram-transformer, autoformer, aya_vision, bamba, bark, bart, beit, bert, bert-generation, big_bird, bigbird_pegasus, biogpt, bit, bitnet, blenderbot, blenderbot-small, blip, blip-2, blip_2_qformer, bloom, bridgetower, bros, camembert, canine, chameleon, chinese_clip, chinese_clip_vision_model, clap, clip, clip_text_model, clip_vision_model, clipseg, clvp, code_llama, codegen, cohere, cohere2, colpali, colqwen2, conditional_detr, convbert, convnext, convnextv2, cpmant, csm, ctrl, cvt, d_fine, dab-detr, dac, data2vec-audio, data2vec-text, data2vec-vision, dbrx, deberta, deberta-v2, decision_transformer, deepseek_v3, deformable_detr, deit, depth_anything, depth_pro, deta, detr, dia, diffllama, dinat, dinov2, dinov2_with_registers, distilbert, donut-swin, dots1, dpr, dpt, efficientformer, efficientnet, electra, emu3, encodec, encoder-decoder, ernie, ernie_m, esm, falcon, falcon_h1, falcon_mamba, fastspeech2_conformer, flaubert, flava, fnet, focalnet, fsmt, funnel, fuyu, gemma, gemma2, gemma3, gemma3_text, gemma3n, gemma3n_audio, gemma3n_text, gemma3n_vision, git, glm, glm4, glm4v, glm4v_text, glpn, got_ocr2, gpt-sw3, gpt2, gpt_bigcode, gpt_neo, gpt_neox, gpt_neox_japanese, gptj, gptsan-japanese, granite, granite_speech, granitemoe, granitemoehybrid, granitemoeshared, granitevision, graphormer, grounding-dino, groupvit, helium, hgnet_v2, hiera, hubert, ibert, idefics, idefics2, idefics3, idefics3_vision, ijepa, imagegpt, informer, instructblip, instructblipvideo, internvl, internvl_vision, jamba, janus, jetmoe, jukebox, kosmos-2, kyutai_speech_to_text, layoutlm, layoutlmv2, layoutlmv3, led, levit, lightglue, lilt, llama, llama4, llama4_text, llava, llava_next, llava_next_video, llava_onevision, longformer, longt5, luke, lxmert, m2m_100, mamba, mamba2, marian, markuplm, mask2former, maskformer, maskformer-swin, mbart, mctct, mega, megatron-bert, mgp-str, mimi, minimax, mistral, mistral3, mixtral, mlcd, mllama, mobilebert, mobilenet_v1, mobilenet_v2, mobilevit, mobilevitv2, modernbert, moonshine, moshi, mpnet, mpt, mra, mt5, musicgen, musicgen_melody, mvp, nat, nemotron, nezha, nllb-moe, nougat, nystromformer, olmo, olmo2, olmoe, omdet-turbo, oneformer, open-llama, openai-gpt, opt, owlv2, owlvit, paligemma, patchtsmixer, patchtst, pegasus, pegasus_x, perceiver, persimmon, phi, phi3, phi4_multimodal, phimoe, pix2struct, pixtral, plbart, poolformer, pop2piano, prompt_depth_anything, prophetnet, pvt, pvt_v2, qdqbert, qwen2, qwen2_5_omni, qwen2_5_vl, qwen2_5_vl_text, qwen2_audio, qwen2_audio_encoder, qwen2_moe, qwen2_vl, qwen2_vl_text, qwen3, qwen3_moe, rag, realm, recurrent_gemma, reformer, regnet, rembert, resnet, retribert, roberta, roberta-prelayernorm, roc_bert, roformer, rt_detr, rt_detr_resnet, rt_detr_v2, rwkv, sam, sam_hq, sam_hq_vision_model, sam_vision_model, seamless_m4t, seamless_m4t_v2, segformer, seggpt, sew, sew-d, shieldgemma2, siglip, siglip2, siglip_vision_model, smollm3, smolvlm, smolvlm_vision, speech-encoder-decoder, speech_to_text, speech_to_text_2, speecht5, splinter, squeezebert, stablelm, starcoder2, superglue, superpoint, swiftformer, swin, swin2sr, swinv2, switch_transformers, t5, t5gemma, table-transformer, tapas, textnet, time_series_transformer, timesfm, timesformer, timm_backbone, timm_wrapper, trajectory_transformer, transfo-xl, trocr, tvlt, tvp, udop, umt5, unispeech, unispeech-sat, univnet, upernet, van, video_llava, videomae, vilt, vipllava, vision-encoder-decoder, vision-text-dual-encoder, visual_bert, vit, vit_hybrid, vit_mae, vit_msn, vitdet, vitmatte, vitpose, vitpose_backbone, vits, vivit, vjepa2, wav2vec2, wav2vec2-bert, wav2vec2-conformer, wavlm, whisper, xclip, xglm, xlm, xlm-prophetnet, xlm-roberta, xlm-roberta-xl, xlnet, xmod, yolos, yoso, zamba, zamba2, zoedepth"}
{"timestamp": "2026-01-18T00:35:58.048252", "level": "INFO", "logger": "ml_coder.registry_predictor", "message": "Loading registry model from data/models/registry_classifier.pkl"}
{"timestamp": "2026-01-18T00:35:58.080479", "level": "INFO", "logger": "ml_coder.registry_predictor", "message": "Loaded 21 labels from MLB"}
{"timestamp": "2026-01-18T00:35:58.080655", "level": "INFO", "logger": "ml_coder.registry_predictor", "message": "RegistryMLPredictor initialized with 21 labels"}
{"timestamp": "2026-01-18T00:35:58.080706", "level": "INFO", "logger": "registry_service", "message": "Using RegistryMLPredictor (TF-IDF) with 21 labels"}
{"timestamp": "2026-01-18T00:35:58.097819", "level": "WARNING", "logger": "coder.parallel_pathway", "message": "Path B failed: 'list' object has no attribute 'predictions'"}
{"timestamp": "2026-01-18T00:35:58.098030", "level": "INFO", "logger": "ml_coder.predictor", "message": "Loading model from data/models/cpt_classifier.pkl"}
{"timestamp": "2026-01-18T00:35:58.124299", "level": "INFO", "logger": "ml_coder.predictor", "message": "Predictor initialized with 35 labels, upper=0.70, lower=0.40"}
------------------------------ Captured log call -------------------------------
WARNING  ner.inference:inference.py:150 GranularNERPredictor unavailable: Model directory not found: artifacts/granular_ner_model
INFO     coder.parallel_pathway:orchestrator.py:157 ParallelPathwayOrchestrator initialized: NER=unavailable, ML=unavailable
WARNING  registry.inference_pytorch:inference_pytorch.py:78 TorchRegistryPredictor unavailable: Unrecognized model in data/models/registry_runtime. Should have a `model_type` key in its config.json, or contain one of the following strings in its name: albert, align, altclip, arcee, aria, aria_text, audio-spectrogram-transformer, autoformer, aya_vision, bamba, bark, bart, beit, bert, bert-generation, big_bird, bigbird_pegasus, biogpt, bit, bitnet, blenderbot, blenderbot-small, blip, blip-2, blip_2_qformer, bloom, bridgetower, bros, camembert, canine, chameleon, chinese_clip, chinese_clip_vision_model, clap, clip, clip_text_model, clip_vision_model, clipseg, clvp, code_llama, codegen, cohere, cohere2, colpali, colqwen2, conditional_detr, convbert, convnext, convnextv2, cpmant, csm, ctrl, cvt, d_fine, dab-detr, dac, data2vec-audio, data2vec-text, data2vec-vision, dbrx, deberta, deberta-v2, decision_transformer, deepseek_v3, deformable_detr, deit, depth_anything, depth_pro, deta, detr, dia, diffllama, dinat, dinov2, dinov2_with_registers, distilbert, donut-swin, dots1, dpr, dpt, efficientformer, efficientnet, electra, emu3, encodec, encoder-decoder, ernie, ernie_m, esm, falcon, falcon_h1, falcon_mamba, fastspeech2_conformer, flaubert, flava, fnet, focalnet, fsmt, funnel, fuyu, gemma, gemma2, gemma3, gemma3_text, gemma3n, gemma3n_audio, gemma3n_text, gemma3n_vision, git, glm, glm4, glm4v, glm4v_text, glpn, got_ocr2, gpt-sw3, gpt2, gpt_bigcode, gpt_neo, gpt_neox, gpt_neox_japanese, gptj, gptsan-japanese, granite, granite_speech, granitemoe, granitemoehybrid, granitemoeshared, granitevision, graphormer, grounding-dino, groupvit, helium, hgnet_v2, hiera, hubert, ibert, idefics, idefics2, idefics3, idefics3_vision, ijepa, imagegpt, informer, instructblip, instructblipvideo, internvl, internvl_vision, jamba, janus, jetmoe, jukebox, kosmos-2, kyutai_speech_to_text, layoutlm, layoutlmv2, layoutlmv3, led, levit, lightglue, lilt, llama, llama4, llama4_text, llava, llava_next, llava_next_video, llava_onevision, longformer, longt5, luke, lxmert, m2m_100, mamba, mamba2, marian, markuplm, mask2former, maskformer, maskformer-swin, mbart, mctct, mega, megatron-bert, mgp-str, mimi, minimax, mistral, mistral3, mixtral, mlcd, mllama, mobilebert, mobilenet_v1, mobilenet_v2, mobilevit, mobilevitv2, modernbert, moonshine, moshi, mpnet, mpt, mra, mt5, musicgen, musicgen_melody, mvp, nat, nemotron, nezha, nllb-moe, nougat, nystromformer, olmo, olmo2, olmoe, omdet-turbo, oneformer, open-llama, openai-gpt, opt, owlv2, owlvit, paligemma, patchtsmixer, patchtst, pegasus, pegasus_x, perceiver, persimmon, phi, phi3, phi4_multimodal, phimoe, pix2struct, pixtral, plbart, poolformer, pop2piano, prompt_depth_anything, prophetnet, pvt, pvt_v2, qdqbert, qwen2, qwen2_5_omni, qwen2_5_vl, qwen2_5_vl_text, qwen2_audio, qwen2_audio_encoder, qwen2_moe, qwen2_vl, qwen2_vl_text, qwen3, qwen3_moe, rag, realm, recurrent_gemma, reformer, regnet, rembert, resnet, retribert, roberta, roberta-prelayernorm, roc_bert, roformer, rt_detr, rt_detr_resnet, rt_detr_v2, rwkv, sam, sam_hq, sam_hq_vision_model, sam_vision_model, seamless_m4t, seamless_m4t_v2, segformer, seggpt, sew, sew-d, shieldgemma2, siglip, siglip2, siglip_vision_model, smollm3, smolvlm, smolvlm_vision, speech-encoder-decoder, speech_to_text, speech_to_text_2, speecht5, splinter, squeezebert, stablelm, starcoder2, superglue, superpoint, swiftformer, swin, swin2sr, swinv2, switch_transformers, t5, t5gemma, table-transformer, tapas, textnet, time_series_transformer, timesfm, timesformer, timm_backbone, timm_wrapper, trajectory_transformer, transfo-xl, trocr, tvlt, tvp, udop, umt5, unispeech, unispeech-sat, univnet, upernet, van, video_llava, videomae, vilt, vipllava, vision-encoder-decoder, vision-text-dual-encoder, visual_bert, vit, vit_hybrid, vit_mae, vit_msn, vitdet, vitmatte, vitpose, vitpose_backbone, vits, vivit, vjepa2, wav2vec2, wav2vec2-bert, wav2vec2-conformer, wavlm, whisper, xclip, xglm, xlm, xlm-prophetnet, xlm-roberta, xlm-roberta-xl, xlnet, xmod, yolos, yoso, zamba, zamba2, zoedepth
INFO     ml_coder.registry_predictor:registry_predictor.py:156 Loading registry model from data/models/registry_classifier.pkl
INFO     ml_coder.registry_predictor:registry_predictor.py:163 Loaded 21 labels from MLB
INFO     ml_coder.registry_predictor:registry_predictor.py:180 RegistryMLPredictor initialized with 21 labels
INFO     registry_service:registry_service.py:337 Using RegistryMLPredictor (TF-IDF) with 21 labels
WARNING  coder.parallel_pathway:orchestrator.py:430 Path B failed: 'list' object has no attribute 'predictions'
INFO     ml_coder.predictor:predictor.py:175 Loading model from data/models/cpt_classifier.pkl
INFO     ml_coder.predictor:predictor.py:185 Predictor initialized with 35 labels, upper=0.70, lower=0.40
_____ TestRegistryServiceHybridFlow.test_gray_zone_triggers_manual_review ______

self = <test_registry_service_hybrid_flow.TestRegistryServiceHybridFlow object at 0x181094450>

    def test_gray_zone_triggers_manual_review(self) -> None:
        """GRAY_ZONE difficulty should trigger manual review."""
        fake_orchestrator = MagicMock()
        fake_orchestrator.get_codes.return_value = make_fake_hybrid_result(
            codes=["31652"],
            difficulty="gray_zone",
        )
    
        preset_record = RegistryRecord(
            procedure_type="bronchoscopy",
            procedures_performed={"linear_ebus": {"performed": True}},
        )
        stub_engine = StubRegistryEngine(preset_record=preset_record)
    
        service = RegistryService(
            hybrid_orchestrator=fake_orchestrator,
            registry_engine=stub_engine,
        )
    
        result = service.extract_fields("EBUS-TBNA performed")
    
>       assert result.needs_manual_review is True
E       assert False is True
E        +  where False = RegistryExtractionResult(record=RegistryRecord(patient_mrn=None, procedure_date=None, procedure_start_time=None, proce...ConfigSnapshot(use_buckets=True, top_k=25, min_prob=0.5, self_correct_min_prob=0.95), warnings=[]), self_correction=[]).needs_manual_review

tests/registry/test_registry_service_hybrid_flow.py:457: AssertionError
----------------------------- Captured stderr call -----------------------------
{"timestamp": "2026-01-18T00:35:58.153365", "level": "WARNING", "logger": "ner.inference", "message": "GranularNERPredictor unavailable: Model directory not found: artifacts/granular_ner_model"}
{"timestamp": "2026-01-18T00:35:58.153484", "level": "INFO", "logger": "coder.parallel_pathway", "message": "ParallelPathwayOrchestrator initialized: NER=unavailable, ML=unavailable"}
{"timestamp": "2026-01-18T00:35:58.169777", "level": "WARNING", "logger": "registry.inference_pytorch", "message": "TorchRegistryPredictor unavailable: Unrecognized model in data/models/registry_runtime. Should have a `model_type` key in its config.json, or contain one of the following strings in its name: albert, align, altclip, arcee, aria, aria_text, audio-spectrogram-transformer, autoformer, aya_vision, bamba, bark, bart, beit, bert, bert-generation, big_bird, bigbird_pegasus, biogpt, bit, bitnet, blenderbot, blenderbot-small, blip, blip-2, blip_2_qformer, bloom, bridgetower, bros, camembert, canine, chameleon, chinese_clip, chinese_clip_vision_model, clap, clip, clip_text_model, clip_vision_model, clipseg, clvp, code_llama, codegen, cohere, cohere2, colpali, colqwen2, conditional_detr, convbert, convnext, convnextv2, cpmant, csm, ctrl, cvt, d_fine, dab-detr, dac, data2vec-audio, data2vec-text, data2vec-vision, dbrx, deberta, deberta-v2, decision_transformer, deepseek_v3, deformable_detr, deit, depth_anything, depth_pro, deta, detr, dia, diffllama, dinat, dinov2, dinov2_with_registers, distilbert, donut-swin, dots1, dpr, dpt, efficientformer, efficientnet, electra, emu3, encodec, encoder-decoder, ernie, ernie_m, esm, falcon, falcon_h1, falcon_mamba, fastspeech2_conformer, flaubert, flava, fnet, focalnet, fsmt, funnel, fuyu, gemma, gemma2, gemma3, gemma3_text, gemma3n, gemma3n_audio, gemma3n_text, gemma3n_vision, git, glm, glm4, glm4v, glm4v_text, glpn, got_ocr2, gpt-sw3, gpt2, gpt_bigcode, gpt_neo, gpt_neox, gpt_neox_japanese, gptj, gptsan-japanese, granite, granite_speech, granitemoe, granitemoehybrid, granitemoeshared, granitevision, graphormer, grounding-dino, groupvit, helium, hgnet_v2, hiera, hubert, ibert, idefics, idefics2, idefics3, idefics3_vision, ijepa, imagegpt, informer, instructblip, instructblipvideo, internvl, internvl_vision, jamba, janus, jetmoe, jukebox, kosmos-2, kyutai_speech_to_text, layoutlm, layoutlmv2, layoutlmv3, led, levit, lightglue, lilt, llama, llama4, llama4_text, llava, llava_next, llava_next_video, llava_onevision, longformer, longt5, luke, lxmert, m2m_100, mamba, mamba2, marian, markuplm, mask2former, maskformer, maskformer-swin, mbart, mctct, mega, megatron-bert, mgp-str, mimi, minimax, mistral, mistral3, mixtral, mlcd, mllama, mobilebert, mobilenet_v1, mobilenet_v2, mobilevit, mobilevitv2, modernbert, moonshine, moshi, mpnet, mpt, mra, mt5, musicgen, musicgen_melody, mvp, nat, nemotron, nezha, nllb-moe, nougat, nystromformer, olmo, olmo2, olmoe, omdet-turbo, oneformer, open-llama, openai-gpt, opt, owlv2, owlvit, paligemma, patchtsmixer, patchtst, pegasus, pegasus_x, perceiver, persimmon, phi, phi3, phi4_multimodal, phimoe, pix2struct, pixtral, plbart, poolformer, pop2piano, prompt_depth_anything, prophetnet, pvt, pvt_v2, qdqbert, qwen2, qwen2_5_omni, qwen2_5_vl, qwen2_5_vl_text, qwen2_audio, qwen2_audio_encoder, qwen2_moe, qwen2_vl, qwen2_vl_text, qwen3, qwen3_moe, rag, realm, recurrent_gemma, reformer, regnet, rembert, resnet, retribert, roberta, roberta-prelayernorm, roc_bert, roformer, rt_detr, rt_detr_resnet, rt_detr_v2, rwkv, sam, sam_hq, sam_hq_vision_model, sam_vision_model, seamless_m4t, seamless_m4t_v2, segformer, seggpt, sew, sew-d, shieldgemma2, siglip, siglip2, siglip_vision_model, smollm3, smolvlm, smolvlm_vision, speech-encoder-decoder, speech_to_text, speech_to_text_2, speecht5, splinter, squeezebert, stablelm, starcoder2, superglue, superpoint, swiftformer, swin, swin2sr, swinv2, switch_transformers, t5, t5gemma, table-transformer, tapas, textnet, time_series_transformer, timesfm, timesformer, timm_backbone, timm_wrapper, trajectory_transformer, transfo-xl, trocr, tvlt, tvp, udop, umt5, unispeech, unispeech-sat, univnet, upernet, van, video_llava, videomae, vilt, vipllava, vision-encoder-decoder, vision-text-dual-encoder, visual_bert, vit, vit_hybrid, vit_mae, vit_msn, vitdet, vitmatte, vitpose, vitpose_backbone, vits, vivit, vjepa2, wav2vec2, wav2vec2-bert, wav2vec2-conformer, wavlm, whisper, xclip, xglm, xlm, xlm-prophetnet, xlm-roberta, xlm-roberta-xl, xlnet, xmod, yolos, yoso, zamba, zamba2, zoedepth"}
{"timestamp": "2026-01-18T00:35:58.169886", "level": "INFO", "logger": "ml_coder.registry_predictor", "message": "Loading registry model from data/models/registry_classifier.pkl"}
{"timestamp": "2026-01-18T00:35:58.202170", "level": "INFO", "logger": "ml_coder.registry_predictor", "message": "Loaded 21 labels from MLB"}
{"timestamp": "2026-01-18T00:35:58.202345", "level": "INFO", "logger": "ml_coder.registry_predictor", "message": "RegistryMLPredictor initialized with 21 labels"}
{"timestamp": "2026-01-18T00:35:58.202389", "level": "INFO", "logger": "registry_service", "message": "Using RegistryMLPredictor (TF-IDF) with 21 labels"}
{"timestamp": "2026-01-18T00:35:58.220546", "level": "WARNING", "logger": "coder.parallel_pathway", "message": "Path B failed: 'list' object has no attribute 'predictions'"}
{"timestamp": "2026-01-18T00:35:58.220837", "level": "INFO", "logger": "ml_coder.predictor", "message": "Loading model from data/models/cpt_classifier.pkl"}
{"timestamp": "2026-01-18T00:35:58.247960", "level": "INFO", "logger": "ml_coder.predictor", "message": "Predictor initialized with 35 labels, upper=0.70, lower=0.40"}
------------------------------ Captured log call -------------------------------
WARNING  ner.inference:inference.py:150 GranularNERPredictor unavailable: Model directory not found: artifacts/granular_ner_model
INFO     coder.parallel_pathway:orchestrator.py:157 ParallelPathwayOrchestrator initialized: NER=unavailable, ML=unavailable
WARNING  registry.inference_pytorch:inference_pytorch.py:78 TorchRegistryPredictor unavailable: Unrecognized model in data/models/registry_runtime. Should have a `model_type` key in its config.json, or contain one of the following strings in its name: albert, align, altclip, arcee, aria, aria_text, audio-spectrogram-transformer, autoformer, aya_vision, bamba, bark, bart, beit, bert, bert-generation, big_bird, bigbird_pegasus, biogpt, bit, bitnet, blenderbot, blenderbot-small, blip, blip-2, blip_2_qformer, bloom, bridgetower, bros, camembert, canine, chameleon, chinese_clip, chinese_clip_vision_model, clap, clip, clip_text_model, clip_vision_model, clipseg, clvp, code_llama, codegen, cohere, cohere2, colpali, colqwen2, conditional_detr, convbert, convnext, convnextv2, cpmant, csm, ctrl, cvt, d_fine, dab-detr, dac, data2vec-audio, data2vec-text, data2vec-vision, dbrx, deberta, deberta-v2, decision_transformer, deepseek_v3, deformable_detr, deit, depth_anything, depth_pro, deta, detr, dia, diffllama, dinat, dinov2, dinov2_with_registers, distilbert, donut-swin, dots1, dpr, dpt, efficientformer, efficientnet, electra, emu3, encodec, encoder-decoder, ernie, ernie_m, esm, falcon, falcon_h1, falcon_mamba, fastspeech2_conformer, flaubert, flava, fnet, focalnet, fsmt, funnel, fuyu, gemma, gemma2, gemma3, gemma3_text, gemma3n, gemma3n_audio, gemma3n_text, gemma3n_vision, git, glm, glm4, glm4v, glm4v_text, glpn, got_ocr2, gpt-sw3, gpt2, gpt_bigcode, gpt_neo, gpt_neox, gpt_neox_japanese, gptj, gptsan-japanese, granite, granite_speech, granitemoe, granitemoehybrid, granitemoeshared, granitevision, graphormer, grounding-dino, groupvit, helium, hgnet_v2, hiera, hubert, ibert, idefics, idefics2, idefics3, idefics3_vision, ijepa, imagegpt, informer, instructblip, instructblipvideo, internvl, internvl_vision, jamba, janus, jetmoe, jukebox, kosmos-2, kyutai_speech_to_text, layoutlm, layoutlmv2, layoutlmv3, led, levit, lightglue, lilt, llama, llama4, llama4_text, llava, llava_next, llava_next_video, llava_onevision, longformer, longt5, luke, lxmert, m2m_100, mamba, mamba2, marian, markuplm, mask2former, maskformer, maskformer-swin, mbart, mctct, mega, megatron-bert, mgp-str, mimi, minimax, mistral, mistral3, mixtral, mlcd, mllama, mobilebert, mobilenet_v1, mobilenet_v2, mobilevit, mobilevitv2, modernbert, moonshine, moshi, mpnet, mpt, mra, mt5, musicgen, musicgen_melody, mvp, nat, nemotron, nezha, nllb-moe, nougat, nystromformer, olmo, olmo2, olmoe, omdet-turbo, oneformer, open-llama, openai-gpt, opt, owlv2, owlvit, paligemma, patchtsmixer, patchtst, pegasus, pegasus_x, perceiver, persimmon, phi, phi3, phi4_multimodal, phimoe, pix2struct, pixtral, plbart, poolformer, pop2piano, prompt_depth_anything, prophetnet, pvt, pvt_v2, qdqbert, qwen2, qwen2_5_omni, qwen2_5_vl, qwen2_5_vl_text, qwen2_audio, qwen2_audio_encoder, qwen2_moe, qwen2_vl, qwen2_vl_text, qwen3, qwen3_moe, rag, realm, recurrent_gemma, reformer, regnet, rembert, resnet, retribert, roberta, roberta-prelayernorm, roc_bert, roformer, rt_detr, rt_detr_resnet, rt_detr_v2, rwkv, sam, sam_hq, sam_hq_vision_model, sam_vision_model, seamless_m4t, seamless_m4t_v2, segformer, seggpt, sew, sew-d, shieldgemma2, siglip, siglip2, siglip_vision_model, smollm3, smolvlm, smolvlm_vision, speech-encoder-decoder, speech_to_text, speech_to_text_2, speecht5, splinter, squeezebert, stablelm, starcoder2, superglue, superpoint, swiftformer, swin, swin2sr, swinv2, switch_transformers, t5, t5gemma, table-transformer, tapas, textnet, time_series_transformer, timesfm, timesformer, timm_backbone, timm_wrapper, trajectory_transformer, transfo-xl, trocr, tvlt, tvp, udop, umt5, unispeech, unispeech-sat, univnet, upernet, van, video_llava, videomae, vilt, vipllava, vision-encoder-decoder, vision-text-dual-encoder, visual_bert, vit, vit_hybrid, vit_mae, vit_msn, vitdet, vitmatte, vitpose, vitpose_backbone, vits, vivit, vjepa2, wav2vec2, wav2vec2-bert, wav2vec2-conformer, wavlm, whisper, xclip, xglm, xlm, xlm-prophetnet, xlm-roberta, xlm-roberta-xl, xlnet, xmod, yolos, yoso, zamba, zamba2, zoedepth
INFO     ml_coder.registry_predictor:registry_predictor.py:156 Loading registry model from data/models/registry_classifier.pkl
INFO     ml_coder.registry_predictor:registry_predictor.py:163 Loaded 21 labels from MLB
INFO     ml_coder.registry_predictor:registry_predictor.py:180 RegistryMLPredictor initialized with 21 labels
INFO     registry_service:registry_service.py:337 Using RegistryMLPredictor (TF-IDF) with 21 labels
WARNING  coder.parallel_pathway:orchestrator.py:430 Path B failed: 'list' object has no attribute 'predictions'
INFO     ml_coder.predictor:predictor.py:175 Loading model from data/models/cpt_classifier.pkl
INFO     ml_coder.predictor:predictor.py:185 Predictor initialized with 35 labels, upper=0.70, lower=0.40
_______ TestRegistryServiceHybridFlow.test_no_orchestrator_fallback_mode _______

self = <test_registry_service_hybrid_flow.TestRegistryServiceHybridFlow object at 0x181094810>

    def test_no_orchestrator_fallback_mode(self) -> None:
        """Without hybrid orchestrator, service should fall back to extractor-only mode."""
        preset_record = RegistryRecord(procedure_type="bronchoscopy")
        stub_engine = StubRegistryEngine(preset_record=preset_record)
    
        service = RegistryService(
            hybrid_orchestrator=None,  # No orchestrator
            registry_engine=stub_engine,
        )
    
        result = service.extract_fields("Diagnostic bronchoscopy")
    
        # Should work but with empty CPT info
        assert result.cpt_codes == []
>       assert result.coder_source == "extractor_only"
E       AssertionError: assert 'extraction_first' == 'extractor_only'
E         
E         - extractor_only
E         + extraction_first

tests/registry/test_registry_service_hybrid_flow.py:474: AssertionError
----------------------------- Captured stderr call -----------------------------
{"timestamp": "2026-01-18T00:35:58.274343", "level": "WARNING", "logger": "ner.inference", "message": "GranularNERPredictor unavailable: Model directory not found: artifacts/granular_ner_model"}
{"timestamp": "2026-01-18T00:35:58.274447", "level": "INFO", "logger": "coder.parallel_pathway", "message": "ParallelPathwayOrchestrator initialized: NER=unavailable, ML=unavailable"}
{"timestamp": "2026-01-18T00:35:58.291796", "level": "WARNING", "logger": "registry.inference_pytorch", "message": "TorchRegistryPredictor unavailable: Unrecognized model in data/models/registry_runtime. Should have a `model_type` key in its config.json, or contain one of the following strings in its name: albert, align, altclip, arcee, aria, aria_text, audio-spectrogram-transformer, autoformer, aya_vision, bamba, bark, bart, beit, bert, bert-generation, big_bird, bigbird_pegasus, biogpt, bit, bitnet, blenderbot, blenderbot-small, blip, blip-2, blip_2_qformer, bloom, bridgetower, bros, camembert, canine, chameleon, chinese_clip, chinese_clip_vision_model, clap, clip, clip_text_model, clip_vision_model, clipseg, clvp, code_llama, codegen, cohere, cohere2, colpali, colqwen2, conditional_detr, convbert, convnext, convnextv2, cpmant, csm, ctrl, cvt, d_fine, dab-detr, dac, data2vec-audio, data2vec-text, data2vec-vision, dbrx, deberta, deberta-v2, decision_transformer, deepseek_v3, deformable_detr, deit, depth_anything, depth_pro, deta, detr, dia, diffllama, dinat, dinov2, dinov2_with_registers, distilbert, donut-swin, dots1, dpr, dpt, efficientformer, efficientnet, electra, emu3, encodec, encoder-decoder, ernie, ernie_m, esm, falcon, falcon_h1, falcon_mamba, fastspeech2_conformer, flaubert, flava, fnet, focalnet, fsmt, funnel, fuyu, gemma, gemma2, gemma3, gemma3_text, gemma3n, gemma3n_audio, gemma3n_text, gemma3n_vision, git, glm, glm4, glm4v, glm4v_text, glpn, got_ocr2, gpt-sw3, gpt2, gpt_bigcode, gpt_neo, gpt_neox, gpt_neox_japanese, gptj, gptsan-japanese, granite, granite_speech, granitemoe, granitemoehybrid, granitemoeshared, granitevision, graphormer, grounding-dino, groupvit, helium, hgnet_v2, hiera, hubert, ibert, idefics, idefics2, idefics3, idefics3_vision, ijepa, imagegpt, informer, instructblip, instructblipvideo, internvl, internvl_vision, jamba, janus, jetmoe, jukebox, kosmos-2, kyutai_speech_to_text, layoutlm, layoutlmv2, layoutlmv3, led, levit, lightglue, lilt, llama, llama4, llama4_text, llava, llava_next, llava_next_video, llava_onevision, longformer, longt5, luke, lxmert, m2m_100, mamba, mamba2, marian, markuplm, mask2former, maskformer, maskformer-swin, mbart, mctct, mega, megatron-bert, mgp-str, mimi, minimax, mistral, mistral3, mixtral, mlcd, mllama, mobilebert, mobilenet_v1, mobilenet_v2, mobilevit, mobilevitv2, modernbert, moonshine, moshi, mpnet, mpt, mra, mt5, musicgen, musicgen_melody, mvp, nat, nemotron, nezha, nllb-moe, nougat, nystromformer, olmo, olmo2, olmoe, omdet-turbo, oneformer, open-llama, openai-gpt, opt, owlv2, owlvit, paligemma, patchtsmixer, patchtst, pegasus, pegasus_x, perceiver, persimmon, phi, phi3, phi4_multimodal, phimoe, pix2struct, pixtral, plbart, poolformer, pop2piano, prompt_depth_anything, prophetnet, pvt, pvt_v2, qdqbert, qwen2, qwen2_5_omni, qwen2_5_vl, qwen2_5_vl_text, qwen2_audio, qwen2_audio_encoder, qwen2_moe, qwen2_vl, qwen2_vl_text, qwen3, qwen3_moe, rag, realm, recurrent_gemma, reformer, regnet, rembert, resnet, retribert, roberta, roberta-prelayernorm, roc_bert, roformer, rt_detr, rt_detr_resnet, rt_detr_v2, rwkv, sam, sam_hq, sam_hq_vision_model, sam_vision_model, seamless_m4t, seamless_m4t_v2, segformer, seggpt, sew, sew-d, shieldgemma2, siglip, siglip2, siglip_vision_model, smollm3, smolvlm, smolvlm_vision, speech-encoder-decoder, speech_to_text, speech_to_text_2, speecht5, splinter, squeezebert, stablelm, starcoder2, superglue, superpoint, swiftformer, swin, swin2sr, swinv2, switch_transformers, t5, t5gemma, table-transformer, tapas, textnet, time_series_transformer, timesfm, timesformer, timm_backbone, timm_wrapper, trajectory_transformer, transfo-xl, trocr, tvlt, tvp, udop, umt5, unispeech, unispeech-sat, univnet, upernet, van, video_llava, videomae, vilt, vipllava, vision-encoder-decoder, vision-text-dual-encoder, visual_bert, vit, vit_hybrid, vit_mae, vit_msn, vitdet, vitmatte, vitpose, vitpose_backbone, vits, vivit, vjepa2, wav2vec2, wav2vec2-bert, wav2vec2-conformer, wavlm, whisper, xclip, xglm, xlm, xlm-prophetnet, xlm-roberta, xlm-roberta-xl, xlnet, xmod, yolos, yoso, zamba, zamba2, zoedepth"}
{"timestamp": "2026-01-18T00:35:58.291907", "level": "INFO", "logger": "ml_coder.registry_predictor", "message": "Loading registry model from data/models/registry_classifier.pkl"}
{"timestamp": "2026-01-18T00:35:58.326066", "level": "INFO", "logger": "ml_coder.registry_predictor", "message": "Loaded 21 labels from MLB"}
{"timestamp": "2026-01-18T00:35:58.326222", "level": "INFO", "logger": "ml_coder.registry_predictor", "message": "RegistryMLPredictor initialized with 21 labels"}
{"timestamp": "2026-01-18T00:35:58.326264", "level": "INFO", "logger": "registry_service", "message": "Using RegistryMLPredictor (TF-IDF) with 21 labels"}
{"timestamp": "2026-01-18T00:35:58.344220", "level": "WARNING", "logger": "coder.parallel_pathway", "message": "Path B failed: 'list' object has no attribute 'predictions'"}
{"timestamp": "2026-01-18T00:35:58.344455", "level": "INFO", "logger": "ml_coder.predictor", "message": "Loading model from data/models/cpt_classifier.pkl"}
{"timestamp": "2026-01-18T00:35:58.370747", "level": "INFO", "logger": "ml_coder.predictor", "message": "Predictor initialized with 35 labels, upper=0.70, lower=0.40"}
------------------------------ Captured log call -------------------------------
WARNING  ner.inference:inference.py:150 GranularNERPredictor unavailable: Model directory not found: artifacts/granular_ner_model
INFO     coder.parallel_pathway:orchestrator.py:157 ParallelPathwayOrchestrator initialized: NER=unavailable, ML=unavailable
WARNING  registry.inference_pytorch:inference_pytorch.py:78 TorchRegistryPredictor unavailable: Unrecognized model in data/models/registry_runtime. Should have a `model_type` key in its config.json, or contain one of the following strings in its name: albert, align, altclip, arcee, aria, aria_text, audio-spectrogram-transformer, autoformer, aya_vision, bamba, bark, bart, beit, bert, bert-generation, big_bird, bigbird_pegasus, biogpt, bit, bitnet, blenderbot, blenderbot-small, blip, blip-2, blip_2_qformer, bloom, bridgetower, bros, camembert, canine, chameleon, chinese_clip, chinese_clip_vision_model, clap, clip, clip_text_model, clip_vision_model, clipseg, clvp, code_llama, codegen, cohere, cohere2, colpali, colqwen2, conditional_detr, convbert, convnext, convnextv2, cpmant, csm, ctrl, cvt, d_fine, dab-detr, dac, data2vec-audio, data2vec-text, data2vec-vision, dbrx, deberta, deberta-v2, decision_transformer, deepseek_v3, deformable_detr, deit, depth_anything, depth_pro, deta, detr, dia, diffllama, dinat, dinov2, dinov2_with_registers, distilbert, donut-swin, dots1, dpr, dpt, efficientformer, efficientnet, electra, emu3, encodec, encoder-decoder, ernie, ernie_m, esm, falcon, falcon_h1, falcon_mamba, fastspeech2_conformer, flaubert, flava, fnet, focalnet, fsmt, funnel, fuyu, gemma, gemma2, gemma3, gemma3_text, gemma3n, gemma3n_audio, gemma3n_text, gemma3n_vision, git, glm, glm4, glm4v, glm4v_text, glpn, got_ocr2, gpt-sw3, gpt2, gpt_bigcode, gpt_neo, gpt_neox, gpt_neox_japanese, gptj, gptsan-japanese, granite, granite_speech, granitemoe, granitemoehybrid, granitemoeshared, granitevision, graphormer, grounding-dino, groupvit, helium, hgnet_v2, hiera, hubert, ibert, idefics, idefics2, idefics3, idefics3_vision, ijepa, imagegpt, informer, instructblip, instructblipvideo, internvl, internvl_vision, jamba, janus, jetmoe, jukebox, kosmos-2, kyutai_speech_to_text, layoutlm, layoutlmv2, layoutlmv3, led, levit, lightglue, lilt, llama, llama4, llama4_text, llava, llava_next, llava_next_video, llava_onevision, longformer, longt5, luke, lxmert, m2m_100, mamba, mamba2, marian, markuplm, mask2former, maskformer, maskformer-swin, mbart, mctct, mega, megatron-bert, mgp-str, mimi, minimax, mistral, mistral3, mixtral, mlcd, mllama, mobilebert, mobilenet_v1, mobilenet_v2, mobilevit, mobilevitv2, modernbert, moonshine, moshi, mpnet, mpt, mra, mt5, musicgen, musicgen_melody, mvp, nat, nemotron, nezha, nllb-moe, nougat, nystromformer, olmo, olmo2, olmoe, omdet-turbo, oneformer, open-llama, openai-gpt, opt, owlv2, owlvit, paligemma, patchtsmixer, patchtst, pegasus, pegasus_x, perceiver, persimmon, phi, phi3, phi4_multimodal, phimoe, pix2struct, pixtral, plbart, poolformer, pop2piano, prompt_depth_anything, prophetnet, pvt, pvt_v2, qdqbert, qwen2, qwen2_5_omni, qwen2_5_vl, qwen2_5_vl_text, qwen2_audio, qwen2_audio_encoder, qwen2_moe, qwen2_vl, qwen2_vl_text, qwen3, qwen3_moe, rag, realm, recurrent_gemma, reformer, regnet, rembert, resnet, retribert, roberta, roberta-prelayernorm, roc_bert, roformer, rt_detr, rt_detr_resnet, rt_detr_v2, rwkv, sam, sam_hq, sam_hq_vision_model, sam_vision_model, seamless_m4t, seamless_m4t_v2, segformer, seggpt, sew, sew-d, shieldgemma2, siglip, siglip2, siglip_vision_model, smollm3, smolvlm, smolvlm_vision, speech-encoder-decoder, speech_to_text, speech_to_text_2, speecht5, splinter, squeezebert, stablelm, starcoder2, superglue, superpoint, swiftformer, swin, swin2sr, swinv2, switch_transformers, t5, t5gemma, table-transformer, tapas, textnet, time_series_transformer, timesfm, timesformer, timm_backbone, timm_wrapper, trajectory_transformer, transfo-xl, trocr, tvlt, tvp, udop, umt5, unispeech, unispeech-sat, univnet, upernet, van, video_llava, videomae, vilt, vipllava, vision-encoder-decoder, vision-text-dual-encoder, visual_bert, vit, vit_hybrid, vit_mae, vit_msn, vitdet, vitmatte, vitpose, vitpose_backbone, vits, vivit, vjepa2, wav2vec2, wav2vec2-bert, wav2vec2-conformer, wavlm, whisper, xclip, xglm, xlm, xlm-prophetnet, xlm-roberta, xlm-roberta-xl, xlnet, xmod, yolos, yoso, zamba, zamba2, zoedepth
INFO     ml_coder.registry_predictor:registry_predictor.py:156 Loading registry model from data/models/registry_classifier.pkl
INFO     ml_coder.registry_predictor:registry_predictor.py:163 Loaded 21 labels from MLB
INFO     ml_coder.registry_predictor:registry_predictor.py:180 RegistryMLPredictor initialized with 21 labels
INFO     registry_service:registry_service.py:337 Using RegistryMLPredictor (TF-IDF) with 21 labels
WARNING  coder.parallel_pathway:orchestrator.py:430 Path B failed: 'list' object has no attribute 'predictions'
INFO     ml_coder.predictor:predictor.py:175 Loading model from data/models/cpt_classifier.pkl
INFO     ml_coder.predictor:predictor.py:185 Predictor initialized with 35 labels, upper=0.70, lower=0.40
_________ TestRegistryServiceHybridFlow.test_pleural_procedure_mapping _________

self = <test_registry_service_hybrid_flow.TestRegistryServiceHybridFlow object at 0x181094d90>

    def test_pleural_procedure_mapping(self) -> None:
        """Pleural CPT codes should map to pleural_procedures section."""
        fake_orchestrator = MagicMock()
        fake_orchestrator.get_codes.return_value = make_fake_hybrid_result(
            codes=["32555", "32601"],  # Thoracentesis + pleuroscopy
            difficulty="high_confidence",
        )
    
        preset_record = RegistryRecord(
            procedure_type="bronchoscopy",
            pleural_procedures={
                "thoracentesis": {"performed": True},
                "medical_thoracoscopy": {"performed": True},
            },
        )
        stub_engine = StubRegistryEngine(preset_record=preset_record)
    
        service = RegistryService(
            hybrid_orchestrator=fake_orchestrator,
            registry_engine=stub_engine,
        )
    
        result = service.extract_fields("Thoracentesis and pleuroscopy")
    
        # Assert pleural mapping
>       assert "pleural_procedures" in result.mapped_fields
E       AssertionError: assert 'pleural_procedures' in {}
E        +  where {} = RegistryExtractionResult(record=RegistryRecord(patient_mrn=None, procedure_date=None, procedure_start_time=None, proce...ConfigSnapshot(use_buckets=True, top_k=25, min_prob=0.5, self_correct_min_prob=0.95), warnings=[]), self_correction=[]).mapped_fields

tests/registry/test_registry_service_hybrid_flow.py:503: AssertionError
----------------------------- Captured stderr call -----------------------------
{"timestamp": "2026-01-18T00:35:58.397368", "level": "WARNING", "logger": "ner.inference", "message": "GranularNERPredictor unavailable: Model directory not found: artifacts/granular_ner_model"}
{"timestamp": "2026-01-18T00:35:58.397468", "level": "INFO", "logger": "coder.parallel_pathway", "message": "ParallelPathwayOrchestrator initialized: NER=unavailable, ML=unavailable"}
{"timestamp": "2026-01-18T00:35:58.414407", "level": "WARNING", "logger": "registry.inference_pytorch", "message": "TorchRegistryPredictor unavailable: Unrecognized model in data/models/registry_runtime. Should have a `model_type` key in its config.json, or contain one of the following strings in its name: albert, align, altclip, arcee, aria, aria_text, audio-spectrogram-transformer, autoformer, aya_vision, bamba, bark, bart, beit, bert, bert-generation, big_bird, bigbird_pegasus, biogpt, bit, bitnet, blenderbot, blenderbot-small, blip, blip-2, blip_2_qformer, bloom, bridgetower, bros, camembert, canine, chameleon, chinese_clip, chinese_clip_vision_model, clap, clip, clip_text_model, clip_vision_model, clipseg, clvp, code_llama, codegen, cohere, cohere2, colpali, colqwen2, conditional_detr, convbert, convnext, convnextv2, cpmant, csm, ctrl, cvt, d_fine, dab-detr, dac, data2vec-audio, data2vec-text, data2vec-vision, dbrx, deberta, deberta-v2, decision_transformer, deepseek_v3, deformable_detr, deit, depth_anything, depth_pro, deta, detr, dia, diffllama, dinat, dinov2, dinov2_with_registers, distilbert, donut-swin, dots1, dpr, dpt, efficientformer, efficientnet, electra, emu3, encodec, encoder-decoder, ernie, ernie_m, esm, falcon, falcon_h1, falcon_mamba, fastspeech2_conformer, flaubert, flava, fnet, focalnet, fsmt, funnel, fuyu, gemma, gemma2, gemma3, gemma3_text, gemma3n, gemma3n_audio, gemma3n_text, gemma3n_vision, git, glm, glm4, glm4v, glm4v_text, glpn, got_ocr2, gpt-sw3, gpt2, gpt_bigcode, gpt_neo, gpt_neox, gpt_neox_japanese, gptj, gptsan-japanese, granite, granite_speech, granitemoe, granitemoehybrid, granitemoeshared, granitevision, graphormer, grounding-dino, groupvit, helium, hgnet_v2, hiera, hubert, ibert, idefics, idefics2, idefics3, idefics3_vision, ijepa, imagegpt, informer, instructblip, instructblipvideo, internvl, internvl_vision, jamba, janus, jetmoe, jukebox, kosmos-2, kyutai_speech_to_text, layoutlm, layoutlmv2, layoutlmv3, led, levit, lightglue, lilt, llama, llama4, llama4_text, llava, llava_next, llava_next_video, llava_onevision, longformer, longt5, luke, lxmert, m2m_100, mamba, mamba2, marian, markuplm, mask2former, maskformer, maskformer-swin, mbart, mctct, mega, megatron-bert, mgp-str, mimi, minimax, mistral, mistral3, mixtral, mlcd, mllama, mobilebert, mobilenet_v1, mobilenet_v2, mobilevit, mobilevitv2, modernbert, moonshine, moshi, mpnet, mpt, mra, mt5, musicgen, musicgen_melody, mvp, nat, nemotron, nezha, nllb-moe, nougat, nystromformer, olmo, olmo2, olmoe, omdet-turbo, oneformer, open-llama, openai-gpt, opt, owlv2, owlvit, paligemma, patchtsmixer, patchtst, pegasus, pegasus_x, perceiver, persimmon, phi, phi3, phi4_multimodal, phimoe, pix2struct, pixtral, plbart, poolformer, pop2piano, prompt_depth_anything, prophetnet, pvt, pvt_v2, qdqbert, qwen2, qwen2_5_omni, qwen2_5_vl, qwen2_5_vl_text, qwen2_audio, qwen2_audio_encoder, qwen2_moe, qwen2_vl, qwen2_vl_text, qwen3, qwen3_moe, rag, realm, recurrent_gemma, reformer, regnet, rembert, resnet, retribert, roberta, roberta-prelayernorm, roc_bert, roformer, rt_detr, rt_detr_resnet, rt_detr_v2, rwkv, sam, sam_hq, sam_hq_vision_model, sam_vision_model, seamless_m4t, seamless_m4t_v2, segformer, seggpt, sew, sew-d, shieldgemma2, siglip, siglip2, siglip_vision_model, smollm3, smolvlm, smolvlm_vision, speech-encoder-decoder, speech_to_text, speech_to_text_2, speecht5, splinter, squeezebert, stablelm, starcoder2, superglue, superpoint, swiftformer, swin, swin2sr, swinv2, switch_transformers, t5, t5gemma, table-transformer, tapas, textnet, time_series_transformer, timesfm, timesformer, timm_backbone, timm_wrapper, trajectory_transformer, transfo-xl, trocr, tvlt, tvp, udop, umt5, unispeech, unispeech-sat, univnet, upernet, van, video_llava, videomae, vilt, vipllava, vision-encoder-decoder, vision-text-dual-encoder, visual_bert, vit, vit_hybrid, vit_mae, vit_msn, vitdet, vitmatte, vitpose, vitpose_backbone, vits, vivit, vjepa2, wav2vec2, wav2vec2-bert, wav2vec2-conformer, wavlm, whisper, xclip, xglm, xlm, xlm-prophetnet, xlm-roberta, xlm-roberta-xl, xlnet, xmod, yolos, yoso, zamba, zamba2, zoedepth"}
{"timestamp": "2026-01-18T00:35:58.414523", "level": "INFO", "logger": "ml_coder.registry_predictor", "message": "Loading registry model from data/models/registry_classifier.pkl"}
{"timestamp": "2026-01-18T00:35:58.446789", "level": "INFO", "logger": "ml_coder.registry_predictor", "message": "Loaded 21 labels from MLB"}
{"timestamp": "2026-01-18T00:35:58.446941", "level": "INFO", "logger": "ml_coder.registry_predictor", "message": "RegistryMLPredictor initialized with 21 labels"}
{"timestamp": "2026-01-18T00:35:58.446978", "level": "INFO", "logger": "registry_service", "message": "Using RegistryMLPredictor (TF-IDF) with 21 labels"}
{"timestamp": "2026-01-18T00:35:58.464019", "level": "WARNING", "logger": "coder.parallel_pathway", "message": "Path B failed: 'list' object has no attribute 'predictions'"}
{"timestamp": "2026-01-18T00:35:58.464250", "level": "INFO", "logger": "ml_coder.predictor", "message": "Loading model from data/models/cpt_classifier.pkl"}
{"timestamp": "2026-01-18T00:35:58.491368", "level": "INFO", "logger": "ml_coder.predictor", "message": "Predictor initialized with 35 labels, upper=0.70, lower=0.40"}
------------------------------ Captured log call -------------------------------
WARNING  ner.inference:inference.py:150 GranularNERPredictor unavailable: Model directory not found: artifacts/granular_ner_model
INFO     coder.parallel_pathway:orchestrator.py:157 ParallelPathwayOrchestrator initialized: NER=unavailable, ML=unavailable
WARNING  registry.inference_pytorch:inference_pytorch.py:78 TorchRegistryPredictor unavailable: Unrecognized model in data/models/registry_runtime. Should have a `model_type` key in its config.json, or contain one of the following strings in its name: albert, align, altclip, arcee, aria, aria_text, audio-spectrogram-transformer, autoformer, aya_vision, bamba, bark, bart, beit, bert, bert-generation, big_bird, bigbird_pegasus, biogpt, bit, bitnet, blenderbot, blenderbot-small, blip, blip-2, blip_2_qformer, bloom, bridgetower, bros, camembert, canine, chameleon, chinese_clip, chinese_clip_vision_model, clap, clip, clip_text_model, clip_vision_model, clipseg, clvp, code_llama, codegen, cohere, cohere2, colpali, colqwen2, conditional_detr, convbert, convnext, convnextv2, cpmant, csm, ctrl, cvt, d_fine, dab-detr, dac, data2vec-audio, data2vec-text, data2vec-vision, dbrx, deberta, deberta-v2, decision_transformer, deepseek_v3, deformable_detr, deit, depth_anything, depth_pro, deta, detr, dia, diffllama, dinat, dinov2, dinov2_with_registers, distilbert, donut-swin, dots1, dpr, dpt, efficientformer, efficientnet, electra, emu3, encodec, encoder-decoder, ernie, ernie_m, esm, falcon, falcon_h1, falcon_mamba, fastspeech2_conformer, flaubert, flava, fnet, focalnet, fsmt, funnel, fuyu, gemma, gemma2, gemma3, gemma3_text, gemma3n, gemma3n_audio, gemma3n_text, gemma3n_vision, git, glm, glm4, glm4v, glm4v_text, glpn, got_ocr2, gpt-sw3, gpt2, gpt_bigcode, gpt_neo, gpt_neox, gpt_neox_japanese, gptj, gptsan-japanese, granite, granite_speech, granitemoe, granitemoehybrid, granitemoeshared, granitevision, graphormer, grounding-dino, groupvit, helium, hgnet_v2, hiera, hubert, ibert, idefics, idefics2, idefics3, idefics3_vision, ijepa, imagegpt, informer, instructblip, instructblipvideo, internvl, internvl_vision, jamba, janus, jetmoe, jukebox, kosmos-2, kyutai_speech_to_text, layoutlm, layoutlmv2, layoutlmv3, led, levit, lightglue, lilt, llama, llama4, llama4_text, llava, llava_next, llava_next_video, llava_onevision, longformer, longt5, luke, lxmert, m2m_100, mamba, mamba2, marian, markuplm, mask2former, maskformer, maskformer-swin, mbart, mctct, mega, megatron-bert, mgp-str, mimi, minimax, mistral, mistral3, mixtral, mlcd, mllama, mobilebert, mobilenet_v1, mobilenet_v2, mobilevit, mobilevitv2, modernbert, moonshine, moshi, mpnet, mpt, mra, mt5, musicgen, musicgen_melody, mvp, nat, nemotron, nezha, nllb-moe, nougat, nystromformer, olmo, olmo2, olmoe, omdet-turbo, oneformer, open-llama, openai-gpt, opt, owlv2, owlvit, paligemma, patchtsmixer, patchtst, pegasus, pegasus_x, perceiver, persimmon, phi, phi3, phi4_multimodal, phimoe, pix2struct, pixtral, plbart, poolformer, pop2piano, prompt_depth_anything, prophetnet, pvt, pvt_v2, qdqbert, qwen2, qwen2_5_omni, qwen2_5_vl, qwen2_5_vl_text, qwen2_audio, qwen2_audio_encoder, qwen2_moe, qwen2_vl, qwen2_vl_text, qwen3, qwen3_moe, rag, realm, recurrent_gemma, reformer, regnet, rembert, resnet, retribert, roberta, roberta-prelayernorm, roc_bert, roformer, rt_detr, rt_detr_resnet, rt_detr_v2, rwkv, sam, sam_hq, sam_hq_vision_model, sam_vision_model, seamless_m4t, seamless_m4t_v2, segformer, seggpt, sew, sew-d, shieldgemma2, siglip, siglip2, siglip_vision_model, smollm3, smolvlm, smolvlm_vision, speech-encoder-decoder, speech_to_text, speech_to_text_2, speecht5, splinter, squeezebert, stablelm, starcoder2, superglue, superpoint, swiftformer, swin, swin2sr, swinv2, switch_transformers, t5, t5gemma, table-transformer, tapas, textnet, time_series_transformer, timesfm, timesformer, timm_backbone, timm_wrapper, trajectory_transformer, transfo-xl, trocr, tvlt, tvp, udop, umt5, unispeech, unispeech-sat, univnet, upernet, van, video_llava, videomae, vilt, vipllava, vision-encoder-decoder, vision-text-dual-encoder, visual_bert, vit, vit_hybrid, vit_mae, vit_msn, vitdet, vitmatte, vitpose, vitpose_backbone, vits, vivit, vjepa2, wav2vec2, wav2vec2-bert, wav2vec2-conformer, wavlm, whisper, xclip, xglm, xlm, xlm-prophetnet, xlm-roberta, xlm-roberta-xl, xlnet, xmod, yolos, yoso, zamba, zamba2, zoedepth
INFO     ml_coder.registry_predictor:registry_predictor.py:156 Loading registry model from data/models/registry_classifier.pkl
INFO     ml_coder.registry_predictor:registry_predictor.py:163 Loaded 21 labels from MLB
INFO     ml_coder.registry_predictor:registry_predictor.py:180 RegistryMLPredictor initialized with 21 labels
INFO     registry_service:registry_service.py:337 Using RegistryMLPredictor (TF-IDF) with 21 labels
WARNING  coder.parallel_pathway:orchestrator.py:430 Path B failed: 'list' object has no attribute 'predictions'
INFO     ml_coder.predictor:predictor.py:175 Loading model from data/models/cpt_classifier.pkl
INFO     ml_coder.predictor:predictor.py:185 Predictor initialized with 35 labels, upper=0.70, lower=0.40
______ TestRegistryServiceWithRealEngine.test_real_engine_ebus_extraction ______

self = <test_registry_service_hybrid_flow.TestRegistryServiceWithRealEngine object at 0x181095910>
real_engine = <modules.registry.engine.RegistryEngine object at 0x1d6044dd0>

    def test_real_engine_ebus_extraction(self, real_engine: RegistryEngine) -> None:
        """Real engine should extract basic EBUS info from note text."""
        fake_orchestrator = MagicMock()
        fake_orchestrator.get_codes.return_value = make_fake_hybrid_result(
            codes=["31652"],
            difficulty="high_confidence",
        )
    
        service = RegistryService(
            hybrid_orchestrator=fake_orchestrator,
            registry_engine=real_engine,
        )
    
        note_text = """
        PROCEDURE: EBUS-TBNA
    
        The patient underwent linear EBUS with TBNA of station 4R.
        Two passes were performed. ROSE showed adequate lymphocytes.
        No complications.
        """
    
        result = service.extract_fields(note_text)
    
        # Should have CPT codes
>       assert result.cpt_codes == ["31652"]
E       AssertionError: assert [] == ['31652']
E         
E         Right contains one more item: '31652'
E         Use -v to get more diff

tests/registry/test_registry_service_hybrid_flow.py:549: AssertionError
----------------------------- Captured stderr call -----------------------------
{"timestamp": "2026-01-18T00:35:58.519105", "level": "WARNING", "logger": "ner.inference", "message": "GranularNERPredictor unavailable: Model directory not found: artifacts/granular_ner_model"}
{"timestamp": "2026-01-18T00:35:58.519207", "level": "INFO", "logger": "coder.parallel_pathway", "message": "ParallelPathwayOrchestrator initialized: NER=unavailable, ML=unavailable"}
{"timestamp": "2026-01-18T00:35:58.535064", "level": "WARNING", "logger": "registry.inference_pytorch", "message": "TorchRegistryPredictor unavailable: Unrecognized model in data/models/registry_runtime. Should have a `model_type` key in its config.json, or contain one of the following strings in its name: albert, align, altclip, arcee, aria, aria_text, audio-spectrogram-transformer, autoformer, aya_vision, bamba, bark, bart, beit, bert, bert-generation, big_bird, bigbird_pegasus, biogpt, bit, bitnet, blenderbot, blenderbot-small, blip, blip-2, blip_2_qformer, bloom, bridgetower, bros, camembert, canine, chameleon, chinese_clip, chinese_clip_vision_model, clap, clip, clip_text_model, clip_vision_model, clipseg, clvp, code_llama, codegen, cohere, cohere2, colpali, colqwen2, conditional_detr, convbert, convnext, convnextv2, cpmant, csm, ctrl, cvt, d_fine, dab-detr, dac, data2vec-audio, data2vec-text, data2vec-vision, dbrx, deberta, deberta-v2, decision_transformer, deepseek_v3, deformable_detr, deit, depth_anything, depth_pro, deta, detr, dia, diffllama, dinat, dinov2, dinov2_with_registers, distilbert, donut-swin, dots1, dpr, dpt, efficientformer, efficientnet, electra, emu3, encodec, encoder-decoder, ernie, ernie_m, esm, falcon, falcon_h1, falcon_mamba, fastspeech2_conformer, flaubert, flava, fnet, focalnet, fsmt, funnel, fuyu, gemma, gemma2, gemma3, gemma3_text, gemma3n, gemma3n_audio, gemma3n_text, gemma3n_vision, git, glm, glm4, glm4v, glm4v_text, glpn, got_ocr2, gpt-sw3, gpt2, gpt_bigcode, gpt_neo, gpt_neox, gpt_neox_japanese, gptj, gptsan-japanese, granite, granite_speech, granitemoe, granitemoehybrid, granitemoeshared, granitevision, graphormer, grounding-dino, groupvit, helium, hgnet_v2, hiera, hubert, ibert, idefics, idefics2, idefics3, idefics3_vision, ijepa, imagegpt, informer, instructblip, instructblipvideo, internvl, internvl_vision, jamba, janus, jetmoe, jukebox, kosmos-2, kyutai_speech_to_text, layoutlm, layoutlmv2, layoutlmv3, led, levit, lightglue, lilt, llama, llama4, llama4_text, llava, llava_next, llava_next_video, llava_onevision, longformer, longt5, luke, lxmert, m2m_100, mamba, mamba2, marian, markuplm, mask2former, maskformer, maskformer-swin, mbart, mctct, mega, megatron-bert, mgp-str, mimi, minimax, mistral, mistral3, mixtral, mlcd, mllama, mobilebert, mobilenet_v1, mobilenet_v2, mobilevit, mobilevitv2, modernbert, moonshine, moshi, mpnet, mpt, mra, mt5, musicgen, musicgen_melody, mvp, nat, nemotron, nezha, nllb-moe, nougat, nystromformer, olmo, olmo2, olmoe, omdet-turbo, oneformer, open-llama, openai-gpt, opt, owlv2, owlvit, paligemma, patchtsmixer, patchtst, pegasus, pegasus_x, perceiver, persimmon, phi, phi3, phi4_multimodal, phimoe, pix2struct, pixtral, plbart, poolformer, pop2piano, prompt_depth_anything, prophetnet, pvt, pvt_v2, qdqbert, qwen2, qwen2_5_omni, qwen2_5_vl, qwen2_5_vl_text, qwen2_audio, qwen2_audio_encoder, qwen2_moe, qwen2_vl, qwen2_vl_text, qwen3, qwen3_moe, rag, realm, recurrent_gemma, reformer, regnet, rembert, resnet, retribert, roberta, roberta-prelayernorm, roc_bert, roformer, rt_detr, rt_detr_resnet, rt_detr_v2, rwkv, sam, sam_hq, sam_hq_vision_model, sam_vision_model, seamless_m4t, seamless_m4t_v2, segformer, seggpt, sew, sew-d, shieldgemma2, siglip, siglip2, siglip_vision_model, smollm3, smolvlm, smolvlm_vision, speech-encoder-decoder, speech_to_text, speech_to_text_2, speecht5, splinter, squeezebert, stablelm, starcoder2, superglue, superpoint, swiftformer, swin, swin2sr, swinv2, switch_transformers, t5, t5gemma, table-transformer, tapas, textnet, time_series_transformer, timesfm, timesformer, timm_backbone, timm_wrapper, trajectory_transformer, transfo-xl, trocr, tvlt, tvp, udop, umt5, unispeech, unispeech-sat, univnet, upernet, van, video_llava, videomae, vilt, vipllava, vision-encoder-decoder, vision-text-dual-encoder, visual_bert, vit, vit_hybrid, vit_mae, vit_msn, vitdet, vitmatte, vitpose, vitpose_backbone, vits, vivit, vjepa2, wav2vec2, wav2vec2-bert, wav2vec2-conformer, wavlm, whisper, xclip, xglm, xlm, xlm-prophetnet, xlm-roberta, xlm-roberta-xl, xlnet, xmod, yolos, yoso, zamba, zamba2, zoedepth"}
{"timestamp": "2026-01-18T00:35:58.535180", "level": "INFO", "logger": "ml_coder.registry_predictor", "message": "Loading registry model from data/models/registry_classifier.pkl"}
{"timestamp": "2026-01-18T00:35:58.567429", "level": "INFO", "logger": "ml_coder.registry_predictor", "message": "Loaded 21 labels from MLB"}
{"timestamp": "2026-01-18T00:35:58.567576", "level": "INFO", "logger": "ml_coder.registry_predictor", "message": "RegistryMLPredictor initialized with 21 labels"}
{"timestamp": "2026-01-18T00:35:58.567616", "level": "INFO", "logger": "registry_service", "message": "Using RegistryMLPredictor (TF-IDF) with 21 labels"}
{"timestamp": "2026-01-18T00:35:58.590525", "level": "WARNING", "logger": "coder.parallel_pathway", "message": "Path B failed: 'list' object has no attribute 'predictions'"}
{"timestamp": "2026-01-18T00:35:58.590895", "level": "INFO", "logger": "ml_coder.predictor", "message": "Loading model from data/models/cpt_classifier.pkl"}
{"timestamp": "2026-01-18T00:35:58.616770", "level": "INFO", "logger": "ml_coder.predictor", "message": "Predictor initialized with 35 labels, upper=0.70, lower=0.40"}
------------------------------ Captured log call -------------------------------
WARNING  ner.inference:inference.py:150 GranularNERPredictor unavailable: Model directory not found: artifacts/granular_ner_model
INFO     coder.parallel_pathway:orchestrator.py:157 ParallelPathwayOrchestrator initialized: NER=unavailable, ML=unavailable
WARNING  registry.inference_pytorch:inference_pytorch.py:78 TorchRegistryPredictor unavailable: Unrecognized model in data/models/registry_runtime. Should have a `model_type` key in its config.json, or contain one of the following strings in its name: albert, align, altclip, arcee, aria, aria_text, audio-spectrogram-transformer, autoformer, aya_vision, bamba, bark, bart, beit, bert, bert-generation, big_bird, bigbird_pegasus, biogpt, bit, bitnet, blenderbot, blenderbot-small, blip, blip-2, blip_2_qformer, bloom, bridgetower, bros, camembert, canine, chameleon, chinese_clip, chinese_clip_vision_model, clap, clip, clip_text_model, clip_vision_model, clipseg, clvp, code_llama, codegen, cohere, cohere2, colpali, colqwen2, conditional_detr, convbert, convnext, convnextv2, cpmant, csm, ctrl, cvt, d_fine, dab-detr, dac, data2vec-audio, data2vec-text, data2vec-vision, dbrx, deberta, deberta-v2, decision_transformer, deepseek_v3, deformable_detr, deit, depth_anything, depth_pro, deta, detr, dia, diffllama, dinat, dinov2, dinov2_with_registers, distilbert, donut-swin, dots1, dpr, dpt, efficientformer, efficientnet, electra, emu3, encodec, encoder-decoder, ernie, ernie_m, esm, falcon, falcon_h1, falcon_mamba, fastspeech2_conformer, flaubert, flava, fnet, focalnet, fsmt, funnel, fuyu, gemma, gemma2, gemma3, gemma3_text, gemma3n, gemma3n_audio, gemma3n_text, gemma3n_vision, git, glm, glm4, glm4v, glm4v_text, glpn, got_ocr2, gpt-sw3, gpt2, gpt_bigcode, gpt_neo, gpt_neox, gpt_neox_japanese, gptj, gptsan-japanese, granite, granite_speech, granitemoe, granitemoehybrid, granitemoeshared, granitevision, graphormer, grounding-dino, groupvit, helium, hgnet_v2, hiera, hubert, ibert, idefics, idefics2, idefics3, idefics3_vision, ijepa, imagegpt, informer, instructblip, instructblipvideo, internvl, internvl_vision, jamba, janus, jetmoe, jukebox, kosmos-2, kyutai_speech_to_text, layoutlm, layoutlmv2, layoutlmv3, led, levit, lightglue, lilt, llama, llama4, llama4_text, llava, llava_next, llava_next_video, llava_onevision, longformer, longt5, luke, lxmert, m2m_100, mamba, mamba2, marian, markuplm, mask2former, maskformer, maskformer-swin, mbart, mctct, mega, megatron-bert, mgp-str, mimi, minimax, mistral, mistral3, mixtral, mlcd, mllama, mobilebert, mobilenet_v1, mobilenet_v2, mobilevit, mobilevitv2, modernbert, moonshine, moshi, mpnet, mpt, mra, mt5, musicgen, musicgen_melody, mvp, nat, nemotron, nezha, nllb-moe, nougat, nystromformer, olmo, olmo2, olmoe, omdet-turbo, oneformer, open-llama, openai-gpt, opt, owlv2, owlvit, paligemma, patchtsmixer, patchtst, pegasus, pegasus_x, perceiver, persimmon, phi, phi3, phi4_multimodal, phimoe, pix2struct, pixtral, plbart, poolformer, pop2piano, prompt_depth_anything, prophetnet, pvt, pvt_v2, qdqbert, qwen2, qwen2_5_omni, qwen2_5_vl, qwen2_5_vl_text, qwen2_audio, qwen2_audio_encoder, qwen2_moe, qwen2_vl, qwen2_vl_text, qwen3, qwen3_moe, rag, realm, recurrent_gemma, reformer, regnet, rembert, resnet, retribert, roberta, roberta-prelayernorm, roc_bert, roformer, rt_detr, rt_detr_resnet, rt_detr_v2, rwkv, sam, sam_hq, sam_hq_vision_model, sam_vision_model, seamless_m4t, seamless_m4t_v2, segformer, seggpt, sew, sew-d, shieldgemma2, siglip, siglip2, siglip_vision_model, smollm3, smolvlm, smolvlm_vision, speech-encoder-decoder, speech_to_text, speech_to_text_2, speecht5, splinter, squeezebert, stablelm, starcoder2, superglue, superpoint, swiftformer, swin, swin2sr, swinv2, switch_transformers, t5, t5gemma, table-transformer, tapas, textnet, time_series_transformer, timesfm, timesformer, timm_backbone, timm_wrapper, trajectory_transformer, transfo-xl, trocr, tvlt, tvp, udop, umt5, unispeech, unispeech-sat, univnet, upernet, van, video_llava, videomae, vilt, vipllava, vision-encoder-decoder, vision-text-dual-encoder, visual_bert, vit, vit_hybrid, vit_mae, vit_msn, vitdet, vitmatte, vitpose, vitpose_backbone, vits, vivit, vjepa2, wav2vec2, wav2vec2-bert, wav2vec2-conformer, wavlm, whisper, xclip, xglm, xlm, xlm-prophetnet, xlm-roberta, xlm-roberta-xl, xlnet, xmod, yolos, yoso, zamba, zamba2, zoedepth
INFO     ml_coder.registry_predictor:registry_predictor.py:156 Loading registry model from data/models/registry_classifier.pkl
INFO     ml_coder.registry_predictor:registry_predictor.py:163 Loaded 21 labels from MLB
INFO     ml_coder.registry_predictor:registry_predictor.py:180 RegistryMLPredictor initialized with 21 labels
INFO     registry_service:registry_service.py:337 Using RegistryMLPredictor (TF-IDF) with 21 labels
WARNING  coder.parallel_pathway:orchestrator.py:430 Path B failed: 'list' object has no attribute 'predictions'
INFO     ml_coder.predictor:predictor.py:175 Loading model from data/models/cpt_classifier.pkl
INFO     ml_coder.predictor:predictor.py:185 Predictor initialized with 35 labels, upper=0.70, lower=0.40
_ TestMLHybridAudit.test_scenario_c_ml_detected_not_in_cpt_triggers_audit_warning _

self = <test_registry_service_hybrid_flow.TestMLHybridAudit object at 0x1810961d0>

    def test_scenario_c_ml_detected_not_in_cpt_triggers_audit_warning(self) -> None:
        """When ML detects a procedure that CPT missed, audit warning should trigger."""
        # Arrange: orchestrator returns no codes for linear_ebus
        fake_orchestrator = MagicMock()
        fake_orchestrator.get_codes.return_value = make_fake_hybrid_result(
            codes=["31622"],  # Only diagnostic bronch, no EBUS code
            difficulty="high_confidence",
        )
    
        # Stub engine returns basic record
        preset_record = RegistryRecord(procedure_type="bronchoscopy")
        stub_engine = StubRegistryEngine(preset_record=preset_record)
    
        service = RegistryService(
            hybrid_orchestrator=fake_orchestrator,
            registry_engine=stub_engine,
        )
    
        # Inject stub predictor that thinks linear_ebus was performed
        service._registry_ml_predictor = StubRegistryPredictor(
            positive_fields=["linear_ebus"],
            probabilities={"linear_ebus": 0.85},
        )
        service._ml_predictor_init_attempted = True
    
        # Act
        result = service.extract_fields(
            "EBUS was performed but coder missed it - ML should catch this"
        )
    
        # Assert: Audit warning should be present
>       assert result.needs_manual_review is True
E       assert False is True
E        +  where False = RegistryExtractionResult(record=RegistryRecord(patient_mrn=None, procedure_date=None, procedure_start_time=None, proce...ConfigSnapshot(use_buckets=True, top_k=25, min_prob=0.5, self_correct_min_prob=0.95), warnings=[]), self_correction=[]).needs_manual_review

tests/registry/test_registry_service_hybrid_flow.py:651: AssertionError
----------------------------- Captured stderr call -----------------------------
{"timestamp": "2026-01-18T00:35:58.643014", "level": "WARNING", "logger": "ner.inference", "message": "GranularNERPredictor unavailable: Model directory not found: artifacts/granular_ner_model"}
{"timestamp": "2026-01-18T00:35:58.643126", "level": "INFO", "logger": "coder.parallel_pathway", "message": "ParallelPathwayOrchestrator initialized: NER=unavailable, ML=unavailable"}
{"timestamp": "2026-01-18T00:35:58.647730", "level": "WARNING", "logger": "coder.parallel_pathway", "message": "Path B failed: 'StubRegistryPredictor' object has no attribute 'predict'"}
{"timestamp": "2026-01-18T00:35:58.647933", "level": "INFO", "logger": "ml_coder.predictor", "message": "Loading model from data/models/cpt_classifier.pkl"}
{"timestamp": "2026-01-18T00:35:58.674439", "level": "INFO", "logger": "ml_coder.predictor", "message": "Predictor initialized with 35 labels, upper=0.70, lower=0.40"}
------------------------------ Captured log call -------------------------------
WARNING  ner.inference:inference.py:150 GranularNERPredictor unavailable: Model directory not found: artifacts/granular_ner_model
INFO     coder.parallel_pathway:orchestrator.py:157 ParallelPathwayOrchestrator initialized: NER=unavailable, ML=unavailable
WARNING  coder.parallel_pathway:orchestrator.py:430 Path B failed: 'StubRegistryPredictor' object has no attribute 'predict'
INFO     ml_coder.predictor:predictor.py:175 Loading model from data/models/cpt_classifier.pkl
INFO     ml_coder.predictor:predictor.py:185 Predictor initialized with 35 labels, upper=0.70, lower=0.40
________ TestMLHybridAudit.test_scenario_a_cpt_and_ml_match_no_warning _________

self = <test_registry_service_hybrid_flow.TestMLHybridAudit object at 0x181096850>

    def test_scenario_a_cpt_and_ml_match_no_warning(self) -> None:
        """When CPT and ML both detect procedure, no audit warning needed."""
        # Arrange: orchestrator returns EBUS code
        fake_orchestrator = MagicMock()
        fake_orchestrator.get_codes.return_value = make_fake_hybrid_result(
            codes=["31652"],  # EBUS 1-2 stations
            difficulty="high_confidence",
        )
    
        # Stub engine returns record with linear_ebus set
        preset_record = RegistryRecord(
            procedure_type="bronchoscopy",
            procedures_performed={"linear_ebus": {"performed": True}},
        )
        stub_engine = StubRegistryEngine(preset_record=preset_record)
    
        service = RegistryService(
            hybrid_orchestrator=fake_orchestrator,
            registry_engine=stub_engine,
        )
    
        # Inject stub predictor that also thinks linear_ebus was performed
        service._registry_ml_predictor = StubRegistryPredictor(
            positive_fields=["linear_ebus"],
        )
        service._ml_predictor_init_attempted = True
    
        # Act
        result = service.extract_fields("EBUS-TBNA with stations 4R and 7")
    
        # Assert: No audit warnings because CPT and ML agree
>       assert result.audit_warnings == []
E       AssertionError: assert ['RAW_ML_AUDI...on missed it'] == []
E         
E         Left contains one more item: 'RAW_ML_AUDIT[HIGH_CONF]: model suggests 31653 (prob=0.79), but deterministic derivation missed it'
E         Use -v to get more diff

tests/registry/test_registry_service_hybrid_flow.py:687: AssertionError
----------------------------- Captured stderr call -----------------------------
{"timestamp": "2026-01-18T00:35:58.699055", "level": "WARNING", "logger": "ner.inference", "message": "GranularNERPredictor unavailable: Model directory not found: artifacts/granular_ner_model"}
{"timestamp": "2026-01-18T00:35:58.699166", "level": "INFO", "logger": "coder.parallel_pathway", "message": "ParallelPathwayOrchestrator initialized: NER=unavailable, ML=unavailable"}
{"timestamp": "2026-01-18T00:35:58.703144", "level": "WARNING", "logger": "coder.parallel_pathway", "message": "Path B failed: 'StubRegistryPredictor' object has no attribute 'predict'"}
{"timestamp": "2026-01-18T00:35:58.703329", "level": "INFO", "logger": "ml_coder.predictor", "message": "Loading model from data/models/cpt_classifier.pkl"}
{"timestamp": "2026-01-18T00:35:58.730294", "level": "INFO", "logger": "ml_coder.predictor", "message": "Predictor initialized with 35 labels, upper=0.70, lower=0.40"}
------------------------------ Captured log call -------------------------------
WARNING  ner.inference:inference.py:150 GranularNERPredictor unavailable: Model directory not found: artifacts/granular_ner_model
INFO     coder.parallel_pathway:orchestrator.py:157 ParallelPathwayOrchestrator initialized: NER=unavailable, ML=unavailable
WARNING  coder.parallel_pathway:orchestrator.py:430 Path B failed: 'StubRegistryPredictor' object has no attribute 'predict'
INFO     ml_coder.predictor:predictor.py:175 Loading model from data/models/cpt_classifier.pkl
INFO     ml_coder.predictor:predictor.py:185 Predictor initialized with 35 labels, upper=0.70, lower=0.40
____ TestMLHybridAudit.test_scenario_b_cpt_positive_ml_negative_no_warning _____

self = <test_registry_service_hybrid_flow.TestMLHybridAudit object at 0x181096ed0>

    def test_scenario_b_cpt_positive_ml_negative_no_warning(self) -> None:
        """When CPT detects but ML doesn't, CPT is primary truth - no warning."""
        # Arrange: orchestrator returns EBUS code
        fake_orchestrator = MagicMock()
        fake_orchestrator.get_codes.return_value = make_fake_hybrid_result(
            codes=["31652"],  # EBUS 1-2 stations
            difficulty="high_confidence",
        )
    
        # Stub engine returns record with linear_ebus set
        preset_record = RegistryRecord(
            procedure_type="bronchoscopy",
            procedures_performed={"linear_ebus": {"performed": True}},
        )
        stub_engine = StubRegistryEngine(preset_record=preset_record)
    
        service = RegistryService(
            hybrid_orchestrator=fake_orchestrator,
            registry_engine=stub_engine,
        )
    
        # Inject stub predictor that does NOT detect linear_ebus
        service._registry_ml_predictor = StubRegistryPredictor(
            positive_fields=[],  # ML doesn't detect anything
        )
        service._ml_predictor_init_attempted = True
    
        # Act
        result = service.extract_fields("EBUS performed - ML missed it")
    
        # Assert: No audit warnings because CPT is primary truth
        assert result.audit_warnings == []
        # CPT value should still be set in the record
>       assert result.record.procedures_performed.linear_ebus.performed is True
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E       AttributeError: 'NoneType' object has no attribute 'performed'

tests/registry/test_registry_service_hybrid_flow.py:724: AttributeError
----------------------------- Captured stderr call -----------------------------
{"timestamp": "2026-01-18T00:35:58.752629", "level": "WARNING", "logger": "ner.inference", "message": "GranularNERPredictor unavailable: Model directory not found: artifacts/granular_ner_model"}
{"timestamp": "2026-01-18T00:35:58.752719", "level": "INFO", "logger": "coder.parallel_pathway", "message": "ParallelPathwayOrchestrator initialized: NER=unavailable, ML=unavailable"}
{"timestamp": "2026-01-18T00:35:58.755884", "level": "WARNING", "logger": "coder.parallel_pathway", "message": "Path B failed: 'StubRegistryPredictor' object has no attribute 'predict'"}
{"timestamp": "2026-01-18T00:35:58.756032", "level": "INFO", "logger": "ml_coder.predictor", "message": "Loading model from data/models/cpt_classifier.pkl"}
{"timestamp": "2026-01-18T00:35:58.782948", "level": "INFO", "logger": "ml_coder.predictor", "message": "Predictor initialized with 35 labels, upper=0.70, lower=0.40"}
------------------------------ Captured log call -------------------------------
WARNING  ner.inference:inference.py:150 GranularNERPredictor unavailable: Model directory not found: artifacts/granular_ner_model
INFO     coder.parallel_pathway:orchestrator.py:157 ParallelPathwayOrchestrator initialized: NER=unavailable, ML=unavailable
WARNING  coder.parallel_pathway:orchestrator.py:430 Path B failed: 'StubRegistryPredictor' object has no attribute 'predict'
INFO     ml_coder.predictor:predictor.py:175 Loading model from data/models/cpt_classifier.pkl
INFO     ml_coder.predictor:predictor.py:185 Predictor initialized with 35 labels, upper=0.70, lower=0.40
_ TestMLHybridAudit.test_multiple_ml_detected_procedures_trigger_multiple_warnings _

self = <test_registry_service_hybrid_flow.TestMLHybridAudit object at 0x181097590>

    def test_multiple_ml_detected_procedures_trigger_multiple_warnings(self) -> None:
        """When ML detects multiple procedures CPT missed, all should be warned."""
        # Arrange: orchestrator returns no procedure codes
        fake_orchestrator = MagicMock()
        fake_orchestrator.get_codes.return_value = make_fake_hybrid_result(
            codes=["31622"],  # Only diagnostic bronch
            difficulty="high_confidence",
        )
    
        preset_record = RegistryRecord(procedure_type="bronchoscopy")
        stub_engine = StubRegistryEngine(preset_record=preset_record)
    
        service = RegistryService(
            hybrid_orchestrator=fake_orchestrator,
            registry_engine=stub_engine,
        )
    
        # Inject stub predictor that detects multiple procedures
        service._registry_ml_predictor = StubRegistryPredictor(
            positive_fields=["linear_ebus", "navigational_bronchoscopy", "transbronchial_biopsy"],
            probabilities={
                "linear_ebus": 0.92,
                "navigational_bronchoscopy": 0.87,
                "transbronchial_biopsy": 0.78,
            },
        )
        service._ml_predictor_init_attempted = True
    
        # Act
        result = service.extract_fields("Complex procedure - ML detected multiple")
    
        # Assert: Multiple audit warnings
>       assert result.needs_manual_review is True
E       assert False is True
E        +  where False = RegistryExtractionResult(record=RegistryRecord(patient_mrn=None, procedure_date=None, procedure_start_time=None, proce...ConfigSnapshot(use_buckets=True, top_k=25, min_prob=0.5, self_correct_min_prob=0.95), warnings=[]), self_correction=[]).needs_manual_review

tests/registry/test_registry_service_hybrid_flow.py:758: AssertionError
----------------------------- Captured stderr call -----------------------------
{"timestamp": "2026-01-18T00:35:58.805256", "level": "WARNING", "logger": "ner.inference", "message": "GranularNERPredictor unavailable: Model directory not found: artifacts/granular_ner_model"}
{"timestamp": "2026-01-18T00:35:58.805356", "level": "INFO", "logger": "coder.parallel_pathway", "message": "ParallelPathwayOrchestrator initialized: NER=unavailable, ML=unavailable"}
{"timestamp": "2026-01-18T00:35:58.808923", "level": "WARNING", "logger": "coder.parallel_pathway", "message": "Path B failed: 'StubRegistryPredictor' object has no attribute 'predict'"}
{"timestamp": "2026-01-18T00:35:58.809083", "level": "INFO", "logger": "ml_coder.predictor", "message": "Loading model from data/models/cpt_classifier.pkl"}
{"timestamp": "2026-01-18T00:35:58.836500", "level": "INFO", "logger": "ml_coder.predictor", "message": "Predictor initialized with 35 labels, upper=0.70, lower=0.40"}
------------------------------ Captured log call -------------------------------
WARNING  ner.inference:inference.py:150 GranularNERPredictor unavailable: Model directory not found: artifacts/granular_ner_model
INFO     coder.parallel_pathway:orchestrator.py:157 ParallelPathwayOrchestrator initialized: NER=unavailable, ML=unavailable
WARNING  coder.parallel_pathway:orchestrator.py:430 Path B failed: 'StubRegistryPredictor' object has no attribute 'predict'
INFO     ml_coder.predictor:predictor.py:175 Loading model from data/models/cpt_classifier.pkl
INFO     ml_coder.predictor:predictor.py:185 Predictor initialized with 35 labels, upper=0.70, lower=0.40
______ TestMLHybridAudit.test_audit_warnings_included_in_result_dataclass ______

self = <test_registry_service_hybrid_flow.TestMLHybridAudit object at 0x1810a02d0>

    def test_audit_warnings_included_in_result_dataclass(self) -> None:
        """Verify audit_warnings field is properly populated in result."""
        fake_orchestrator = MagicMock()
        fake_orchestrator.get_codes.return_value = make_fake_hybrid_result(
            codes=["31622"],
            difficulty="high_confidence",
        )
    
        preset_record = RegistryRecord(procedure_type="bronchoscopy")
        stub_engine = StubRegistryEngine(preset_record=preset_record)
    
        service = RegistryService(
            hybrid_orchestrator=fake_orchestrator,
            registry_engine=stub_engine,
        )
    
        service._registry_ml_predictor = StubRegistryPredictor(
            positive_fields=["blvr"],
            probabilities={"blvr": 0.95},
        )
        service._ml_predictor_init_attempted = True
    
        result = service.extract_fields("Valve procedure")
    
        # Assert: audit_warnings is a list with expected content
        assert isinstance(result.audit_warnings, list)
>       assert len(result.audit_warnings) == 1
E       AssertionError: assert 2 == 1
E        +  where 2 = len(['RAW_ML_AUDIT[HIGH_CONF]: model suggests 31647 (prob=0.53), but deterministic derivation missed it', 'RAW_ML_AUDIT[GRAY_ZONE]: model suggests 31634 (prob=0.52), but deterministic derivation missed it'])
E        +    where ['RAW_ML_AUDIT[HIGH_CONF]: model suggests 31647 (prob=0.53), but deterministic derivation missed it', 'RAW_ML_AUDIT[GRAY_ZONE]: model suggests 31634 (prob=0.52), but deterministic derivation missed it'] = RegistryExtractionResult(record=RegistryRecord(patient_mrn=None, procedure_date=None, procedure_start_time=None, proce...ConfigSnapshot(use_buckets=True, top_k=25, min_prob=0.5, self_correct_min_prob=0.95), warnings=[]), self_correction=[]).audit_warnings

tests/registry/test_registry_service_hybrid_flow.py:820: AssertionError
----------------------------- Captured stderr call -----------------------------
{"timestamp": "2026-01-18T00:35:58.903644", "level": "WARNING", "logger": "ner.inference", "message": "GranularNERPredictor unavailable: Model directory not found: artifacts/granular_ner_model"}
{"timestamp": "2026-01-18T00:35:58.903852", "level": "INFO", "logger": "coder.parallel_pathway", "message": "ParallelPathwayOrchestrator initialized: NER=unavailable, ML=unavailable"}
{"timestamp": "2026-01-18T00:35:58.906738", "level": "WARNING", "logger": "coder.parallel_pathway", "message": "Path B failed: 'StubRegistryPredictor' object has no attribute 'predict'"}
{"timestamp": "2026-01-18T00:35:58.906888", "level": "INFO", "logger": "ml_coder.predictor", "message": "Loading model from data/models/cpt_classifier.pkl"}
{"timestamp": "2026-01-18T00:35:58.933402", "level": "INFO", "logger": "ml_coder.predictor", "message": "Predictor initialized with 35 labels, upper=0.70, lower=0.40"}
------------------------------ Captured log call -------------------------------
WARNING  ner.inference:inference.py:150 GranularNERPredictor unavailable: Model directory not found: artifacts/granular_ner_model
INFO     coder.parallel_pathway:orchestrator.py:157 ParallelPathwayOrchestrator initialized: NER=unavailable, ML=unavailable
WARNING  coder.parallel_pathway:orchestrator.py:430 Path B failed: 'StubRegistryPredictor' object has no attribute 'predict'
INFO     ml_coder.predictor:predictor.py:175 Loading model from data/models/cpt_classifier.pkl
INFO     ml_coder.predictor:predictor.py:185 Predictor initialized with 35 labels, upper=0.70, lower=0.40
____________________ test_self_correction_successful_patch _____________________

monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x1d614dc50>

    def test_self_correction_successful_patch(monkeypatch: pytest.MonkeyPatch) -> None:
        monkeypatch.setenv("PROCSUITE_PIPELINE_MODE", "extraction_first")
        monkeypatch.setenv("REGISTRY_SELF_CORRECT_ENABLED", "1")
        monkeypatch.setenv("REGISTRY_AUDITOR_SOURCE", "raw_ml")
    
        _stub_raw_ml_high_conf(monkeypatch, cpt="32550", prob=0.99)
    
        from modules.registry.self_correction.judge import PatchProposal, RegistryCorrectionJudge
    
        mocked = MagicMock(
            return_value=PatchProposal(
                rationale="Procedure explicitly documented",
                json_patch=[{"op": "add", "path": "/pleural_procedures/ipc/performed", "value": True}],
                evidence_quote="indwelling pleural catheter",
            )
        )
        monkeypatch.setattr(RegistryCorrectionJudge, "propose_correction", mocked)
    
        orchestrator = MagicMock()
        orchestrator.get_codes.side_effect = RuntimeError("SmartHybridOrchestrator.get_codes() called")
    
        service = RegistryService(hybrid_orchestrator=orchestrator, registry_engine=_StubRegistryEngine())
        note_text = (
            "PROCEDURE:\n"
            "The patient underwent insertion of an indwelling pleural catheter (PleurX).\n"
            "No complications."
        )
        result = service.extract_fields(note_text)
    
        assert "32550" in result.cpt_codes
>       assert any(w.startswith("AUTO_CORRECTED: 32550") for w in result.warnings)
E       assert False
E        +  where False = any(<generator object test_self_correction_successful_patch.<locals>.<genexpr> at 0x1cf047bc0>)

tests/registry/test_self_correction_loop.py:90: AssertionError
----------------------------- Captured stderr call -----------------------------
{"timestamp": "2026-01-18T00:35:59.030410", "level": "WARNING", "logger": "ner.inference", "message": "GranularNERPredictor unavailable: Model directory not found: artifacts/granular_ner_model"}
{"timestamp": "2026-01-18T00:35:59.030501", "level": "INFO", "logger": "coder.parallel_pathway", "message": "ParallelPathwayOrchestrator initialized: NER=unavailable, ML=unavailable"}
{"timestamp": "2026-01-18T00:35:59.079121", "level": "WARNING", "logger": "registry.inference_pytorch", "message": "TorchRegistryPredictor unavailable: Unrecognized model in data/models/registry_runtime. Should have a `model_type` key in its config.json, or contain one of the following strings in its name: albert, align, altclip, arcee, aria, aria_text, audio-spectrogram-transformer, autoformer, aya_vision, bamba, bark, bart, beit, bert, bert-generation, big_bird, bigbird_pegasus, biogpt, bit, bitnet, blenderbot, blenderbot-small, blip, blip-2, blip_2_qformer, bloom, bridgetower, bros, camembert, canine, chameleon, chinese_clip, chinese_clip_vision_model, clap, clip, clip_text_model, clip_vision_model, clipseg, clvp, code_llama, codegen, cohere, cohere2, colpali, colqwen2, conditional_detr, convbert, convnext, convnextv2, cpmant, csm, ctrl, cvt, d_fine, dab-detr, dac, data2vec-audio, data2vec-text, data2vec-vision, dbrx, deberta, deberta-v2, decision_transformer, deepseek_v3, deformable_detr, deit, depth_anything, depth_pro, deta, detr, dia, diffllama, dinat, dinov2, dinov2_with_registers, distilbert, donut-swin, dots1, dpr, dpt, efficientformer, efficientnet, electra, emu3, encodec, encoder-decoder, ernie, ernie_m, esm, falcon, falcon_h1, falcon_mamba, fastspeech2_conformer, flaubert, flava, fnet, focalnet, fsmt, funnel, fuyu, gemma, gemma2, gemma3, gemma3_text, gemma3n, gemma3n_audio, gemma3n_text, gemma3n_vision, git, glm, glm4, glm4v, glm4v_text, glpn, got_ocr2, gpt-sw3, gpt2, gpt_bigcode, gpt_neo, gpt_neox, gpt_neox_japanese, gptj, gptsan-japanese, granite, granite_speech, granitemoe, granitemoehybrid, granitemoeshared, granitevision, graphormer, grounding-dino, groupvit, helium, hgnet_v2, hiera, hubert, ibert, idefics, idefics2, idefics3, idefics3_vision, ijepa, imagegpt, informer, instructblip, instructblipvideo, internvl, internvl_vision, jamba, janus, jetmoe, jukebox, kosmos-2, kyutai_speech_to_text, layoutlm, layoutlmv2, layoutlmv3, led, levit, lightglue, lilt, llama, llama4, llama4_text, llava, llava_next, llava_next_video, llava_onevision, longformer, longt5, luke, lxmert, m2m_100, mamba, mamba2, marian, markuplm, mask2former, maskformer, maskformer-swin, mbart, mctct, mega, megatron-bert, mgp-str, mimi, minimax, mistral, mistral3, mixtral, mlcd, mllama, mobilebert, mobilenet_v1, mobilenet_v2, mobilevit, mobilevitv2, modernbert, moonshine, moshi, mpnet, mpt, mra, mt5, musicgen, musicgen_melody, mvp, nat, nemotron, nezha, nllb-moe, nougat, nystromformer, olmo, olmo2, olmoe, omdet-turbo, oneformer, open-llama, openai-gpt, opt, owlv2, owlvit, paligemma, patchtsmixer, patchtst, pegasus, pegasus_x, perceiver, persimmon, phi, phi3, phi4_multimodal, phimoe, pix2struct, pixtral, plbart, poolformer, pop2piano, prompt_depth_anything, prophetnet, pvt, pvt_v2, qdqbert, qwen2, qwen2_5_omni, qwen2_5_vl, qwen2_5_vl_text, qwen2_audio, qwen2_audio_encoder, qwen2_moe, qwen2_vl, qwen2_vl_text, qwen3, qwen3_moe, rag, realm, recurrent_gemma, reformer, regnet, rembert, resnet, retribert, roberta, roberta-prelayernorm, roc_bert, roformer, rt_detr, rt_detr_resnet, rt_detr_v2, rwkv, sam, sam_hq, sam_hq_vision_model, sam_vision_model, seamless_m4t, seamless_m4t_v2, segformer, seggpt, sew, sew-d, shieldgemma2, siglip, siglip2, siglip_vision_model, smollm3, smolvlm, smolvlm_vision, speech-encoder-decoder, speech_to_text, speech_to_text_2, speecht5, splinter, squeezebert, stablelm, starcoder2, superglue, superpoint, swiftformer, swin, swin2sr, swinv2, switch_transformers, t5, t5gemma, table-transformer, tapas, textnet, time_series_transformer, timesfm, timesformer, timm_backbone, timm_wrapper, trajectory_transformer, transfo-xl, trocr, tvlt, tvp, udop, umt5, unispeech, unispeech-sat, univnet, upernet, van, video_llava, videomae, vilt, vipllava, vision-encoder-decoder, vision-text-dual-encoder, visual_bert, vit, vit_hybrid, vit_mae, vit_msn, vitdet, vitmatte, vitpose, vitpose_backbone, vits, vivit, vjepa2, wav2vec2, wav2vec2-bert, wav2vec2-conformer, wavlm, whisper, xclip, xglm, xlm, xlm-prophetnet, xlm-roberta, xlm-roberta-xl, xlnet, xmod, yolos, yoso, zamba, zamba2, zoedepth"}
{"timestamp": "2026-01-18T00:35:59.079480", "level": "INFO", "logger": "ml_coder.registry_predictor", "message": "Loading registry model from data/models/registry_classifier.pkl"}
{"timestamp": "2026-01-18T00:35:59.151166", "level": "INFO", "logger": "ml_coder.registry_predictor", "message": "Loaded 21 labels from MLB"}
{"timestamp": "2026-01-18T00:35:59.151710", "level": "INFO", "logger": "ml_coder.registry_predictor", "message": "RegistryMLPredictor initialized with 21 labels"}
{"timestamp": "2026-01-18T00:35:59.152013", "level": "INFO", "logger": "registry_service", "message": "Using RegistryMLPredictor (TF-IDF) with 21 labels"}
{"timestamp": "2026-01-18T00:35:59.176767", "level": "WARNING", "logger": "coder.parallel_pathway", "message": "Path B failed: 'list' object has no attribute 'predictions'"}
------------------------------ Captured log call -------------------------------
WARNING  ner.inference:inference.py:150 GranularNERPredictor unavailable: Model directory not found: artifacts/granular_ner_model
INFO     coder.parallel_pathway:orchestrator.py:157 ParallelPathwayOrchestrator initialized: NER=unavailable, ML=unavailable
WARNING  registry.inference_pytorch:inference_pytorch.py:78 TorchRegistryPredictor unavailable: Unrecognized model in data/models/registry_runtime. Should have a `model_type` key in its config.json, or contain one of the following strings in its name: albert, align, altclip, arcee, aria, aria_text, audio-spectrogram-transformer, autoformer, aya_vision, bamba, bark, bart, beit, bert, bert-generation, big_bird, bigbird_pegasus, biogpt, bit, bitnet, blenderbot, blenderbot-small, blip, blip-2, blip_2_qformer, bloom, bridgetower, bros, camembert, canine, chameleon, chinese_clip, chinese_clip_vision_model, clap, clip, clip_text_model, clip_vision_model, clipseg, clvp, code_llama, codegen, cohere, cohere2, colpali, colqwen2, conditional_detr, convbert, convnext, convnextv2, cpmant, csm, ctrl, cvt, d_fine, dab-detr, dac, data2vec-audio, data2vec-text, data2vec-vision, dbrx, deberta, deberta-v2, decision_transformer, deepseek_v3, deformable_detr, deit, depth_anything, depth_pro, deta, detr, dia, diffllama, dinat, dinov2, dinov2_with_registers, distilbert, donut-swin, dots1, dpr, dpt, efficientformer, efficientnet, electra, emu3, encodec, encoder-decoder, ernie, ernie_m, esm, falcon, falcon_h1, falcon_mamba, fastspeech2_conformer, flaubert, flava, fnet, focalnet, fsmt, funnel, fuyu, gemma, gemma2, gemma3, gemma3_text, gemma3n, gemma3n_audio, gemma3n_text, gemma3n_vision, git, glm, glm4, glm4v, glm4v_text, glpn, got_ocr2, gpt-sw3, gpt2, gpt_bigcode, gpt_neo, gpt_neox, gpt_neox_japanese, gptj, gptsan-japanese, granite, granite_speech, granitemoe, granitemoehybrid, granitemoeshared, granitevision, graphormer, grounding-dino, groupvit, helium, hgnet_v2, hiera, hubert, ibert, idefics, idefics2, idefics3, idefics3_vision, ijepa, imagegpt, informer, instructblip, instructblipvideo, internvl, internvl_vision, jamba, janus, jetmoe, jukebox, kosmos-2, kyutai_speech_to_text, layoutlm, layoutlmv2, layoutlmv3, led, levit, lightglue, lilt, llama, llama4, llama4_text, llava, llava_next, llava_next_video, llava_onevision, longformer, longt5, luke, lxmert, m2m_100, mamba, mamba2, marian, markuplm, mask2former, maskformer, maskformer-swin, mbart, mctct, mega, megatron-bert, mgp-str, mimi, minimax, mistral, mistral3, mixtral, mlcd, mllama, mobilebert, mobilenet_v1, mobilenet_v2, mobilevit, mobilevitv2, modernbert, moonshine, moshi, mpnet, mpt, mra, mt5, musicgen, musicgen_melody, mvp, nat, nemotron, nezha, nllb-moe, nougat, nystromformer, olmo, olmo2, olmoe, omdet-turbo, oneformer, open-llama, openai-gpt, opt, owlv2, owlvit, paligemma, patchtsmixer, patchtst, pegasus, pegasus_x, perceiver, persimmon, phi, phi3, phi4_multimodal, phimoe, pix2struct, pixtral, plbart, poolformer, pop2piano, prompt_depth_anything, prophetnet, pvt, pvt_v2, qdqbert, qwen2, qwen2_5_omni, qwen2_5_vl, qwen2_5_vl_text, qwen2_audio, qwen2_audio_encoder, qwen2_moe, qwen2_vl, qwen2_vl_text, qwen3, qwen3_moe, rag, realm, recurrent_gemma, reformer, regnet, rembert, resnet, retribert, roberta, roberta-prelayernorm, roc_bert, roformer, rt_detr, rt_detr_resnet, rt_detr_v2, rwkv, sam, sam_hq, sam_hq_vision_model, sam_vision_model, seamless_m4t, seamless_m4t_v2, segformer, seggpt, sew, sew-d, shieldgemma2, siglip, siglip2, siglip_vision_model, smollm3, smolvlm, smolvlm_vision, speech-encoder-decoder, speech_to_text, speech_to_text_2, speecht5, splinter, squeezebert, stablelm, starcoder2, superglue, superpoint, swiftformer, swin, swin2sr, swinv2, switch_transformers, t5, t5gemma, table-transformer, tapas, textnet, time_series_transformer, timesfm, timesformer, timm_backbone, timm_wrapper, trajectory_transformer, transfo-xl, trocr, tvlt, tvp, udop, umt5, unispeech, unispeech-sat, univnet, upernet, van, video_llava, videomae, vilt, vipllava, vision-encoder-decoder, vision-text-dual-encoder, visual_bert, vit, vit_hybrid, vit_mae, vit_msn, vitdet, vitmatte, vitpose, vitpose_backbone, vits, vivit, vjepa2, wav2vec2, wav2vec2-bert, wav2vec2-conformer, wavlm, whisper, xclip, xglm, xlm, xlm-prophetnet, xlm-roberta, xlm-roberta-xl, xlnet, xmod, yolos, yoso, zamba, zamba2, zoedepth
INFO     ml_coder.registry_predictor:registry_predictor.py:156 Loading registry model from data/models/registry_classifier.pkl
INFO     ml_coder.registry_predictor:registry_predictor.py:163 Loaded 21 labels from MLB
INFO     ml_coder.registry_predictor:registry_predictor.py:180 RegistryMLPredictor initialized with 21 labels
INFO     registry_service:registry_service.py:337 Using RegistryMLPredictor (TF-IDF) with 21 labels
WARNING  coder.parallel_pathway:orchestrator.py:430 Path B failed: 'list' object has no attribute 'predictions'
_______________ test_self_correction_rejects_hallucinated_quote ________________

monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x1d5e12910>

    def test_self_correction_rejects_hallucinated_quote(monkeypatch: pytest.MonkeyPatch) -> None:
        monkeypatch.setenv("PROCSUITE_PIPELINE_MODE", "extraction_first")
        monkeypatch.setenv("REGISTRY_SELF_CORRECT_ENABLED", "1")
        monkeypatch.setenv("REGISTRY_AUDITOR_SOURCE", "raw_ml")
    
        _stub_raw_ml_high_conf(monkeypatch, cpt="32550", prob=0.99)
    
        from modules.registry.self_correction.judge import PatchProposal, RegistryCorrectionJudge
    
        def _hallucinating_judge(  # type: ignore[no-untyped-def]
            self,
            note_text: str,
            record: RegistryRecord,
            discrepancy: str,
            *,
            focused_procedure_text: str | None = None,
        ) -> PatchProposal:
            return PatchProposal(
                rationale="hallucinated for test",
                json_patch=[{"op": "add", "path": "/pleural_procedures/ipc/performed", "value": True}],
                evidence_quote="THIS QUOTE DOES NOT APPEAR IN THE NOTE",
            )
    
        monkeypatch.setattr(RegistryCorrectionJudge, "propose_correction", _hallucinating_judge)
    
        service = RegistryService(hybrid_orchestrator=MagicMock(), registry_engine=_StubRegistryEngine())
        result = service.extract_fields(
            "PROCEDURE:\nInsertion of an indwelling pleural catheter (PleurX).\nNo complications."
        )
    
>       assert "32550" not in result.cpt_codes
E       AssertionError: assert '32550' not in ['32550']
E        +  where ['32550'] = RegistryExtractionResult(record=RegistryRecord(patient_mrn=None, procedure_date=None, procedure_start_time=None, proce...ConfigSnapshot(use_buckets=True, top_k=25, min_prob=0.5, self_correct_min_prob=0.95), warnings=[]), self_correction=[]).cpt_codes

tests/registry/test_self_correction_loop.py:129: AssertionError
----------------------------- Captured stderr call -----------------------------
{"timestamp": "2026-01-18T00:35:59.187024", "level": "WARNING", "logger": "ner.inference", "message": "GranularNERPredictor unavailable: Model directory not found: artifacts/granular_ner_model"}
{"timestamp": "2026-01-18T00:35:59.187146", "level": "INFO", "logger": "coder.parallel_pathway", "message": "ParallelPathwayOrchestrator initialized: NER=unavailable, ML=unavailable"}
{"timestamp": "2026-01-18T00:35:59.208863", "level": "WARNING", "logger": "registry.inference_pytorch", "message": "TorchRegistryPredictor unavailable: Unrecognized model in data/models/registry_runtime. Should have a `model_type` key in its config.json, or contain one of the following strings in its name: albert, align, altclip, arcee, aria, aria_text, audio-spectrogram-transformer, autoformer, aya_vision, bamba, bark, bart, beit, bert, bert-generation, big_bird, bigbird_pegasus, biogpt, bit, bitnet, blenderbot, blenderbot-small, blip, blip-2, blip_2_qformer, bloom, bridgetower, bros, camembert, canine, chameleon, chinese_clip, chinese_clip_vision_model, clap, clip, clip_text_model, clip_vision_model, clipseg, clvp, code_llama, codegen, cohere, cohere2, colpali, colqwen2, conditional_detr, convbert, convnext, convnextv2, cpmant, csm, ctrl, cvt, d_fine, dab-detr, dac, data2vec-audio, data2vec-text, data2vec-vision, dbrx, deberta, deberta-v2, decision_transformer, deepseek_v3, deformable_detr, deit, depth_anything, depth_pro, deta, detr, dia, diffllama, dinat, dinov2, dinov2_with_registers, distilbert, donut-swin, dots1, dpr, dpt, efficientformer, efficientnet, electra, emu3, encodec, encoder-decoder, ernie, ernie_m, esm, falcon, falcon_h1, falcon_mamba, fastspeech2_conformer, flaubert, flava, fnet, focalnet, fsmt, funnel, fuyu, gemma, gemma2, gemma3, gemma3_text, gemma3n, gemma3n_audio, gemma3n_text, gemma3n_vision, git, glm, glm4, glm4v, glm4v_text, glpn, got_ocr2, gpt-sw3, gpt2, gpt_bigcode, gpt_neo, gpt_neox, gpt_neox_japanese, gptj, gptsan-japanese, granite, granite_speech, granitemoe, granitemoehybrid, granitemoeshared, granitevision, graphormer, grounding-dino, groupvit, helium, hgnet_v2, hiera, hubert, ibert, idefics, idefics2, idefics3, idefics3_vision, ijepa, imagegpt, informer, instructblip, instructblipvideo, internvl, internvl_vision, jamba, janus, jetmoe, jukebox, kosmos-2, kyutai_speech_to_text, layoutlm, layoutlmv2, layoutlmv3, led, levit, lightglue, lilt, llama, llama4, llama4_text, llava, llava_next, llava_next_video, llava_onevision, longformer, longt5, luke, lxmert, m2m_100, mamba, mamba2, marian, markuplm, mask2former, maskformer, maskformer-swin, mbart, mctct, mega, megatron-bert, mgp-str, mimi, minimax, mistral, mistral3, mixtral, mlcd, mllama, mobilebert, mobilenet_v1, mobilenet_v2, mobilevit, mobilevitv2, modernbert, moonshine, moshi, mpnet, mpt, mra, mt5, musicgen, musicgen_melody, mvp, nat, nemotron, nezha, nllb-moe, nougat, nystromformer, olmo, olmo2, olmoe, omdet-turbo, oneformer, open-llama, openai-gpt, opt, owlv2, owlvit, paligemma, patchtsmixer, patchtst, pegasus, pegasus_x, perceiver, persimmon, phi, phi3, phi4_multimodal, phimoe, pix2struct, pixtral, plbart, poolformer, pop2piano, prompt_depth_anything, prophetnet, pvt, pvt_v2, qdqbert, qwen2, qwen2_5_omni, qwen2_5_vl, qwen2_5_vl_text, qwen2_audio, qwen2_audio_encoder, qwen2_moe, qwen2_vl, qwen2_vl_text, qwen3, qwen3_moe, rag, realm, recurrent_gemma, reformer, regnet, rembert, resnet, retribert, roberta, roberta-prelayernorm, roc_bert, roformer, rt_detr, rt_detr_resnet, rt_detr_v2, rwkv, sam, sam_hq, sam_hq_vision_model, sam_vision_model, seamless_m4t, seamless_m4t_v2, segformer, seggpt, sew, sew-d, shieldgemma2, siglip, siglip2, siglip_vision_model, smollm3, smolvlm, smolvlm_vision, speech-encoder-decoder, speech_to_text, speech_to_text_2, speecht5, splinter, squeezebert, stablelm, starcoder2, superglue, superpoint, swiftformer, swin, swin2sr, swinv2, switch_transformers, t5, t5gemma, table-transformer, tapas, textnet, time_series_transformer, timesfm, timesformer, timm_backbone, timm_wrapper, trajectory_transformer, transfo-xl, trocr, tvlt, tvp, udop, umt5, unispeech, unispeech-sat, univnet, upernet, van, video_llava, videomae, vilt, vipllava, vision-encoder-decoder, vision-text-dual-encoder, visual_bert, vit, vit_hybrid, vit_mae, vit_msn, vitdet, vitmatte, vitpose, vitpose_backbone, vits, vivit, vjepa2, wav2vec2, wav2vec2-bert, wav2vec2-conformer, wavlm, whisper, xclip, xglm, xlm, xlm-prophetnet, xlm-roberta, xlm-roberta-xl, xlnet, xmod, yolos, yoso, zamba, zamba2, zoedepth"}
{"timestamp": "2026-01-18T00:35:59.209735", "level": "INFO", "logger": "ml_coder.registry_predictor", "message": "Loading registry model from data/models/registry_classifier.pkl"}
{"timestamp": "2026-01-18T00:35:59.253906", "level": "INFO", "logger": "ml_coder.registry_predictor", "message": "Loaded 21 labels from MLB"}
{"timestamp": "2026-01-18T00:35:59.254059", "level": "INFO", "logger": "ml_coder.registry_predictor", "message": "RegistryMLPredictor initialized with 21 labels"}
{"timestamp": "2026-01-18T00:35:59.254099", "level": "INFO", "logger": "registry_service", "message": "Using RegistryMLPredictor (TF-IDF) with 21 labels"}
{"timestamp": "2026-01-18T00:35:59.273264", "level": "WARNING", "logger": "coder.parallel_pathway", "message": "Path B failed: 'list' object has no attribute 'predictions'"}
------------------------------ Captured log call -------------------------------
WARNING  ner.inference:inference.py:150 GranularNERPredictor unavailable: Model directory not found: artifacts/granular_ner_model
INFO     coder.parallel_pathway:orchestrator.py:157 ParallelPathwayOrchestrator initialized: NER=unavailable, ML=unavailable
WARNING  registry.inference_pytorch:inference_pytorch.py:78 TorchRegistryPredictor unavailable: Unrecognized model in data/models/registry_runtime. Should have a `model_type` key in its config.json, or contain one of the following strings in its name: albert, align, altclip, arcee, aria, aria_text, audio-spectrogram-transformer, autoformer, aya_vision, bamba, bark, bart, beit, bert, bert-generation, big_bird, bigbird_pegasus, biogpt, bit, bitnet, blenderbot, blenderbot-small, blip, blip-2, blip_2_qformer, bloom, bridgetower, bros, camembert, canine, chameleon, chinese_clip, chinese_clip_vision_model, clap, clip, clip_text_model, clip_vision_model, clipseg, clvp, code_llama, codegen, cohere, cohere2, colpali, colqwen2, conditional_detr, convbert, convnext, convnextv2, cpmant, csm, ctrl, cvt, d_fine, dab-detr, dac, data2vec-audio, data2vec-text, data2vec-vision, dbrx, deberta, deberta-v2, decision_transformer, deepseek_v3, deformable_detr, deit, depth_anything, depth_pro, deta, detr, dia, diffllama, dinat, dinov2, dinov2_with_registers, distilbert, donut-swin, dots1, dpr, dpt, efficientformer, efficientnet, electra, emu3, encodec, encoder-decoder, ernie, ernie_m, esm, falcon, falcon_h1, falcon_mamba, fastspeech2_conformer, flaubert, flava, fnet, focalnet, fsmt, funnel, fuyu, gemma, gemma2, gemma3, gemma3_text, gemma3n, gemma3n_audio, gemma3n_text, gemma3n_vision, git, glm, glm4, glm4v, glm4v_text, glpn, got_ocr2, gpt-sw3, gpt2, gpt_bigcode, gpt_neo, gpt_neox, gpt_neox_japanese, gptj, gptsan-japanese, granite, granite_speech, granitemoe, granitemoehybrid, granitemoeshared, granitevision, graphormer, grounding-dino, groupvit, helium, hgnet_v2, hiera, hubert, ibert, idefics, idefics2, idefics3, idefics3_vision, ijepa, imagegpt, informer, instructblip, instructblipvideo, internvl, internvl_vision, jamba, janus, jetmoe, jukebox, kosmos-2, kyutai_speech_to_text, layoutlm, layoutlmv2, layoutlmv3, led, levit, lightglue, lilt, llama, llama4, llama4_text, llava, llava_next, llava_next_video, llava_onevision, longformer, longt5, luke, lxmert, m2m_100, mamba, mamba2, marian, markuplm, mask2former, maskformer, maskformer-swin, mbart, mctct, mega, megatron-bert, mgp-str, mimi, minimax, mistral, mistral3, mixtral, mlcd, mllama, mobilebert, mobilenet_v1, mobilenet_v2, mobilevit, mobilevitv2, modernbert, moonshine, moshi, mpnet, mpt, mra, mt5, musicgen, musicgen_melody, mvp, nat, nemotron, nezha, nllb-moe, nougat, nystromformer, olmo, olmo2, olmoe, omdet-turbo, oneformer, open-llama, openai-gpt, opt, owlv2, owlvit, paligemma, patchtsmixer, patchtst, pegasus, pegasus_x, perceiver, persimmon, phi, phi3, phi4_multimodal, phimoe, pix2struct, pixtral, plbart, poolformer, pop2piano, prompt_depth_anything, prophetnet, pvt, pvt_v2, qdqbert, qwen2, qwen2_5_omni, qwen2_5_vl, qwen2_5_vl_text, qwen2_audio, qwen2_audio_encoder, qwen2_moe, qwen2_vl, qwen2_vl_text, qwen3, qwen3_moe, rag, realm, recurrent_gemma, reformer, regnet, rembert, resnet, retribert, roberta, roberta-prelayernorm, roc_bert, roformer, rt_detr, rt_detr_resnet, rt_detr_v2, rwkv, sam, sam_hq, sam_hq_vision_model, sam_vision_model, seamless_m4t, seamless_m4t_v2, segformer, seggpt, sew, sew-d, shieldgemma2, siglip, siglip2, siglip_vision_model, smollm3, smolvlm, smolvlm_vision, speech-encoder-decoder, speech_to_text, speech_to_text_2, speecht5, splinter, squeezebert, stablelm, starcoder2, superglue, superpoint, swiftformer, swin, swin2sr, swinv2, switch_transformers, t5, t5gemma, table-transformer, tapas, textnet, time_series_transformer, timesfm, timesformer, timm_backbone, timm_wrapper, trajectory_transformer, transfo-xl, trocr, tvlt, tvp, udop, umt5, unispeech, unispeech-sat, univnet, upernet, van, video_llava, videomae, vilt, vipllava, vision-encoder-decoder, vision-text-dual-encoder, visual_bert, vit, vit_hybrid, vit_mae, vit_msn, vitdet, vitmatte, vitpose, vitpose_backbone, vits, vivit, vjepa2, wav2vec2, wav2vec2-bert, wav2vec2-conformer, wavlm, whisper, xclip, xglm, xlm, xlm-prophetnet, xlm-roberta, xlm-roberta-xl, xlnet, xmod, yolos, yoso, zamba, zamba2, zoedepth
INFO     ml_coder.registry_predictor:registry_predictor.py:156 Loading registry model from data/models/registry_classifier.pkl
INFO     ml_coder.registry_predictor:registry_predictor.py:163 Loaded 21 labels from MLB
INFO     ml_coder.registry_predictor:registry_predictor.py:180 RegistryMLPredictor initialized with 21 labels
INFO     registry_service:registry_service.py:337 Using RegistryMLPredictor (TF-IDF) with 21 labels
WARNING  coder.parallel_pathway:orchestrator.py:430 Path B failed: 'list' object has no attribute 'predictions'
_________________ test_self_correction_rejects_forbidden_path __________________

monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x1d6148450>

    def test_self_correction_rejects_forbidden_path(monkeypatch: pytest.MonkeyPatch) -> None:
        monkeypatch.setenv("PROCSUITE_PIPELINE_MODE", "extraction_first")
        monkeypatch.setenv("REGISTRY_SELF_CORRECT_ENABLED", "1")
        monkeypatch.setenv("REGISTRY_AUDITOR_SOURCE", "raw_ml")
    
        _stub_raw_ml_high_conf(monkeypatch, cpt="32550", prob=0.99)
    
        from modules.registry.self_correction.judge import PatchProposal, RegistryCorrectionJudge
    
        def _forbidden_path_judge(  # type: ignore[no-untyped-def]
            self,
            note_text: str,
            record: RegistryRecord,
            discrepancy: str,
            *,
            focused_procedure_text: str | None = None,
        ) -> PatchProposal:
            return PatchProposal(
                rationale="forbidden path for test",
                json_patch=[{"op": "add", "path": "/patient_demographics/mrn", "value": "123"}],
                evidence_quote="Insertion of an indwelling pleural catheter",
            )
    
        monkeypatch.setattr(RegistryCorrectionJudge, "propose_correction", _forbidden_path_judge)
    
        service = RegistryService(hybrid_orchestrator=MagicMock(), registry_engine=_StubRegistryEngine())
        result = service.extract_fields(
            "PROCEDURE:\nInsertion of an indwelling pleural catheter (PleurX).\nNo complications."
        )
    
>       assert "32550" not in result.cpt_codes
E       AssertionError: assert '32550' not in ['32550']
E        +  where ['32550'] = RegistryExtractionResult(record=RegistryRecord(patient_mrn=None, procedure_date=None, procedure_start_time=None, proce...ConfigSnapshot(use_buckets=True, top_k=25, min_prob=0.5, self_correct_min_prob=0.95), warnings=[]), self_correction=[]).cpt_codes

tests/registry/test_self_correction_loop.py:164: AssertionError
----------------------------- Captured stderr call -----------------------------
{"timestamp": "2026-01-18T00:35:59.281924", "level": "WARNING", "logger": "ner.inference", "message": "GranularNERPredictor unavailable: Model directory not found: artifacts/granular_ner_model"}
{"timestamp": "2026-01-18T00:35:59.282026", "level": "INFO", "logger": "coder.parallel_pathway", "message": "ParallelPathwayOrchestrator initialized: NER=unavailable, ML=unavailable"}
{"timestamp": "2026-01-18T00:35:59.299209", "level": "WARNING", "logger": "registry.inference_pytorch", "message": "TorchRegistryPredictor unavailable: Unrecognized model in data/models/registry_runtime. Should have a `model_type` key in its config.json, or contain one of the following strings in its name: albert, align, altclip, arcee, aria, aria_text, audio-spectrogram-transformer, autoformer, aya_vision, bamba, bark, bart, beit, bert, bert-generation, big_bird, bigbird_pegasus, biogpt, bit, bitnet, blenderbot, blenderbot-small, blip, blip-2, blip_2_qformer, bloom, bridgetower, bros, camembert, canine, chameleon, chinese_clip, chinese_clip_vision_model, clap, clip, clip_text_model, clip_vision_model, clipseg, clvp, code_llama, codegen, cohere, cohere2, colpali, colqwen2, conditional_detr, convbert, convnext, convnextv2, cpmant, csm, ctrl, cvt, d_fine, dab-detr, dac, data2vec-audio, data2vec-text, data2vec-vision, dbrx, deberta, deberta-v2, decision_transformer, deepseek_v3, deformable_detr, deit, depth_anything, depth_pro, deta, detr, dia, diffllama, dinat, dinov2, dinov2_with_registers, distilbert, donut-swin, dots1, dpr, dpt, efficientformer, efficientnet, electra, emu3, encodec, encoder-decoder, ernie, ernie_m, esm, falcon, falcon_h1, falcon_mamba, fastspeech2_conformer, flaubert, flava, fnet, focalnet, fsmt, funnel, fuyu, gemma, gemma2, gemma3, gemma3_text, gemma3n, gemma3n_audio, gemma3n_text, gemma3n_vision, git, glm, glm4, glm4v, glm4v_text, glpn, got_ocr2, gpt-sw3, gpt2, gpt_bigcode, gpt_neo, gpt_neox, gpt_neox_japanese, gptj, gptsan-japanese, granite, granite_speech, granitemoe, granitemoehybrid, granitemoeshared, granitevision, graphormer, grounding-dino, groupvit, helium, hgnet_v2, hiera, hubert, ibert, idefics, idefics2, idefics3, idefics3_vision, ijepa, imagegpt, informer, instructblip, instructblipvideo, internvl, internvl_vision, jamba, janus, jetmoe, jukebox, kosmos-2, kyutai_speech_to_text, layoutlm, layoutlmv2, layoutlmv3, led, levit, lightglue, lilt, llama, llama4, llama4_text, llava, llava_next, llava_next_video, llava_onevision, longformer, longt5, luke, lxmert, m2m_100, mamba, mamba2, marian, markuplm, mask2former, maskformer, maskformer-swin, mbart, mctct, mega, megatron-bert, mgp-str, mimi, minimax, mistral, mistral3, mixtral, mlcd, mllama, mobilebert, mobilenet_v1, mobilenet_v2, mobilevit, mobilevitv2, modernbert, moonshine, moshi, mpnet, mpt, mra, mt5, musicgen, musicgen_melody, mvp, nat, nemotron, nezha, nllb-moe, nougat, nystromformer, olmo, olmo2, olmoe, omdet-turbo, oneformer, open-llama, openai-gpt, opt, owlv2, owlvit, paligemma, patchtsmixer, patchtst, pegasus, pegasus_x, perceiver, persimmon, phi, phi3, phi4_multimodal, phimoe, pix2struct, pixtral, plbart, poolformer, pop2piano, prompt_depth_anything, prophetnet, pvt, pvt_v2, qdqbert, qwen2, qwen2_5_omni, qwen2_5_vl, qwen2_5_vl_text, qwen2_audio, qwen2_audio_encoder, qwen2_moe, qwen2_vl, qwen2_vl_text, qwen3, qwen3_moe, rag, realm, recurrent_gemma, reformer, regnet, rembert, resnet, retribert, roberta, roberta-prelayernorm, roc_bert, roformer, rt_detr, rt_detr_resnet, rt_detr_v2, rwkv, sam, sam_hq, sam_hq_vision_model, sam_vision_model, seamless_m4t, seamless_m4t_v2, segformer, seggpt, sew, sew-d, shieldgemma2, siglip, siglip2, siglip_vision_model, smollm3, smolvlm, smolvlm_vision, speech-encoder-decoder, speech_to_text, speech_to_text_2, speecht5, splinter, squeezebert, stablelm, starcoder2, superglue, superpoint, swiftformer, swin, swin2sr, swinv2, switch_transformers, t5, t5gemma, table-transformer, tapas, textnet, time_series_transformer, timesfm, timesformer, timm_backbone, timm_wrapper, trajectory_transformer, transfo-xl, trocr, tvlt, tvp, udop, umt5, unispeech, unispeech-sat, univnet, upernet, van, video_llava, videomae, vilt, vipllava, vision-encoder-decoder, vision-text-dual-encoder, visual_bert, vit, vit_hybrid, vit_mae, vit_msn, vitdet, vitmatte, vitpose, vitpose_backbone, vits, vivit, vjepa2, wav2vec2, wav2vec2-bert, wav2vec2-conformer, wavlm, whisper, xclip, xglm, xlm, xlm-prophetnet, xlm-roberta, xlm-roberta-xl, xlnet, xmod, yolos, yoso, zamba, zamba2, zoedepth"}
{"timestamp": "2026-01-18T00:35:59.299349", "level": "INFO", "logger": "ml_coder.registry_predictor", "message": "Loading registry model from data/models/registry_classifier.pkl"}
{"timestamp": "2026-01-18T00:35:59.332256", "level": "INFO", "logger": "ml_coder.registry_predictor", "message": "Loaded 21 labels from MLB"}
{"timestamp": "2026-01-18T00:35:59.332404", "level": "INFO", "logger": "ml_coder.registry_predictor", "message": "RegistryMLPredictor initialized with 21 labels"}
{"timestamp": "2026-01-18T00:35:59.332442", "level": "INFO", "logger": "registry_service", "message": "Using RegistryMLPredictor (TF-IDF) with 21 labels"}
{"timestamp": "2026-01-18T00:35:59.351404", "level": "WARNING", "logger": "coder.parallel_pathway", "message": "Path B failed: 'list' object has no attribute 'predictions'"}
------------------------------ Captured log call -------------------------------
WARNING  ner.inference:inference.py:150 GranularNERPredictor unavailable: Model directory not found: artifacts/granular_ner_model
INFO     coder.parallel_pathway:orchestrator.py:157 ParallelPathwayOrchestrator initialized: NER=unavailable, ML=unavailable
WARNING  registry.inference_pytorch:inference_pytorch.py:78 TorchRegistryPredictor unavailable: Unrecognized model in data/models/registry_runtime. Should have a `model_type` key in its config.json, or contain one of the following strings in its name: albert, align, altclip, arcee, aria, aria_text, audio-spectrogram-transformer, autoformer, aya_vision, bamba, bark, bart, beit, bert, bert-generation, big_bird, bigbird_pegasus, biogpt, bit, bitnet, blenderbot, blenderbot-small, blip, blip-2, blip_2_qformer, bloom, bridgetower, bros, camembert, canine, chameleon, chinese_clip, chinese_clip_vision_model, clap, clip, clip_text_model, clip_vision_model, clipseg, clvp, code_llama, codegen, cohere, cohere2, colpali, colqwen2, conditional_detr, convbert, convnext, convnextv2, cpmant, csm, ctrl, cvt, d_fine, dab-detr, dac, data2vec-audio, data2vec-text, data2vec-vision, dbrx, deberta, deberta-v2, decision_transformer, deepseek_v3, deformable_detr, deit, depth_anything, depth_pro, deta, detr, dia, diffllama, dinat, dinov2, dinov2_with_registers, distilbert, donut-swin, dots1, dpr, dpt, efficientformer, efficientnet, electra, emu3, encodec, encoder-decoder, ernie, ernie_m, esm, falcon, falcon_h1, falcon_mamba, fastspeech2_conformer, flaubert, flava, fnet, focalnet, fsmt, funnel, fuyu, gemma, gemma2, gemma3, gemma3_text, gemma3n, gemma3n_audio, gemma3n_text, gemma3n_vision, git, glm, glm4, glm4v, glm4v_text, glpn, got_ocr2, gpt-sw3, gpt2, gpt_bigcode, gpt_neo, gpt_neox, gpt_neox_japanese, gptj, gptsan-japanese, granite, granite_speech, granitemoe, granitemoehybrid, granitemoeshared, granitevision, graphormer, grounding-dino, groupvit, helium, hgnet_v2, hiera, hubert, ibert, idefics, idefics2, idefics3, idefics3_vision, ijepa, imagegpt, informer, instructblip, instructblipvideo, internvl, internvl_vision, jamba, janus, jetmoe, jukebox, kosmos-2, kyutai_speech_to_text, layoutlm, layoutlmv2, layoutlmv3, led, levit, lightglue, lilt, llama, llama4, llama4_text, llava, llava_next, llava_next_video, llava_onevision, longformer, longt5, luke, lxmert, m2m_100, mamba, mamba2, marian, markuplm, mask2former, maskformer, maskformer-swin, mbart, mctct, mega, megatron-bert, mgp-str, mimi, minimax, mistral, mistral3, mixtral, mlcd, mllama, mobilebert, mobilenet_v1, mobilenet_v2, mobilevit, mobilevitv2, modernbert, moonshine, moshi, mpnet, mpt, mra, mt5, musicgen, musicgen_melody, mvp, nat, nemotron, nezha, nllb-moe, nougat, nystromformer, olmo, olmo2, olmoe, omdet-turbo, oneformer, open-llama, openai-gpt, opt, owlv2, owlvit, paligemma, patchtsmixer, patchtst, pegasus, pegasus_x, perceiver, persimmon, phi, phi3, phi4_multimodal, phimoe, pix2struct, pixtral, plbart, poolformer, pop2piano, prompt_depth_anything, prophetnet, pvt, pvt_v2, qdqbert, qwen2, qwen2_5_omni, qwen2_5_vl, qwen2_5_vl_text, qwen2_audio, qwen2_audio_encoder, qwen2_moe, qwen2_vl, qwen2_vl_text, qwen3, qwen3_moe, rag, realm, recurrent_gemma, reformer, regnet, rembert, resnet, retribert, roberta, roberta-prelayernorm, roc_bert, roformer, rt_detr, rt_detr_resnet, rt_detr_v2, rwkv, sam, sam_hq, sam_hq_vision_model, sam_vision_model, seamless_m4t, seamless_m4t_v2, segformer, seggpt, sew, sew-d, shieldgemma2, siglip, siglip2, siglip_vision_model, smollm3, smolvlm, smolvlm_vision, speech-encoder-decoder, speech_to_text, speech_to_text_2, speecht5, splinter, squeezebert, stablelm, starcoder2, superglue, superpoint, swiftformer, swin, swin2sr, swinv2, switch_transformers, t5, t5gemma, table-transformer, tapas, textnet, time_series_transformer, timesfm, timesformer, timm_backbone, timm_wrapper, trajectory_transformer, transfo-xl, trocr, tvlt, tvp, udop, umt5, unispeech, unispeech-sat, univnet, upernet, van, video_llava, videomae, vilt, vipllava, vision-encoder-decoder, vision-text-dual-encoder, visual_bert, vit, vit_hybrid, vit_mae, vit_msn, vitdet, vitmatte, vitpose, vitpose_backbone, vits, vivit, vjepa2, wav2vec2, wav2vec2-bert, wav2vec2-conformer, wavlm, whisper, xclip, xglm, xlm, xlm-prophetnet, xlm-roberta, xlm-roberta-xl, xlnet, xmod, yolos, yoso, zamba, zamba2, zoedepth
INFO     ml_coder.registry_predictor:registry_predictor.py:156 Loading registry model from data/models/registry_classifier.pkl
INFO     ml_coder.registry_predictor:registry_predictor.py:163 Loaded 21 labels from MLB
INFO     ml_coder.registry_predictor:registry_predictor.py:180 RegistryMLPredictor initialized with 21 labels
INFO     registry_service:registry_service.py:337 Using RegistryMLPredictor (TF-IDF) with 21 labels
WARNING  coder.parallel_pathway:orchestrator.py:430 Path B failed: 'list' object has no attribute 'predictions'
_____ test_self_correction_evidence_must_be_in_focused_text_when_available _____

monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x1d5f60f10>

    def test_self_correction_evidence_must_be_in_focused_text_when_available(
        monkeypatch: pytest.MonkeyPatch,
    ) -> None:
        monkeypatch.setenv("PROCSUITE_PIPELINE_MODE", "extraction_first")
        monkeypatch.setenv("REGISTRY_SELF_CORRECT_ENABLED", "1")
        monkeypatch.setenv("REGISTRY_AUDITOR_SOURCE", "raw_ml")
        monkeypatch.setenv("REGISTRY_EXTRACTION_ENGINE", "agents_focus_then_engine")
    
        _stub_raw_ml_high_conf(monkeypatch, cpt="32550", prob=0.99)
    
        from modules.registry.application import registry_service as registry_service_module
    
        def _focus(note_text: str) -> tuple[str, dict[str, object]]:
            return (
                "PROCEDURE:\nBronchoscopy performed.\nNo IPC placed.\nNo complications.",
                {"status": "ok"},
            )
    
        monkeypatch.setattr(registry_service_module, "focus_note_for_extraction", _focus)
    
        from modules.registry.self_correction.judge import PatchProposal, RegistryCorrectionJudge
    
        mocked = MagicMock(
            return_value=PatchProposal(
                rationale="unsupported evidence quote for focused text",
                json_patch=[{"op": "add", "path": "/pleural_procedures/ipc/performed", "value": True}],
                evidence_quote="PleurX",
            )
        )
        monkeypatch.setattr(RegistryCorrectionJudge, "propose_correction", mocked)
    
        service = RegistryService(hybrid_orchestrator=MagicMock(), registry_engine=_StubRegistryEngine())
        raw_note_text = (
            "HPI:\nPatient has a PleurX catheter in place.\n\n"
            "PROCEDURE:\nBronchoscopy performed.\nNo IPC placed.\nNo complications."
        )
        result = service.extract_fields(raw_note_text)
    
>       mocked.assert_called()

tests/registry/test_self_correction_loop.py:244: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <MagicMock id='7884642000'>

    def assert_called(self):
        """assert that the mock was called at least once
        """
        if self.call_count == 0:
            msg = ("Expected '%s' to have been called." %
                   (self._mock_name or 'mock'))
>           raise AssertionError(msg)
E           AssertionError: Expected 'mock' to have been called.

../../miniconda3/envs/medparse-py311/lib/python3.11/unittest/mock.py:908: AssertionError
----------------------------- Captured stderr call -----------------------------
{"timestamp": "2026-01-18T00:35:59.510393", "level": "WARNING", "logger": "ner.inference", "message": "GranularNERPredictor unavailable: Model directory not found: artifacts/granular_ner_model"}
{"timestamp": "2026-01-18T00:35:59.510478", "level": "INFO", "logger": "coder.parallel_pathway", "message": "ParallelPathwayOrchestrator initialized: NER=unavailable, ML=unavailable"}
------------------------------ Captured log call -------------------------------
WARNING  ner.inference:inference.py:150 GranularNERPredictor unavailable: Model directory not found: artifacts/granular_ner_model
INFO     coder.parallel_pathway:orchestrator.py:157 ParallelPathwayOrchestrator initialized: NER=unavailable, ML=unavailable
=============================== warnings summary ===============================
tests/api/test_fastapi.py::test_coder_run_fixture_response
tests/phi/test_presidio_nlp_backend_smoke.py::test_presidio_scrubber_initializes_with_backend[scispacy-model_candidates1]
  /Users/russellmiller/miniconda3/envs/medparse-py311/lib/python3.11/site-packages/spacy/language.py:2195: FutureWarning: Possible set union at position 6328
    deserializers["tokenizer"] = lambda p: self.tokenizer.from_disk(  # type: ignore[union-attr]

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
=========================== short test summary info ============================
SKIPPED [9] tests/integration/api/test_startup_warmup.py: _do_heavy_warmup was removed; warmup tests need to be updated
SKIPPED [1] tests/integration/persistence/test_supabase_procedure_store.py:99: Supabase tests disabled (set RUN_SUPABASE_TESTS=1 to enable)
SKIPPED [1] tests/integration/persistence/test_supabase_procedure_store.py:107: Supabase tests disabled (set RUN_SUPABASE_TESTS=1 to enable)
SKIPPED [1] tests/integration/persistence/test_supabase_procedure_store.py:111: Supabase tests disabled (set RUN_SUPABASE_TESTS=1 to enable)
SKIPPED [1] tests/integration/persistence/test_supabase_procedure_store.py:127: Supabase tests disabled (set RUN_SUPABASE_TESTS=1 to enable)
SKIPPED [1] tests/integration/persistence/test_supabase_procedure_store.py:162: Supabase tests disabled (set RUN_SUPABASE_TESTS=1 to enable)
SKIPPED [1] tests/integration/persistence/test_supabase_procedure_store.py:185: Supabase tests disabled (set RUN_SUPABASE_TESTS=1 to enable)
SKIPPED [1] tests/integration/persistence/test_supabase_procedure_store.py:216: Supabase tests disabled (set RUN_SUPABASE_TESTS=1 to enable)
SKIPPED [1] tests/integration/persistence/test_supabase_procedure_store.py:244: Supabase tests disabled (set RUN_SUPABASE_TESTS=1 to enable)
SKIPPED [1] tests/integration/persistence/test_supabase_procedure_store.py:258: Supabase tests disabled (set RUN_SUPABASE_TESTS=1 to enable)
SKIPPED [1] tests/integration/persistence/test_supabase_procedure_store.py:298: Supabase tests disabled (set RUN_SUPABASE_TESTS=1 to enable)
SKIPPED [1] tests/integration/persistence/test_supabase_procedure_store.py:335: Supabase tests disabled (set RUN_SUPABASE_TESTS=1 to enable)
SKIPPED [1] tests/integration/persistence/test_supabase_procedure_store.py:363: Supabase tests disabled (set RUN_SUPABASE_TESTS=1 to enable)
SKIPPED [1] tests/integration/persistence/test_supabase_procedure_store.py:390: Supabase tests disabled (set RUN_SUPABASE_TESTS=1 to enable)
FAILED tests/api/test_coding_phi_gating.py::test_coder_run_blocked_when_review_required
FAILED tests/api/test_coding_phi_gating.py::test_coder_run_allowed_when_review_not_required
FAILED tests/api/test_fastapi.py::test_coder_run_fixture_response - assert 41...
FAILED tests/api/test_fastapi.py::test_registry_run_normalizes_stations - ass...
FAILED tests/api/test_fastapi.py::test_shape_registry_payload_prunes_none_and_enriches
FAILED tests/api/test_registry_extract_endpoint.py::TestRegistryExtractEndpoint::test_endpoint_returns_200_with_valid_input
FAILED tests/api/test_registry_extract_endpoint.py::TestRegistryExtractWithMockedService::test_ebus_codes_reflected_in_response
FAILED tests/api/test_registry_extract_endpoint.py::TestRegistryExtractWithMockedService::test_low_conf_triggers_manual_review
FAILED tests/api/test_registry_extract_endpoint.py::TestRegistryExtractWithMockedService::test_response_prunes_nulls_and_adds_formatted_fields
FAILED tests/api/test_registry_extract_endpoint.py::TestRegistryExtractWithMockedService::test_validation_errors_in_response
FAILED tests/api/test_registry_extract_endpoint.py::TestRegistryExtractWithMockedService::test_pleural_codes_mapping
FAILED tests/api/test_registry_extract_endpoint.py::TestRegistryExtractErrorHandling::test_service_exception_returns_500
FAILED tests/api/test_registry_extract_endpoint.py::TestResponseSchemaValidation::test_response_has_all_documented_fields
FAILED tests/api/test_unified_process.py::test_unified_process_already_scrubbed
FAILED tests/integration/api/test_coder_run_endpoint.py::TestCoderRunEndpointBasic::test_coder_run_rules_only_basic
FAILED tests/integration/api/test_coder_run_endpoint.py::TestCoderRunEndpointBasic::test_coder_run_returns_200_for_simple_note
FAILED tests/integration/api/test_coder_run_endpoint.py::TestCoderRunEndpointBasic::test_coder_run_default_locality_and_setting
FAILED tests/integration/api/test_coder_run_endpoint.py::TestCoderRunEndpointBasic::test_coder_run_financials_present
FAILED tests/integration/api/test_coder_run_endpoint.py::TestCoderRunEndpointSmartHybrid::test_coder_run_smart_hybrid_llm_mocked
FAILED tests/integration/api/test_coder_run_endpoint.py::TestCoderRunEndpointSmartHybrid::test_coder_run_llm_agreement_boosts_confidence
FAILED tests/integration/api/test_coder_run_endpoint.py::TestCoderRunEndpointSmartHybrid::test_coder_run_llm_suggestions_in_response
FAILED tests/integration/api/test_coder_run_endpoint.py::TestCoderRunEndpointValidation::test_coder_run_handles_empty_note
FAILED tests/integration/api/test_coder_run_endpoint.py::TestCoderRunEndpointValidation::test_coder_run_accepts_extra_fields
FAILED tests/integration/api/test_coder_run_endpoint.py::TestCoderRunEndpointProvenance::test_coder_run_has_provenance_in_codes
FAILED tests/integration/api/test_coder_run_endpoint.py::TestCoderRunEndpointProvenance::test_coder_run_reasoning_in_rationale
FAILED tests/integration/api/test_coder_run_endpoint.py::TestCoderRunEndpointComplexNotes::test_coder_run_complex_bronchoscopy_note
FAILED tests/integration/api/test_coder_run_endpoint.py::TestCoderRunEndpointComplexNotes::test_coder_run_thoracentesis_note
FAILED tests/integration/api/test_procedure_codes_endpoints.py::TestSuggestCodesEndpoint::test_suggest_codes_happy_path_rules_only
FAILED tests/integration/api/test_procedure_codes_endpoints.py::TestSuggestCodesEndpoint::test_suggest_codes_with_llm_agreement
FAILED tests/integration/api/test_procedure_codes_endpoints.py::TestSuggestCodesEndpoint::test_suggest_codes_llm_addition_verified
FAILED tests/integration/api/test_procedure_codes_endpoints.py::TestGetSuggestionsEndpoint::test_get_suggestions_after_post
FAILED tests/integration/api/test_procedure_codes_endpoints.py::TestReviewEndpoint::test_accept_suggestion
FAILED tests/integration/api/test_procedure_codes_endpoints.py::TestReviewEndpoint::test_reject_suggestion
FAILED tests/integration/api/test_procedure_codes_endpoints.py::TestReviewEndpoint::test_modify_suggestion
FAILED tests/integration/api/test_procedure_codes_endpoints.py::TestFinalCodesEndpoint::test_final_codes_after_accept
FAILED tests/integration/api/test_procedure_codes_endpoints.py::TestMetricsEndpoint::test_metrics_after_workflow
FAILED tests/integration/api/test_procedure_codes_endpoints.py::TestFullWorkflow::test_complete_coding_workflow
FAILED tests/integration/api/test_procedure_codes_endpoints.py::TestFullWorkflow::test_rules_only_mode_works_without_llm
FAILED tests/integration/api/test_registry_endpoints.py::TestRegistryExportFullWorkflow::test_full_workflow_suggest_review_export
FAILED tests/registry/test_audit_compare_report.py::test_audit_compare_report_computes_missing_sets_and_high_conf
FAILED tests/registry/test_audit_compare_report.py::test_audit_compare_report_created_when_auditor_disabled
FAILED tests/registry/test_extraction_first_flow.py::test_extraction_first_does_not_consult_cpt_or_orchestrator
FAILED tests/registry/test_focusing_audit_guardrail.py::test_focusing_can_change_extraction_but_auditor_uses_raw_text_and_report_flags_gap
FAILED tests/registry/test_kitchen_sink_extraction_first.py::test_kitchen_sink_extraction_first_flags
FAILED tests/registry/test_llm_timeout_fallback.py::test_registry_llm_timeout_falls_back_to_engine
FAILED tests/registry/test_registry_service_hybrid_flow.py::TestRegistryServiceHybridFlow::test_ebus_navigation_mapping_and_validation_high_conf
FAILED tests/registry/test_registry_service_hybrid_flow.py::TestRegistryServiceHybridFlow::test_cpt_merge_fills_missing_fields
FAILED tests/registry/test_registry_service_hybrid_flow.py::TestRegistryServiceHybridFlow::test_tblb_mismatch_triggers_validation_error
FAILED tests/registry/test_registry_service_hybrid_flow.py::TestRegistryServiceHybridFlow::test_validation_error_when_cpt_field_not_extractable
FAILED tests/registry/test_registry_service_hybrid_flow.py::TestRegistryServiceHybridFlow::test_low_conf_triggers_manual_review
FAILED tests/registry/test_registry_service_hybrid_flow.py::TestRegistryServiceHybridFlow::test_gray_zone_triggers_manual_review
FAILED tests/registry/test_registry_service_hybrid_flow.py::TestRegistryServiceHybridFlow::test_no_orchestrator_fallback_mode
FAILED tests/registry/test_registry_service_hybrid_flow.py::TestRegistryServiceHybridFlow::test_pleural_procedure_mapping
FAILED tests/registry/test_registry_service_hybrid_flow.py::TestRegistryServiceWithRealEngine::test_real_engine_ebus_extraction
FAILED tests/registry/test_registry_service_hybrid_flow.py::TestMLHybridAudit::test_scenario_c_ml_detected_not_in_cpt_triggers_audit_warning
FAILED tests/registry/test_registry_service_hybrid_flow.py::TestMLHybridAudit::test_scenario_a_cpt_and_ml_match_no_warning
FAILED tests/registry/test_registry_service_hybrid_flow.py::TestMLHybridAudit::test_scenario_b_cpt_positive_ml_negative_no_warning
FAILED tests/registry/test_registry_service_hybrid_flow.py::TestMLHybridAudit::test_multiple_ml_detected_procedures_trigger_multiple_warnings
FAILED tests/registry/test_registry_service_hybrid_flow.py::TestMLHybridAudit::test_audit_warnings_included_in_result_dataclass
FAILED tests/registry/test_self_correction_loop.py::test_self_correction_successful_patch
FAILED tests/registry/test_self_correction_loop.py::test_self_correction_rejects_hallucinated_quote
FAILED tests/registry/test_self_correction_loop.py::test_self_correction_rejects_forbidden_path
FAILED tests/registry/test_self_correction_loop.py::test_self_correction_evidence_must_be_in_focused_text_when_available
63 failed, 1302 passed, 22 skipped, 2 warnings in 21.48s
make: *** [test] Error 1
