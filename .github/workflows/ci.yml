name: CI

on:
  push:
    branches: ["main"]
  pull_request:
  workflow_dispatch:
    inputs:
      run_supabase_tests:
        description: 'Run Supabase integration tests'
        required: false
        default: false
        type: boolean

jobs:
  tests:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.11"]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: pip
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install .[api,dev]
      - name: Ruff
        run: ruff check .
      - name: Mypy
        run: mypy modules
      - name: Pytest
        run: pytest -q

  supabase-integration:
    runs-on: ubuntu-latest
    # Only run when secrets are available AND either:
    # 1. Manually triggered with run_supabase_tests=true, OR
    # 2. Push to main (for validation after merge)
    if: |
      (github.event_name == 'workflow_dispatch' && inputs.run_supabase_tests) ||
      (github.event_name == 'push' && github.ref == 'refs/heads/main' && github.repository_owner == 'rjm')
    needs: tests  # Only run after main tests pass
    strategy:
      matrix:
        python-version: ["3.11"]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: pip
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install .[api,dev]
      - name: Check Supabase secrets
        id: check_secrets
        run: |
          if [ -n "${{ secrets.SUPABASE_URL }}" ] && [ -n "${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" ]; then
            echo "secrets_available=true" >> $GITHUB_OUTPUT
          else
            echo "secrets_available=false" >> $GITHUB_OUTPUT
            echo "::warning::Supabase secrets not configured - skipping integration tests"
          fi
      - name: Supabase Integration Tests
        if: steps.check_secrets.outputs.secrets_available == 'true'
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          RUN_SUPABASE_TESTS: "1"
        run: |
          pytest tests/integration/persistence/test_supabase_procedure_store.py -v
